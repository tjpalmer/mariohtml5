var Mario={};Mario.SpriteCuts={CreateBlackFont:function(){return new Enjine.SpriteFont([],Enjine.Resources.Images.font,8,8,this.GetCharArray(0))},CreateRedFont:function(){return new Enjine.SpriteFont([],Enjine.Resources.Images.font,8,8,this.GetCharArray(8))},CreateGreenFont:function(){return new Enjine.SpriteFont([],Enjine.Resources.Images.font,8,8,this.GetCharArray(16))},CreateBlueFont:function(){return new Enjine.SpriteFont([],Enjine.Resources.Images.font,8,8,this.GetCharArray(24))},CreateYellowFont:function(){return new Enjine.SpriteFont([],Enjine.Resources.Images.font,8,8,this.GetCharArray(32))},CreatePinkFont:function(){return new Enjine.SpriteFont([],Enjine.Resources.Images.font,8,8,this.GetCharArray(40))},CreateCyanFont:function(){return new Enjine.SpriteFont([],Enjine.Resources.Images.font,8,8,this.GetCharArray(48))},CreateWhiteFont:function(){return new Enjine.SpriteFont([],Enjine.Resources.Images.font,8,8,this.GetCharArray(56))},GetCharArray:function(a){var b=[],c=0;for(c=32;127>c;c++)b[c]={X:8*(c-32),Y:a};return b},GetBackgroundSheet:function(){var a=[],b=0,c=0,d=Enjine.Resources.Images.background.width/32,e=Enjine.Resources.Images.background.height/32;for(b=0;d>b;b++)for(a[b]=[],c=0;e>c;c++)a[b][c]={X:32*b,Y:32*c,Width:32,Height:32};return a},GetLevelSheet:function(){var a=[],b=0,c=0,d=Enjine.Resources.Images.map.width/16,e=Enjine.Resources.Images.map.height/16;for(b=0;d>b;b++)for(a[b]=[],c=0;e>c;c++)a[b][c]={X:16*b,Y:16*c,Width:16,Height:16};return a}},Mario.Tile={BlockUpper:1,BlockAll:2,BlockLower:4,Special:8,Bumpable:16,Breakable:32,PickUpable:64,Animated:128,Behaviors:[],LoadBehaviors:function(){var a=[];a[0]=0,a[1]=20,a[2]=28,a[3]=0,a[4]=130,a[5]=130,a[6]=130,a[7]=130,a[8]=2,a[9]=2,a[10]=2,a[11]=2,a[12]=2,a[13]=0,a[14]=138,a[15]=0,a[16]=162,a[17]=146,a[18]=154,a[19]=162,a[20]=146,a[21]=146,a[22]=154,a[23]=146,a[24]=2,a[25]=0,a[26]=2,a[27]=2,a[28]=2,a[29]=0,a[30]=2,a[31]=0,a[32]=192,a[33]=192,a[34]=192,a[35]=192,a[36]=0,a[37]=0,a[38]=0,a[39]=0,a[40]=2,a[41]=2,a[42]=0,a[43]=0,a[44]=0,a[45]=0,a[46]=2,a[47]=0,a[48]=0,a[49]=0,a[50]=0,a[51]=0,a[52]=0,a[53]=0,a[54]=0,a[55]=0,a[56]=2,a[57]=2;var b=0;for(b=58;128>b;b++)a[b]=0;for(a[128]=2,a[129]=2,a[130]=2,a[131]=0,a[132]=1,a[133]=1,a[134]=1,a[135]=0,a[136]=2,a[137]=2,a[138]=2,a[139]=0,a[140]=2,a[141]=2,a[142]=2,a[143]=0,a[144]=2,a[145]=0,a[146]=2,a[147]=0,a[148]=0,a[149]=0,a[150]=0,a[151]=0,a[152]=2,a[153]=2,a[154]=2,a[155]=0,a[156]=2,a[157]=2,a[158]=2,a[159]=0,a[160]=2,a[161]=2,a[162]=2,a[163]=0,a[164]=0,a[165]=0,a[166]=0,a[167]=0,a[168]=2,a[169]=2,a[170]=2,a[171]=0,a[172]=2,a[173]=2,a[174]=2,a[175]=0,a[176]=2,a[177]=2,a[178]=2,a[179]=0,a[180]=1,a[181]=1,a[182]=1,b=183;224>b;b++)a[b]=0;for(a[224]=1,a[225]=1,a[226]=1,b=227;256>b;b++)a[b]=0;this.Behaviors=a}},Mario.LevelType={Overground:0,Underground:1,Castle:2},Mario.Odds={Straight:0,HillStraight:1,Tubes:2,Jump:3,Cannons:4},Mario.Level=function(a,b){this.Width=a,this.Height=b,this.ExitX=10,this.ExitY=10,this.Map=[],this.Data=[],this.SpriteTemplates=[];var c=0,d=0;for(c=0;c<this.Width;c++)for(this.Map[c]=[],this.Data[c]=[],this.SpriteTemplates[c]=[],d=0;d<this.Height;d++)this.Map[c][d]=0,this.Data[c][d]=0,this.SpriteTemplates[c][d]=null},Mario.Level.prototype={Update:function(){var a=0,b=0;for(a=0;a<this.Width;a++)for(b=0;b<this.Height;b++)this.Data[a][b]>0&&this.Data[a][b]--},GetBlockCapped:function(a,b){return 0>a&&(a=0),0>b&&(b=0),a>=this.Width&&(a=this.Width-1),b>=this.Height&&(b=this.Height-1),this.Map[a][b]},GetBlock:function(a,b){return 0>a&&(a=0),0>b?0:(a>=this.Width&&(a=this.Width-1),b>=this.Height&&(b=this.Height-1),this.Map[a][b])},SetBlock:function(a,b,c){0>a||0>b||a>=this.Width||b>=this.Height||(this.Map[a][b]=c)},SetBlockData:function(a,b,c){0>a||0>b||a>=this.Width||b>=this.Height||(this.Data[a][b]=c)},IsBlocking:function(a,b,c,d){var e=this.GetBlock(a,b),f=(Mario.Tile.Behaviors[255&e]&Mario.Tile.BlockAll)>0;return f|=d>0&&(Mario.Tile.Behaviors[255&e]&Mario.Tile.BlockUpper)>0,f|=0>d&&(Mario.Tile.Behaviors[255&e]&Mario.Tile.BlockLower)>0},GetSpriteTemplate:function(a,b){return 0>a?null:0>b?null:a>=this.Width?null:b>=this.Height?null:this.SpriteTemplates[a][b]},SetSpriteTemplate:function(a,b,c){0>a||0>b||a>=this.Width||b>=this.Height||(this.SpriteTemplates[a][b]=c)}},Mario.BackgroundGenerator=function(a,b,c,d){this.Width=a,this.Height=b,this.Distant=c,this.Type=d},Mario.BackgroundGenerator.prototype={SetValues:function(a,b,c,d){this.Width=a,this.Height=b,this.Distant=c,this.Type=d},CreateLevel:function(){var a=new Mario.Level(this.Width,this.Height);switch(this.Type){case Mario.LevelType.Overground:this.GenerateOverground(a);break;case Mario.LevelType.Underground:this.GenerateUnderground(a);break;case Mario.LevelType.Castle:this.GenerateCastle(a)}return a},GenerateOverground:function(a){var b=this.Distant?4:6,c=this.Distant?2:1,d=Math.floor(Math.random()*b)+c,e=Math.floor(Math.random()*b)+c,f=0,g=0,h=0,i=0,j=2;for(f=0;f<this.Width;f++){for(d=e;d===e;)e=Math.floor(Math.random()*b)+c;for(g=0;g<this.Height;g++)h=e>d?d:e,i=e>d?e:d,j=2,h>g?this.Distant?(j=2,2>g&&(j=g),a.SetBlock(f,g,4+8*j)):a.SetBlock(f,g,5):g===h?(j=h===e?0:1,j+=this.Distant?2:0,a.SetBlock(f,g,j)):g===i?(j=h===e?0:1,j+=this.Distant?2:0,a.SetBlock(f,g,j+16)):(j=g>i?1:0,h===d&&(j=1-j),j+=this.Distant?2:0,a.SetBlock(f,g,j+8))}},GenerateUnderground:function(a){var b=0,c=0,d=0,e=0;if(this.Distant){var f=0;for(b=0;b<this.Width;b++)for(Math.random()<.75&&(f=1-f),c=0;c<this.Height;c++)d=f,e=c-2,(0>e||e>4)&&(e=2,d=0),a.SetBlock(b,c,4+d+8*(3+e))}else for(b=0;b<this.Width;b++)for(c=0;c<this.Height;c++)d=b%2,e=c-1,(0>e||e>7)&&(e=7,d=0),0===d&&e>1&&5>e&&(d=-1,e=0),a.SetBlock(b,c,6+d+8*e)},GenerateCastle:function(a){var b=0,c=0,d=0,e=0;if(this.Distant)for(b=0;b<this.Width;b++)for(c=0;c<this.Height;c++)d=b%2,e=c-1,e>2&&5>e?e=2:e>=5&&(e-=2),0>e?(d=0,e=5):e>4?(d=1,e=5):1>d&&3===e?(d=0,e=3):1>d&&e>0&&3>e&&(d=0,e=2),a.SetBlock(b,c,1+d+8*(e+4));else for(b=0;b<this.Width;b++)for(c=0;c<this.Height;c++)d=b%3,e=c-1,e>2&&5>e?e=2:e>=5&&(e-=2),0>e?(d=1,e=5):e>4?(d=2,e=5):2>d&&4===e?(d=2,e=4):2>d&&e>0&&4>e&&(d=4,e=-3),a.SetBlock(b,c,1+d+8*(e+3))}},Mario.BackgroundRenderer=function(a,b,c,d){this.Level=a,this.Width=b,this.Distance=d,this.TilesY=(0|c/32)+1,this.Background=Mario.SpriteCuts.GetBackgroundSheet()},Mario.BackgroundRenderer.prototype=new Enjine.Drawable,Mario.BackgroundRenderer.prototype.Draw=function(a,b){var c=b.X/this.Distance,d=0,e=0,f=null,g=null,h=0|c/32,i=0|(c+this.Width)/32;for(d=h;i>=d;d++)for(e=0;e<this.TilesY;e++)f=255&this.Level.GetBlock(d,e),g=this.Background[f%8][0|f/8],a.drawImage(Enjine.Resources.Images.background,g.X,g.Y,g.Width,g.Height,0|(d<<5)-c,0|e<<5,g.Width,g.Height)},Mario.ImprovedNoise=function(a){this.P=[],this.Shuffle(a)},Mario.ImprovedNoise.prototype={Shuffle:function(){var a=[],b=0,c=0,d=0;for(b=0;256>b;b++)a[b]=b;for(b=0;256>b;b++)c=(0|255*Math.random())+b,d=a[b],a[b]=a[c],a[c]=d,this.P[b+256]=this.P[b]=a[b]},PerlinNoise:function(a,b){var c=0,d=0,e=0;for(c=0;8>c;c++)e=64/(1<<c),d+=this.Noise(a/e,b/e,128)/(1<<c);return d},Noise:function(a,b,c){var d=255&(0|a),e=255&(0|b),f=255&(0|c);a-=0|a,b-=0|b,c-=0|c;var g=this.Fade(a),h=this.Fade(b),i=this.Fade(c),j=this.P[d]+e,k=this.P[j]+f,l=this.P[j+1]+f,m=this.P[d+1]+e,n=this.P[m]+f,o=this.P[m+1]+f;return this.Lerp(i,this.Lerp(h,this.Lerp(g,this.Grad(this.P[k],a,b,c),this.Grad(this.P[n],a-1,b,c)),this.Lerp(g,this.Grad(this.P[l],a,b-1,c),this.Grad(this.P[o],a-1,b-1,c))),this.Lerp(h,this.Lerp(g,this.Grad(this.P[k+1],a,b,c-1),this.Grad(this.P[n+1],a-1,b,c-1)),this.Lerp(g,this.Grad(this.P[l+1],a,b-1,c-1),this.Grad(this.P[o+1],a-1,b-1,c-1))))},Fade:function(a){return a*a*a*(a*(6*a-15)+10)},Lerp:function(a,b,c){return b+a*(c-b)},Grad:function(a,b,c,d){var e=15&a,f=8>e?b:c,g=4>e?c:12===e||14===e?b:d;return(0===(1&e)?f:-f)+(0===(2&e)?g:-g)}},Mario.NotchSprite=function(a){this.XOld=0,this.YOld=0,this.X=0,this.Y=0,this.Xa=0,this.Ya=0,this.XPic=0,this.YPic=0,this.XPicO=0,this.YPicO=0,this.PicWidth=32,this.PicHeight=32,this.XFlip=!1,this.YFlip=!1,this.Visible=!0,this.Image=a,this.Delta=0,this.SpriteTemplate=null,this.Layer=1},Mario.NotchSprite.prototype=new Enjine.Drawable,Mario.NotchSprite.prototype.Draw=function(a){var b=0,c=0;this.Visible&&(b=(0|this.XOld+(this.X-this.XOld)*this.Delta)-this.XPicO,c=(0|this.YOld+(this.Y-this.YOld)*this.Delta)-this.YPicO,a.save(),a.scale(this.XFlip?-1:1,this.YFlip?-1:1),a.translate(this.XFlip?-320:0,this.YFlip?-240:0),a.drawImage(this.Image,this.XPic*this.PicWidth,this.YPic*this.PicHeight,this.PicWidth,this.PicHeight,this.XFlip?320-b-this.PicWidth:b,this.YFlip?240-c-this.PicHeight:c,this.PicWidth,this.PicHeight),a.restore())},Mario.NotchSprite.prototype.Update=function(a){this.XOld=this.X,this.YOld=this.Y,this.Move(),this.Delta=a},Mario.NotchSprite.prototype.UpdateNoMove=function(){this.XOld=this.X,this.YOld=this.Y,this.Delta=0},Mario.NotchSprite.prototype.Move=function(){this.X+=this.Xa,this.Y+=this.Ya},Mario.NotchSprite.prototype.GetX=function(a){return(0|this.XOld+(this.X-this.XOld)*a)-this.XPicO},Mario.NotchSprite.prototype.GetY=function(a){return(0|this.YOld+(this.Y-this.YOld)*a)-this.YPicO},Mario.NotchSprite.prototype.CollideCheck=function(){},Mario.NotchSprite.prototype.BumpCheck=function(){},Mario.NotchSprite.prototype.Release=function(){},Mario.NotchSprite.prototype.ShellCollideCheck=function(){return!1},Mario.NotchSprite.prototype.FireballCollideCheck=function(){return!1},Mario.Character=function(){this.Large=!1,this.Fire=!1,this.Coins=0,this.Lives=3,this.LevelString="none",this.GroundInertia=.89,this.AirInertia=.89,this.RunTime=0,this.WasOnGround=!1,this.OnGround=!1,this.MayJump=!1,this.Ducking=!1,this.Sliding=!1,this.JumpTime=0,this.XJumpSpeed=0,this.YJumpSpeed=0,this.CanShoot=!1,this.Width=4,this.Height=24,this.World=null,this.Facing=0,this.PowerUpTime=0,this.XDeathPos=0,this.YDeathPos=0,this.DeathTime=0,this.WinTime=0,this.InvulnerableTime=0,this.Carried=null,this.LastLarge=!1,this.LastFire=!1,this.NewLarge=!1,this.NewFire=!1},Mario.Character.prototype=new Mario.NotchSprite(null),Mario.Character.prototype.Initialize=function(a){this.World=a,this.X=32,this.Y=0,this.PowerUpTime=0,this.RunTime=0,this.WasOnGround=!1,this.OnGround=!1,this.MayJump=!1,this.Ducking=!1,this.Sliding=!1,this.JumpTime=0,this.XJumpSpeed=0,this.YJumpSpeed=0,this.CanShoot=!1,this.Width=4,this.Height=24,this.World=a,this.Facing=0,this.PowerUpTime=0,this.XDeathPos=0,this.YDeathPos=0,this.DeathTime=0,this.WinTime=0,this.InvulnerableTime=0,this.Carried=null,this.SetLarge(this.Large,this.Fire)},Mario.Character.prototype.SetLarge=function(a,b){b&&(a=!0),a||(b=!1),this.LastLarge=this.Large,this.LastFire=this.Fire,this.Large=a,this.Fire=b,this.NewLarge=this.Large,this.NewFire=this.Fire,this.Blink(!0)},Mario.Character.prototype.Blink=function(a){this.Large=a?this.NewLarge:this.LastLarge,this.Fire=a?this.NewFire:this.LastFire,this.Large?(this.Image=this.Fire?Enjine.Resources.Images.fireMario:Enjine.Resources.Images.mario,this.XPicO=16,this.YPicO=31,this.PicWidth=this.PicHeight=32):(this.Image=Enjine.Resources.Images.smallMario,this.XPicO=8,this.YPicO=15,this.PicWidth=this.PicHeight=16)},Mario.Character.prototype.Move=function(){if(this.WinTime>0)return this.WinTime++,this.Xa=0,this.Ya=0,void 0;if(this.DeathTime>0)return this.DeathTime++,this.DeathTime<11?(this.Xa=0,this.Ya=0):11===this.DeathTime?this.Ya=-15:this.Ya+=2,this.X+=this.Xa,this.Y+=this.Ya,void 0;if(0!==this.PowerUpTime)return this.PowerUpTime>0?(this.PowerUpTime--,this.Blink(0===(1&(0|this.PowerUpTime/3)))):(this.PowerUpTime++,this.Blink(0===(1&(0|-this.PowerUpTime/3)))),0===this.PowerUpTime&&(this.World.Paused=!1),this.CalcPic(),void 0;this.InvulnerableTime>0&&this.InvulnerableTime--,this.Visible=0===(1&(0|this.InvulerableTime/2)),this.WasOnGround=this.OnGround;var a=Enjine.KeyboardInput.IsKeyDown(Enjine.Keys.A)?1.2:.6;this.OnGround&&(this.Ducking=Enjine.KeyboardInput.IsKeyDown(Enjine.Keys.Down)&&this.Large?!0:!1),this.Xa>2&&(this.Facing=1),this.Xa<-2&&(this.Facing=-1),Enjine.KeyboardInput.IsKeyDown(Enjine.Keys.S)||this.JumpTime<0&&!this.OnGround&&!this.Sliding?this.JumpTime<0?(this.Xa=this.XJumpSpeed,this.Ya=-this.JumpTime*this.YJumpSpeed,this.JumpTime++):this.OnGround&&this.MayJump?(Enjine.Resources.PlaySound("jump"),this.XJumpSpeed=0,this.YJumpSpeed=-1.9,this.JumpTime=7,this.Ya=this.JumpTime*this.YJumpSpeed,this.OnGround=!1,this.Sliding=!1):this.Sliding&&this.MayJump?(Enjine.Resources.PlaySound("jump"),this.XJumpSpeed=6*-this.Facing,this.YJumpSpeed=-2,this.JumpTime=-6,this.Xa=this.XJumpSpeed,this.Ya=-this.JumpTime*this.YJumpSpeed,this.OnGround=!1,this.Sliding=!1,this.Facing=-this.Facing):this.JumpTime>0&&(this.Xa+=this.XJumpSpeed,this.Ya=this.JumpTime*this.YJumpSpeed,this.JumpTime--):this.JumpTime=0,Enjine.KeyboardInput.IsKeyDown(Enjine.Keys.Left)&&!this.Ducking&&(1===this.Facing&&(this.Sliding=!1),this.Xa-=a,this.JumpTime>=0&&(this.Facing=-1)),Enjine.KeyboardInput.IsKeyDown(Enjine.Keys.Right)&&!this.Ducking&&(-1===this.Facing&&(this.Sliding=!1),this.Xa+=a,this.JumpTime>=0&&(this.Facing=1)),(!Enjine.KeyboardInput.IsKeyDown(Enjine.Keys.Left)&&!Enjine.KeyboardInput.IsKeyDown(Enjine.Keys.Right)||this.Ducking||this.Ya<0||this.OnGround)&&(this.Sliding=!1),Enjine.KeyboardInput.IsKeyDown(Enjine.Keys.A)&&this.CanShoot&&this.Fire&&this.World.FireballsOnScreen<2&&(Enjine.Resources.PlaySound("fireball"),this.World.AddSprite(new Mario.Fireball(this.World,this.X+6*this.Facing,this.Y-20,this.Facing))),this.CanShoot=!Enjine.KeyboardInput.IsKeyDown(Enjine.Keys.A),this.MayJump=(this.OnGround||this.Sliding)&&!Enjine.KeyboardInput.IsKeyDown(Enjine.Keys.S),this.XFlip=-1===this.Facing,this.RunTime+=Math.abs(this.Xa)+5,Math.abs(this.Xa)<.5&&(this.RunTime=0,this.Xa=0),this.CalcPic(),this.Sliding&&(this.World.AddSprite(new Mario.Sparkle(this.World,(0|this.X+4*Math.random()-2)+8*this.Facing,(0|this.Y+4*Math.random())-24,2*Math.random()-1,Math.random(),0,1,5)),this.Ya*=.5),this.OnGround=!1,this.SubMove(this.Xa,0),this.SubMove(0,this.Ya),this.Y>16*this.World.Level.Height+16&&this.Die(),this.X<0&&(this.X=0,this.Xa=0),this.X>16*this.World.Level.ExitX&&this.Win(),this.X>16*this.World.Level.Width&&(this.X=16*this.World.Level.Width,this.Xa=0),this.Ya*=.85,this.Xa*=this.OnGround?this.GroundInertia:this.AirInertia,this.OnGround||(this.Ya+=3),null!==this.Carried&&(this.Carried.X*=this.X+8*this.Facing,this.Carried.Y*=this.Y-2,Enjine.KeyboardInput.IsKeyDown(Enjine.Keys.A)||(this.Carried.Release(this),this.Carried=null))},Mario.Character.prototype.CalcPic=function(){var a=0,b=0;if(this.Large?(a=(0|this.RunTime/20)%4,3===a&&(a=1),null===this.Carried&&Math.abs(this.Xa)>10&&(a+=3),null!==this.Carried&&(a+=10),this.OnGround||(a=null!==this.Carried?12:Math.abs(this.Xa)>10?7:6)):(a=(0|this.RunTime/20)%2,null===this.Carried&&Math.abs(this.Xa)>10&&(a+=2),null!==this.Carried&&(a+=8),this.OnGround||(a=null!==this.Carried?9:Math.abs(this.Xa)>10?5:4)),this.OnGround&&(-1===this.Facing&&this.Xa>0||1===this.Facing&&this.Xa<0)&&((this.Xa>1||this.Xa<-1)&&(a=this.Large?9:7),this.Xa>3||this.Xa<-3))for(b=0;3>b;b++)this.World.AddSprite(new Mario.Sparkle(this.World,0|this.X+8*Math.random()-4,0|this.Y+4*Math.random(),2*Math.random()-1,-1*Math.random(),0,1,5));this.Large?(this.Ducking&&(a=14),this.Height=this.Ducking?12:24):this.Height=12,this.XPic=a},Mario.Character.prototype.SubMove=function(a,b){for(var c=!1;a>8;){if(!this.SubMove(8,0))return!1;a-=8}for(;-8>a;){if(!this.SubMove(-8,0))return!1;a+=8}for(;b>8;){if(!this.SubMove(0,8))return!1;b-=8}for(;-8>b;){if(!this.SubMove(0,-8))return!1;b+=8}return b>0&&(this.IsBlocking(this.X+a-this.Width,this.Y+b,a,0)?c=!0:this.IsBlocking(this.X+a+this.Width,this.Y+b,a,0)?c=!0:this.IsBlocking(this.X+a-this.Width,this.Y+b+1,a,b)?c=!0:this.IsBlocking(this.X+a+this.Width,this.Y+b+1,a,b)&&(c=!0)),0>b&&(this.IsBlocking(this.X+a,this.Y+b-this.Height,a,b)?c=!0:c||this.IsBlocking(this.X+a-this.Width,this.Y+b-this.Height,a,b)?c=!0:(c||this.IsBlocking(this.X+a+this.Width,this.Y+b-this.Height,a,b))&&(c=!0)),a>0&&(this.Sliding=!0,this.IsBlocking(this.X+a+this.Width,this.Y+b-this.Height,a,b)?c=!0:this.Sliding=!1,this.IsBlocking(this.X+a+this.Width,this.Y+b-(0|this.Height/2),a,b)?c=!0:this.Sliding=!1,this.IsBlocking(this.X+a+this.Width,this.Y+b,a,b)?c=!0:this.Sliding=!1),0>a&&(this.Sliding=!0,this.IsBlocking(this.X+a-this.Width,this.Y+b-this.Height,a,b)?c=!0:this.Sliding=!1,this.IsBlocking(this.X+a-this.Width,this.Y+b-(0|this.Height/2),a,b)?c=!0:this.Sliding=!1,this.IsBlocking(this.X+a-this.Width,this.Y+b,a,b)?c=!0:this.Sliding=!1),c?(0>a&&(this.X=16*(0|(this.X-this.Width)/16)+this.Width,this.Xa=0),a>0&&(this.X=16*(0|(this.X+this.Width)/16+1)-this.Width-1,this.Xa=0),0>b&&(this.Y=16*(0|(this.Y-this.Height)/16)+this.Height,this.JumpTime=0,this.Ya=0),b>0&&(this.Y=16*(0|(this.Y-1)/16+1)-1,this.OnGround=!0),!1):(this.X+=a,this.Y+=b,!0)},Mario.Character.prototype.IsBlocking=function(a,b,c,d){var e=!1,f=0,g=0,h=0;if(a=0|a/16,b=0|b/16,a===(0|this.X/16)&&b===(0|this.Y/16))return!1;if(f=this.World.Level.GetBlock(a,b),(Mario.Tile.Behaviors[255&f]&Mario.Tile.PickUpable)>0)for(this.GetCoin(),Enjine.Resources.PlaySound("coin"),this.World.Level.SetBlock(a,b,0),g=0;2>g;g++)for(h=0;2>h;h++)this.World.AddSprite(new Mario.Sparkle(this.World,16*a+8*g+(0|8*Math.random()),16*b+8*h+(0|8*Math.random()),0,0,0,2,5));return e=this.World.Level.IsBlocking(a,b,c,d),e&&0>d&&this.World.Bump(a,b,this.Large),e},Mario.Character.prototype.Stomp=function(a){var b=0;this.DeathTime>0||this.World.Paused||(b=a.Y-a.Height/2,this.SubMove(0,b-this.Y),a instanceof Mario.Enemy||a instanceof Mario.BulletBill?(Enjine.Resources.PlaySound("kick"),this.XJumpSpeed=0,this.YJumpSpeed=-1.9,this.JumpTime=8,this.Ya=this.JumpTime*this.YJumpSpeed,this.OnGround=!1,this.Sliding=!1,this.InvulnerableTime=1):a instanceof Mario.Shell&&(Enjine.KeyboardInput.IsKeyDown(Enjine.Keys.A)&&0===a.Facing?(this.Carried=a,a.Carried=!0):(Enjine.Resources.PlaySound("kick"),this.XJumpSpeed=0,this.YJumpSpeed=-1.9,this.JumpTime=8,this.Ya=this.JumpTime*this.YJumpSpeed,this.OnGround=!1,this.Sliding=!1,this.InvulnerableTime=1)))},Mario.Character.prototype.GetHurt=function(){this.DeathTime>0||this.World.Paused||this.InvulnerableTime>0||(this.Large?(this.World.Paused=!0,this.PowerUpTime=-18,Enjine.Resources.PlaySound("powerdown"),this.Fire?this.SetLarge(!0,!1):this.SetLarge(!1,!1),this.InvulnerableTime=32):this.Die())},Mario.Character.prototype.Win=function(){this.XDeathPos=0|this.X,this.YDeathPos=0|this.Y,this.World.Paused=!0,this.WinTime=1,Enjine.Resources.PlaySound("exit")},Mario.Character.prototype.Die=function(){this.XDeathPos=0|this.X,this.YDeathPos=0|this.Y,this.World.Paused=!0,this.DeathTime=1,Enjine.Resources.PlaySound("death"),this.SetLarge(!1,!1)},Mario.Character.prototype.GetFlower=function(){this.DeathTime>0&&this.World.Paused||(this.Fire?(this.GetCoin(),Enjine.Resources.PlaySound("coin")):(this.World.Paused=!0,this.PowerUpTime=18,Enjine.Resources.PlaySound("powerup"),this.SetLarge(!0,!0)))},Mario.Character.prototype.GetMushroom=function(){this.DeathTime>0&&this.World.Paused||(this.Large?(this.GetCoin(),Enjine.Resources.PlaySound("coin")):(this.World.Paused=!0,this.PowerUpTime=18,Enjine.Resources.PlaySound("powerup"),this.SetLarge(!0,!1)))},Mario.Character.prototype.Kick=function(a){this.DeathTime>0&&this.World.Paused||(Enjine.KeyboardInput.IsKeyDown(Enjine.Keys.A)?(this.Carried=a,a.Carried=!0):(Enjine.Resources.PlaySound("kick"),this.InvulnerableTime=1))},Mario.Character.prototype.Get1Up=function(){Enjine.Resources.PlaySound("1up"),this.Lives++,99===this.Lives&&(this.Lives=99)},Mario.Character.prototype.GetCoin=function(){this.Coins++,100===this.Coins&&(this.Coins=0,this.Get1Up())},Mario.LevelRenderer=function(a,b,c){this.Width=b,this.Height=c,this.Level=a,this.TilesY=(0|c/16)+1,this.Delta=0,this.Tick=0,this.Bounce=0,this.AnimTime=0,this.Background=Mario.SpriteCuts.GetLevelSheet()},Mario.LevelRenderer.prototype=new Enjine.Drawable,Mario.LevelRenderer.prototype.Update=function(a){this.AnimTime+=a,this.Tick=0|this.AnimTime,this.Bounce+=30*a,this.Delta=a},Mario.LevelRenderer.prototype.Draw=function(a,b){this.DrawStatic(a,b),this.DrawDynamic(a,b)},Mario.LevelRenderer.prototype.DrawStatic=function(a,b){var c=0,d=0,e=0,f=null,g=0|b.X/16,h=0|(b.X+this.Width)/16;for(c=g;h+1>c;c++)for(d=0;d<this.TilesY;d++)e=255&this.Level.GetBlock(c,d),0===(Mario.Tile.Behaviors[e]&Mario.Tile.Animated)&&(f=this.Background[e%16][0|e/16],a.drawImage(Enjine.Resources.Images.map,f.X,f.Y,f.Width,f.Height,0|(c<<4)-b.X,0|d<<4,f.Width,f.Height))},Mario.LevelRenderer.prototype.DrawDynamic=function(a,b){var c=0,d=0,e=0,f=0,g=0,h=null;for(c=0|b.X/16;0|c<=(b.X+this.Width)/16;c++)for(d=0|b.Y/16;0|d<=(b.Y+this.Height)/16;d++)e=this.Level.GetBlock(c,d),(Mario.Tile.Behaviors[255&e]&Mario.Tile.Animated)>0&&(f=(0|this.Bounce/3)%4,0===(0|e%16/4)&&1===(0|e/16)&&(f=(0|this.Bounce/2+(c+d)/8)%20,f>3&&(f=0)),3===(0|e%16/4)&&0===(0|e/16)&&(f=2),g=0,c>=0&&d>=0&&c<this.Level.Width&&d<this.Level.Height&&(g=this.Level.Data[c][d]),g>0&&(g=0|8*Math.sin((g-this.Delta)/4*Math.PI)),h=this.Background[4*(0|e%16/4)+f][0|e/16],a.drawImage(Enjine.Resources.Images.map,h.X,h.Y,h.Width,h.Height,(c<<4)-b.X,(d<<4)-b.Y-g,h.Width,h.Height))},Mario.LevelRenderer.prototype.DrawExit0=function(a,b,c){var d=0,e=0,f=null;for(d=this.Level.ExitY-8;d<this.Level.ExitY;d++)f=this.Background[12][d===this.Level.ExitY-8?4:5],a.drawImage(Enjine.Resources.Images.map,f.X,f.Y,f.Width,f.Height,(this.Level.ExitX<<4)-b.X-16,(d<<4)-b.Y,f.Width,f.Height);c&&(e=16*this.Level.ExitY-48-16*3*Math.sin(this.AnimTime)-8,f=this.Background[12][3],a.drawImage(Enjine.Resources.Images.map,f.X,f.Y,f.Width,f.Height,(this.Level.ExitX<<4)-b.X-16,e-b.Y,f.Width,f.Height),f=this.Background[13][3],a.drawImage(Enjine.Resources.Images.map,f.X,f.Y,f.Width,f.Height,(this.Level.ExitX<<4)-b.X,e-b.Y,f.Width,f.Height))},Mario.LevelRenderer.prototype.DrawExit1=function(a,b){var c=0,d=null;for(c=this.Level.ExitY-8;c<this.Level.ExitY;c++)d=this.Background[13][c===this.Level.ExitY-8?4:5],a.drawImage(Enjine.Resources.Images.map,d.X,d.Y,d.Width,d.Height,(this.Level.ExitX<<4)-b.X+16,(c<<4)-b.Y,d.Width,d.Height)},Mario.LevelGenerator=function(a,b){this.Width=a,this.Height=b,this.Odds=[],this.TotalOdds=0,this.Difficulty=0,this.Type=0},Mario.LevelGenerator.prototype={CreateLevel:function(a,b){var c=0,d=0,e=0,f=0,g=0,h=0,i=0,j=null;for(this.Type=a,this.Difficulty=b,this.Odds[Mario.Odds.Straight]=20,this.Odds[Mario.Odds.HillStraight]=10,this.Odds[Mario.Odds.Tubes]=2+b,this.Odds[Mario.Odds.Jump]=2*b,this.Odds[Mario.Odds.Cannon]=-10+5*b,this.Type!==Mario.LevelType.Overground&&(this.Odds[Mario.Odds.HillStraight]=0),c=0;c<this.Odds.length;c++)this.Odds[c]<0&&(this.Odds[c]=0),this.TotalOdds+=this.Odds[c],this.Odds[c]=this.TotalOdds-this.Odds[c];for(j=new Mario.Level(this.Width,this.Height),d+=this.BuildStraight(j,0,j.Width,!0);d<j.Width-64;)d+=this.BuildZone(j,d,j.Width-d);for(e=0|this.Height-1-4*Math.random(),j.ExitX=d+8,j.ExitY=e,f=d;f<j.Width;f++)for(g=0;g<this.Height;g++)g>=e&&j.SetBlock(f,g,145);if(a===Mario.LevelType.Castle||a===Mario.LevelType.Underground)for(f=0;f<j.Width;f++)for(i--<=0&&f>4&&(h=0|4*Math.random(),i=(0|4*Math.random())+4),g=0;g<j.Height;g++)(f>4&&h>=g||1>f)&&j.SetBlock(f,g,145);return this.FixWalls(j),j},BuildZone:function(a,b,c){var d=0|Math.random()*this.TotalOdds,e=0,f=0;for(f=0;f<this.Odds.length;f++)this.Odds[f]<=d&&(e=f);switch(e){case Mario.Odds.Straight:return this.BuildStraight(a,b,c,!1);case Mario.Odds.HillStraight:return this.BuildHillStraight(a,b,c);case Mario.Odds.Tubes:return this.BuildTubes(a,b,c);case Mario.Odds.Jump:return this.BuildJump(a,b,c);case Mario.Odds.Cannons:return this.BuildCannons(a,b,c)}return 0},BuildJump:function(a,b){var c=(0|4*Math.random())+2,d=(0|2*Math.random())+2,e=2*c+d,f=0,g=0,h=0===(0|3*Math.random()),i=this.Height-1-(0|4*Math.random());for(f=b;b+e>f;f++)if(b+c>f||f>b+e-c-1)for(g=0;g<this.Height;g++)g>=i?a.SetBlock(f,g,145):h&&(b+c>f?g>=i-(f-b)+1&&a.SetBlock(f,g,9):g>=i-(b+e-f)+2&&a.SetBlock(f,g,9));return e},BuildCannons:function(a,b,c){alert("cannons");var d=(0|10*Math.random())+2,e=0|this.Height-1-4*Math.random(),f=0|b+1+4*Math.random(),g=0,h=0,i=0;for(d>c&&(d=c),g=b;b+d>g;g++)for(g>f&&(f+=0|2*4*Math.random()),f===b+d-1&&(f+=10),i=e-(0|4*Math.random())-1,h=0;h<this.Height;h++)h>=e?a.SetBlock(g,h,145):g===f&&h>=i&&(h===i?a.SetBlock(g,h,14):h===i+1?a.SetBlock(g,h,30):a.SetBlock(g,h,46));return d},BuildHillStraight:function(a,b,c){var d=(0|10*Math.random())+10,e=0|this.Height-1-4*Math.random(),f=0,g=0,h=e,i=!0,j=0,k=0,l=[],m=0,n=0;for(d>c&&(d=c),f=b;b+d>f;f++)for(g=0;g<this.Height;g++)g>=e&&a.SetBlock(f,g,145);for(this.AddEnemyLine(a,b+1,b+d-1,e-1);i;)if(h=0|h-2-3*Math.random(),0>=h)i=!1;else if(j=(0|5*Math.random())+3,k=(0|Math.random()*(d-j-2))+b+1,l[k-b]||l[k-b+j]||l[k-b-1]||l[k-b+j+1])i=!1;else for(l[k-b]=!0,l[k-b+j]=!0,this.AddEnemyLine(a,k,k+j,h-1),0===(0|4*Math.random())&&(this.Decorate(a,k-1,k+j+1,h),i=!1),f=k;k+j>f;f++)for(g=h;e>g;g++)m=5,n=9,f===k&&(m=4),f===k+j-1&&(m=6),g===h&&(n=8),0===a.GetBlock(f,g)?a.SetBlock(f,g,m+16*n):(132===a.GetBlock(f,g)&&a.SetBlock(f,g,180),134===a.GetBlock(f,g)&&a.SetBlock(f,g,182));return d},AddEnemyLine:function(a,b,c,d){var e=0,f=0;for(e=b;c>e;e++)(0|35*Math.random())<this.Difficulty+1&&(f=0|4*Math.random(),this.Difficulty<1?f=Mario.Enemy.Goomba:this.Difficulty<3&&(f=0|3*Math.random()),a.SetSpriteTemplate(e,d,new Mario.SpriteTemplate(f,(0|35*Math.random())<this.Difficulty)))},BuildTubes:function(a,b,c){var d=(0|10*Math.random())+5,e=0|this.Height-1-4*Math.random(),f=0|b+1+4*Math.random(),g=e-(0|2*Math.random())-2,h=0,i=0,j=0;for(d>c&&(d=c),h=b;b+d>h;h++)for(h>f+1&&(f+=3+(0|4*Math.random()),g=e-(0|2*Math.random())-2),f>=b+d-2&&(f+=10),h===f&&(0|11*Math.random())<this.Difficulty+1&&a.SetSpriteTemplate(h,g,new Mario.SpriteTemplate(Mario.Enemy.Flower,!1)),i=0;i<this.Height;i++)i>=e?a.SetBlock(h,i,145):(h===f||h===f+1)&&i>=g&&(j=10+h-f,i===g?a.SetBlock(h,i,j):a.SetBlock(h,i,j+16));return d},BuildStraight:function(a,b,c,d){var e=(0|10*Math.random())+2,f=this.Height-1-(0|4*Math.random()),g=0,h=0;for(d&&(e=10+(0|5*Math.random())),e>c&&(e=c),g=b;b+e>g;g++)for(h=0;h<this.Height;h++)h>=f&&a.SetBlock(g,h,145);return d||e>5&&this.Decorate(a,b,b+e,f),e},Decorate:function(a,b,c,d){if(!(1>d)){var e=!0,f=0|4*Math.random(),g=0|4*Math.random(),h=0;if(this.AddEnemyLine(a,b+1,c-1,d-1),d-2>0&&c-1-g-(b+1+f)>1)for(h=b+1+f;c-1-g>h;h++)a.SetBlock(h,d-2,34);if(f=0|4*Math.random(),g=0|4*Math.random(),d-4>0&&c-1-g-(b+1+f)>2)for(h=b+1+f;c-1-g>h;h++)e&&(h!==b+1&&h!==c-2&&0===(0|3*Math.random())?0===(0|4*Math.random())?a.SetBlock(h,d-4,22):a.SetBlock(h,d-4,21):0===(0|4*Math.random())?0===(0|4*Math.random())?a.SetBlock(h,d-4,18):a.SetBlock(h,d-4,17):a.SetBlock(h,d-4,16))}},FixWalls:function(a){var b=[],c=0,d=0,e=0,f=0,g=0;for(c=0;c<this.Width+1;c++)for(b[c]=[],d=0;d<this.Height+1;d++){for(g=0,e=c-1;c+1>e;e++)for(f=d-1;d+1>f;f++)145===a.GetBlockCapped(e,f)&&g++;b[c][d]=4===g}this.Blockify(a,b,this.Width+1,this.Height+1)},Blockify:function(a,b,c,d){var e=0,f=[],g=0,h=0,i=0,j=0,k=0,l=0,m=0;for(k=0;2>k;k++)f[k]=[];for(this.Type===Mario.LevelType.Castle?e=8:this.Type===Mario.LevelType.Underground&&(e=12),g=0;c>g;g++)for(h=0;d>h;h++){for(i=g;g+1>=i;i++)for(j=h;h+1>=j;j++)l=i,m=j,0>l&&(l=0),0>m&&(m=0),l>c-1&&(l=c-1),m>d-1&&(m=d-1),f[i-g][j-h]=b[l][m];f[0][0]===f[1][0]&&f[0][1]===f[1][1]?f[0][0]===f[0][1]?f[0][0]&&a.SetBlock(g,h,145+e):f[0][0]?a.SetBlock(g,h,161+e):a.SetBlock(g,h,129+e):f[0][0]===f[0][1]&&f[1][0]===f[1][1]?f[0][0]?a.SetBlock(g,h,146+e):a.SetBlock(g,h,144+e):f[0][0]===f[1][1]&&f[0][1]===f[1][0]?a.SetBlock(g,h,145+e):f[0][0]===f[1][0]?f[0][0]?f[0][1]?a.SetBlock(g,h,163+e):a.SetBlock(g,h,179+e):f[0][1]?a.SetBlock(g,h,130+e):a.SetBlock(g,h,128+e):f[0][1]===f[1][1]?f[0][1]?f[0][0]?a.SetBlock(g,h,147+e):a.SetBlock(g,h,131+e):f[0][0]?a.SetBlock(g,h,162+e):a.SetBlock(g,h,160+e):a.SetBlock(g,h,1+16*e)}}},Mario.SpriteTemplate=function(a,b){this.Type=a,this.Winged=b,this.LastVisibleTick=-1,this.IsDead=!1,this.Sprite=null},Mario.SpriteTemplate.prototype={Spawn:function(a,b,c,d){this.IsDead||(this.Sprite=this.Type===Mario.Enemy.Flower?new Mario.FlowerEnemy(a,16*b+15,16*c+24):new Mario.Enemy(a,16*b+8,16*c+15,d,this.Type,this.Winged),this.Sprite.SpriteTemplate=this,a.AddSprite(this.Sprite))}},Mario.Enemy=function(a,b,c,d,e,f){this.GroundInertia=.89,this.AirInertia=.89,this.RunTime=0,this.OnGround=!1,this.MayJump=!1,this.JumpTime=0,this.XJumpSpeed=0,this.YJumpSpeed=0,this.Width=4,this.Height=24,this.DeadTime=0,this.FlyDeath=!1,this.WingTime=0,this.NoFireballDeath=!1,this.X=b,this.Y=c,this.World=a,this.Type=e,this.Winged=f,this.Image=Enjine.Resources.Images.enemies,this.XPicO=8,this.YPicO=31,this.AvoidCliffs=this.Type===Mario.Enemy.RedKoopa,this.NoFireballDeath=this.Type===Mario.Enemy.Spiky,this.YPic=this.Type,this.YPic>1&&(this.Height=12),this.Facing=d,0===this.Facing&&(this.Facing=1),this.PicWidth=16},Mario.Enemy.prototype=new Mario.NotchSprite,Mario.Enemy.prototype.CollideCheck=function(){if(0===this.DeadTime){var a=Mario.MarioCharacter.X-this.X,b=Mario.MarioCharacter.Y-this.Y;a>2*-this.Width-4&&a<2*this.Width+4&&b>-this.Height&&b<Mario.MarioCharacter.Height&&(!(this.Type!==Mario.Enemy.Spiky&&Mario.MarioCharacter.Ya>0&&0>=b)||Mario.MarioCharacter.OnGround&&Mario.MarioCharacter.WasOnGround?Mario.MarioCharacter.GetHurt():(Mario.MarioCharacter.Stomp(this),this.Winged?(this.Winged=!1,this.Ya=0):(this.YPicO=7,this.PicHeight=8,null!==this.SpriteTemplate&&(this.SpriteTemplate.IsDead=!0),this.DeadTime=10,this.Winged=!1,this.Type===Mario.Enemy.RedKoopa?this.World.AddSprite(new Mario.Shell(this.World,this.X,this.Y,0)):this.Type===Mario.Enemy.GreenKoopa&&this.World.AddSprite(new Mario.Shell(this.World,this.X,this.Y,1)))))}},Mario.Enemy.prototype.Move=function(){var a=0,b=1.75,c=0;if(this.WingTime++,this.DeadTime>0){if(this.DeadTime--,0===this.DeadTime){for(this.DeadTime=1,a=0;8>a;a++)this.World.AddSprite(new Mario.Sparkle(this.World,(0|this.X+16*Math.random()-8)+4,(0|this.Y-8*Math.random())+4,2*Math.random()-1,-1*Math.random(),0,1,5));this.World.RemoveSprite(this)}return this.FlyDeath&&(this.X+=this.Xa,this.Y+=this.Ya,this.Ya*=.95,this.Ya+=1),void 0}this.Xa>2&&(this.Facing=1),this.Xa<-2&&(this.Facing=-1),this.Xa=this.Facing*b,this.MayJump=this.OnGround,this.XFlip=-1===this.Facing,this.RunTime+=Math.abs(this.Xa)+5,c=(0|this.RunTime/20)%2,this.OnGround||(c=1),this.SubMove(this.Xa,0)||(this.Facing=-this.Facing),this.OnGround=!1,this.SubMove(0,this.Ya),this.Ya*=this.Winged?.95:.85,this.Xa*=this.OnGround?this.GroundInertia:this.AirInertia,this.OnGround?this.Winged&&(this.Ya=-10):this.Ya+=this.Winged?.6:2,this.Winged&&(c=(0|this.WingTime/4)%2),this.XPic=c},Mario.Enemy.prototype.SubMove=function(a,b){for(var c=!1;a>8;){if(!this.SubMove(8,0))return!1;a-=8}for(;-8>a;){if(!this.SubMove(-8,0))return!1;a+=8}for(;b>8;){if(!this.SubMove(0,8))return!1;b-=8}for(;-8>b;){if(!this.SubMove(0,-8))return!1;b+=8}return b>0&&(this.IsBlocking(this.X+a-this.Width,this.Y+b,a,0)?c=!0:this.IsBlocking(this.X+a+this.Width,this.Y+b,a,0)?c=!0:this.IsBlocking(this.X+a-this.Width,this.Y+b+1,a,b)?c=!0:this.IsBlocking(this.X+a+this.Width,this.Y+b+1,a,b)&&(c=!0)),0>b&&(this.IsBlocking(this.X+a,this.Y+b-this.Height,a,b)?c=!0:c||this.IsBlocking(this.X+a-this.Width,this.Y+b-this.Height,a,b)?c=!0:(c||this.IsBlocking(this.X+a+this.Width,this.Y+b-this.Height,a,b))&&(c=!0)),a>0&&(this.IsBlocking(this.X+a+this.Width,this.Y+b-this.Height,a,b)&&(c=!0),this.IsBlocking(this.X+a+this.Width,this.Y+b-(0|this.Height/2),a,b)&&(c=!0),this.IsBlocking(this.X+a+this.Width,this.Y+b,a,b)&&(c=!0),this.AvoidCliffs&&this.OnGround&&!this.World.Level.IsBlocking(0|(this.X+this.Xa+this.Width)/16,0|this.Y/16+1,this.Xa,1)&&(c=!0)),0>a&&(this.IsBlocking(this.X+a-this.Width,this.Y+b-this.Height,a,b)&&(c=!0),this.IsBlocking(this.X+a-this.Width,this.Y+b-(0|this.Height/2),a,b)&&(c=!0),this.IsBlocking(this.X+a-this.Width,this.Y+b,a,b)&&(c=!0),this.AvoidCliffs&&this.OnGround&&!this.World.Level.IsBlocking(0|(this.X+this.Xa-this.Width)/16,0|this.Y/16+1,this.Xa,1)&&(c=!0)),c?(0>a&&(this.X=16*(0|(this.X-this.Width)/16)+this.Width,this.Xa=0),a>0&&(this.X=16*(0|(this.X+this.Width)/16+1)-this.Width-1,this.Xa=0),0>b&&(this.Y=16*(0|(this.Y-this.Height)/16)+this.Height,this.JumpTime=0,this.Ya=0),b>0&&(this.Y=16*(0|(this.Y-1)/16+1)-1,this.OnGround=!0),!1):(this.X+=a,this.Y+=b,!0)
},Mario.Enemy.prototype.IsBlocking=function(a,b,c,d){return a=0|a/16,b=0|b/16,0|a===this.X/16&&0|b===this.Y/16?!1:this.World.Level.IsBlocking(a,b,c,d)},Mario.Enemy.prototype.ShellCollideCheck=function(a){if(0!==this.DeadTime)return!1;var b=a.X-this.X,c=a.Y-this.Y;return b>-16&&16>b&&c>-this.Height&&c<a.Height?(Enjine.Resources.PlaySound("kick"),this.Xa=2*a.Facing,this.Ya=-5,this.FlyDeath=!0,null!==this.SpriteTemplate&&(this.SpriteTemplate.IsDead=!0),this.DeadTime=100,this.Winged=!1,this.YFlip=!0,!0):!1},Mario.Enemy.prototype.FireballCollideCheck=function(a){if(0!==this.DeadTime)return!1;var b=a.X-this.X,c=a.Y-this.Y;return b>-16&&16>b&&c>-this.Height&&c<a.Height?this.NoFireballDeath?!0:(Enjine.Resources.PlaySound("kick"),this.Xa=2*a.Facing,this.Ya=-5,this.FlyDeath=!0,null!==this.SpriteTemplate&&(this.SpriteTemplate.IsDead=!0),this.DeadTime=100,this.Winged=!1,this.YFlip=!0,!0):void 0},Mario.Enemy.prototype.BumpCheck=function(a,b){0===this.DeadTime&&this.X+this.Width>16*a&&this.X-this.Width<16*a+16&&0|b===(this.Y-1)/16&&(Enjine.Resources.PlaySound("kick"),this.Xa=2*-Mario.MarioCharacter.Facing,this.Ya=-5,this.FlyDeath=!0,null!==this.SpriteTemplate&&(this.SpriteTemplate.IsDead=!0),this.DeadTime=100,this.Winged=!1,this.YFlip=!0)},Mario.Enemy.prototype.SubDraw=Mario.NotchSprite.prototype.Draw,Mario.Enemy.prototype.Draw=function(a,b){var c=0,d=0;this.Winged&&(c=(0|this.XOld+(this.X-this.XOld)*this.Delta)-this.XPicO,d=(0|this.YOld+(this.Y-this.YOld)*this.Delta)-this.YPicO,this.Type!==Mario.Enemy.RedKoopa&&this.Type!==Mario.Enemy.GreenKoopa&&(this.XFlip=!this.XFlip,a.save(),a.scale(this.XFlip?-1:1,this.YFlip?-1:1),a.translate(this.XFlip?-320:0,this.YFlip?-240:0),a.drawImage(this.Image,16*((0|this.WingTime/4)%2),128,16,32,this.XFlip?320-c-24:c-8,this.YFlip?240-d-32:d-8,16,32),a.restore(),this.XFlip=!this.XFlip)),this.SubDraw(a,b),this.Winged&&(c=(0|this.XOld+(this.X-this.XOld)*this.Delta)-this.XPicO,d=(0|this.YOld+(this.Y-this.YOld)*this.Delta)-this.YPicO,this.Type===Mario.Enemy.RedKoopa&&this.Type===Mario.Enemy.GreenKoopa?(a.save(),a.scale(this.XFlip?-1:1,this.YFlip?-1:1),a.translate(this.XFlip?-320:0,this.YFlip?-240:0),a.drawImage(this.Image,16*((0|this.WingTime/4)%2),128,16,32,this.XFlip?320-c-24:c-8,this.YFlip?240-d:d-8,16,32),a.restore()):(a.save(),a.scale(this.XFlip?-1:1,this.YFlip?-1:1),a.translate(this.XFlip?-320:0,this.YFlip?-240:0),a.drawImage(this.Image,16*((0|this.WingTime/4)%2),128,16,32,this.XFlip?320-c-24:c-8,this.YFlip?240-d-32:d-8,16,32),a.restore()))},Mario.Enemy.RedKoopa=0,Mario.Enemy.GreenKoopa=1,Mario.Enemy.Goomba=2,Mario.Enemy.Spiky=3,Mario.Enemy.Flower=4,Mario.Fireball=function(a,b,c,d){this.GroundInertia=.89,this.AirInertia=.89,this.Image=Enjine.Resources.Images.particles,this.World=a,this.X=b,this.Y=c,this.Facing=d,this.XPicO=4,this.YPicO=4,this.YPic=3,this.XPic=4,this.Height=8,this.Width=4,this.PicWidth=this.PicHeight=8,this.Ya=4,this.Dead=!1,this.DeadTime=0,this.Anim=0,this.OnGround=!1},Mario.Fireball.prototype=new Mario.NotchSprite,Mario.Fireball.prototype.Move=function(){var a=0,b=8;if(this.DeadTime>0){for(a=0;8>a;a++)this.World.AddSprite(new Mario.Sparkle(this.World,(0|this.X+8*Math.random()-4)+4,(0|this.Y+8*Math.random()-4)+2,2*Math.random()-1*this.Facing,2*Math.random()-1,0,1,5));return this.World.RemoveSprite(this),void 0}0!=this.Facing&&this.Anim++,this.Xa>2&&(this.Facing=1),this.Xa<-2&&(this.Facing=-1),this.Xa=this.Facing*b,this.World.CheckFireballCollide(this),this.FlipX=-1===this.Facing,this.XPic=this.Anim%4,this.SubMove(this.Xa,0)||this.Die(),this.OnGround=!1,this.SubMove(0,this.Ya),this.OnGround&&(this.Ya=-10),this.Ya*=.95,this.Xa*=this.OnGround?this.GroundInertia:this.AirInertia,this.OnGround||(this.Ya+=1.5)},Mario.Fireball.prototype.SubMove=function(a,b){for(var c=!1;a>8;){if(!this.SubMove(8,0))return!1;a-=8}for(;-8>a;){if(!this.SubMove(-8,0))return!1;a+=8}for(;b>8;){if(!this.SubMove(0,8))return!1;b-=8}for(;-8>b;){if(!this.SubMove(0,-8))return!1;b+=8}return b>0&&(this.IsBlocking(this.X+a-this.Width,this.Y+b,a,0)?c=!0:this.IsBlocking(this.X+a+this.Width,this.Y+b,a,0)?c=!0:this.IsBlocking(this.X+a-this.Width,this.Y+b+1,a,b)?c=!0:this.IsBlocking(this.X+a+this.Width,this.Y+b+1,a,b)&&(c=!0)),0>b&&(this.IsBlocking(this.X+a,this.Y+b-this.Height,a,b)?c=!0:c||this.IsBlocking(this.X+a-this.Width,this.Y+b-this.Height,a,b)?c=!0:(c||this.IsBlocking(this.X+a+this.Width,this.Y+b-this.Height,a,b))&&(c=!0)),a>0&&(this.IsBlocking(this.X+a+this.Width,this.Y+b-this.Height,a,b)&&(c=!0),this.IsBlocking(this.X+a+this.Width,this.Y+b-(0|this.Height/2),a,b)&&(c=!0),this.IsBlocking(this.X+a+this.Width,this.Y+b,a,b)&&(c=!0)),0>a&&(this.IsBlocking(this.X+a-this.Width,this.Y+b-this.Height,a,b)&&(c=!0),this.IsBlocking(this.X+a-this.Width,this.Y+b-(0|this.Height/2),a,b)&&(c=!0),this.IsBlocking(this.X+a-this.Width,this.Y+b,a,b)&&(c=!0)),c?(0>a&&(this.X=16*(0|(this.X-this.Width)/16)+this.Width,this.Xa=0),a>0&&(this.X=16*(0|(this.X+this.Width)/16+1)-this.Width-1,this.Xa=0),0>b&&(this.Y=16*(0|(this.Y-this.Height)/16)+this.Height,this.Ya=0),b>0&&(this.Y=16*(0|(this.Y-1)/16+1)-1,this.OnGround=!0),!1):(this.X+=a,this.Y+=b,!0)},Mario.Fireball.prototype.IsBlocking=function(a,b,c,d){return a=0|a/16,b=0|b/16,0|a===this.X/16&&0|b===this.Y/16?!1:this.World.Level.IsBlocking(a,b,c,d)},Mario.Fireball.prototype.Die=function(){this.Dead=!0,this.Xa=2*-this.Facing,this.Ya=-5,this.DeadTime=100},Mario.Sparkle=function(a,b,c,d,e){this.World=a,this.X=b,this.Y=c,this.Xa=d,this.Ya=e,this.XPic=0|2*Math.random(),this.YPic=0,this.Life=10+(0|5*Math.random()),this.XPicStart=this.XPic,this.XPicO=4,this.YPicO=4,this.PicWidth=8,this.PicHeight=8,this.Image=Enjine.Resources.Images.particles},Mario.Sparkle.prototype=new Mario.NotchSprite,Mario.Sparkle.prototype.Move=function(){this.XPic=this.Life>10?7:0|this.XPicStart+.4*(10-this.Life),this.Life--<0&&this.World.RemoveSprite(this),this.X+=this.Xa,this.Y+=this.Ya},Mario.CoinAnim=function(a,b,c){this.World=a,this.Life=10,this.Image=Enjine.Resources.Images.map,this.PicWidth=this.PicHeight=16,this.X=16*b,this.Y=16*c-16,this.Xa=0,this.Ya=-6,this.XPic=0,this.YPic=2},Mario.CoinAnim.prototype=new Mario.NotchSprite,Mario.CoinAnim.prototype.Move=function(){var a=0,b=0;if(this.Life--<0)for(this.World.RemoveSprite(this),a=0;2>a;a++)for(b=0;2>b;b++)this.World.AddSprite(new Mario.Sparkle(this.World,0|this.X+8*a+8*Math.random(),0|this.Y+8*b+8*Math.random(),0,0,0,2,5));this.XPic=3&this.Life,this.X+=this.Xa,this.Y+=this.Ya,this.Ya+=1},Mario.Mushroom=function(a,b,c){this.RunTime=0,this.GroundInertia=.89,this.AirInertia=.89,this.OnGround=!1,this.Width=4,this.Height=24,this.World=a,this.X=b,this.Y=c,this.Image=Enjine.Resources.Images.items,this.XPicO=8,this.YPicO=15,this.YPic=0,this.Height=12,this.Facing=1,this.PicWidth=this.PicHeight=16,this.Life=0},Mario.Mushroom.prototype=new Mario.NotchSprite,Mario.Mushroom.prototype.CollideCheck=function(){var a=Mario.MarioCharacter.X-this.X,b=Mario.MarioCharacter.Y-this.Y;a>-16&&16>a&&b>-this.Height&&b<Mario.MarioCharacter.Height&&(Mario.MarioCharacter.GetMushroom(),this.World.RemoveSprite(this))},Mario.Mushroom.prototype.Move=function(){if(this.Life<9)return this.Layer=0,this.Y--,this.Life++,void 0;var a=1.75;this.Layer=1,this.Xa>2&&(this.Facing=1),this.Xa<-2&&(this.Facing=-1),this.Xa=this.Facing*a,this.XFlip=-1===this.Facing,this.RunTime+=Math.abs(this.Xa)+5,this.SubMove(this.Xa,0)||(this.Facing=-this.Facing),this.OnGround=!1,this.SubMove(0,this.Ya),this.Ya*=.85,this.Xa*=this.OnGround?this.GroundInertia:this.AirInertia,this.OnGround||(this.Ya+=2)},Mario.Mushroom.prototype.SubMove=function(a,b){for(var c=!1;a>8;){if(!this.SubMove(8,0))return!1;a-=8}for(;-8>a;){if(!this.SubMove(-8,0))return!1;a+=8}for(;b>8;){if(!this.SubMove(0,8))return!1;b-=8}for(;-8>b;){if(!this.SubMove(0,-8))return!1;b+=8}return b>0&&(this.IsBlocking(this.X+a-this.Width,this.Y+b,a,0)?c=!0:this.IsBlocking(this.X+a+this.Width,this.Y+b,a,0)?c=!0:this.IsBlocking(this.X+a-this.Width,this.Y+b+1,a,b)?c=!0:this.IsBlocking(this.X+a+this.Width,this.Y+b+1,a,b)&&(c=!0)),0>b&&(this.IsBlocking(this.X+a,this.Y+b-this.Height,a,b)?c=!0:c||this.IsBlocking(this.X+a-this.Width,this.Y+b-this.Height,a,b)?c=!0:(c||this.IsBlocking(this.X+a+this.Width,this.Y+b-this.Height,a,b))&&(c=!0)),a>0&&(this.IsBlocking(this.X+a+this.Width,this.Y+b-this.Height,a,b)&&(c=!0),this.IsBlocking(this.X+a+this.Width,this.Y+b-(0|this.Height/2),a,b)&&(c=!0),this.IsBlocking(this.X+a+this.Width,this.Y+b,a,b)&&(c=!0)),0>a&&(this.IsBlocking(this.X+a-this.Width,this.Y+b-this.Height,a,b)&&(c=!0),this.IsBlocking(this.X+a-this.Width,this.Y+b-(0|this.Height/2),a,b)&&(c=!0),this.IsBlocking(this.X+a-this.Width,this.Y+b,a,b)&&(c=!0)),c?(0>a&&(this.X=16*(0|(this.X-this.Width)/16)+this.Width,this.Xa=0),a>0&&(this.X=16*(0|(this.X+this.Width)/16+1)-this.Width-1,this.Xa=0),0>b&&(this.Y=16*(0|(this.Y-this.Height)/16)+this.Height,this.JumpTime=0,this.Ya=0),b>0&&(this.Y=16*(0|(this.Y-1)/16+1)-1,this.OnGround=!0),!1):(this.X+=a,this.Y+=b,!0)},Mario.Mushroom.prototype.IsBlocking=function(a,b,c,d){return a=0|a/16,b=0|b/16,0|a===this.X/16&&0|b===this.Y/16?!1:this.World.Level.IsBlocking(a,b,c,d)},Mario.Mushroom.prototype.BumpCheck=function(a,b){this.X+this.Width>16*a&&this.X-this.Width<16*a-16&&0|b===(b-1)/16&&(this.Facing=-Mario.MarioCharacter.Facing,this.Ya=-10)},Mario.Particle=function(a,b,c,d,e){this.World=a,this.X=b,this.Y=c,this.Xa=d,this.Ya=e,this.XPic=0|2*Math.random(),this.YPic=0,this.XPicO=4,this.YPicO=4,this.PicWidth=8,this.PicHeight=8,this.Life=10,this.Image=Enjine.Resources.Images.particles},Mario.Particle.prototype=new Mario.NotchSprite,Mario.Particle.prototype.Move=function(){this.Life-this.Delta<0&&this.World.RemoveSprite(this),this.Life-=this.Delta,this.X+=this.Xa,this.Y+=this.Ya,this.Ya*=.95,this.Ya+=3},Mario.FireFlower=function(a,b,c){this.Width=4,this.Height=24,this.World=a,this.X=b,this.Y=c,this.Image=Enjine.Resources.Images.items,this.XPicO=8,this.YPicO=15,this.XPic=1,this.YPic=0,this.Height=12,this.Facing=1,this.PicWidth=this.PicHeight=16,this.Life=0},Mario.FireFlower.prototype=new Mario.NotchSprite,Mario.FireFlower.prototype.CollideCheck=function(){var a=Mario.MarioCharacter.X-this.X,b=Mario.MarioCharacter.Y-this.Y;a>-16&&16>a&&b>-this.Height&&b<Mario.MarioCharacter.Height&&(Mario.MarioCharacter.GetFlower(),this.World.RemoveSprite(this))},Mario.FireFlower.prototype.Move=function(){return this.Life<9?(this.Layer=0,this.Y--,this.Life++,void 0):void 0},Mario.BulletBill=function(a,b,c,d){this.Image=Enjine.Resources.Images.enemies,this.World=a,this.X=b,this.Y=c,this.Facing=d,this.XPicO=8,this.YPicO=31,this.Height=12,this.Width=4,this.PicWidth=16,this.YPic=5,this.XPic=0,this.Ya=-5,this.DeadTime=0,this.Dead=!1,this.Anim=0},Mario.BulletBill.prototype=new Mario.NotchSprite,Mario.BulletBill.prototype.CollideCheck=function(){if(!this.Dead){var a=Mario.MarioCharacter.X-this.X,b=Mario.MarioCharacter.Y-this.Y;a>-16&&16>a&&b>-this.Height&&b<this.World.Mario.Height&&(!(Mario.MarioCharacter.Y>0&&0>=b)||Mario.MarioCharacter.OnGround&&Mario.MarioCharacter.WasOnGround?Mario.MarioCharacter.GetHurt():(Mario.MarioCharacter.Stomp(this),this.Dead=!0,this.Xa=0,this.Ya=1,this.DeadTime=100))}},Mario.BulletBill.prototype.Move=function(){var a=0,b=4;if(this.DeadTime>0){if(this.DeadTime--,0===this.DeadTime){for(this.DeadTime=1,a=0;8>a;a++)this.World.AddSprite(new Mario.Sparkle((0|this.X+16*Math.random()-8)+4,(0|this.Y+8*Math.random())+4,2*Math.random()-1,-1*Math.random(),0,1,5));this.World.RemoveSprite(this)}return this.X+=this.Xa,this.Y+=this.Ya,this.Ya*=.95,this.Ya+=1,void 0}this.Xa=this.Facing*b,this.XFlip=-1===this.Facing,this.Move(this.Xa,0)},Mario.BulletBill.prototype.SubMove=function(a){return this.X+=a,!0},Mario.BulletBill.prototype.FireballCollideCheck=function(a){if(0!==this.DeadTime)return!1;var b=a.X-this.X,c=a.Y-this.Y;return b>-16&&16>b&&c>-this.Height&&c<a.Height?!0:!1},Mario.BulletBill.prototype.ShellCollideCheck=function(a){if(0!==this.DeadTime)return!1;var b=a.X-this.X,c=a.Y-this.Y;return b>-16&&16>b&&c>-this.Height&&c<a.Height?(Enjine.Resources.PlaySound("kick"),this.Dead=!0,this.Xa=0,this.Ya=1,this.DeadTime=100,!0):!1},Mario.FlowerEnemy=function(a,b,c){this.Image=Enjine.Resources.Images.enemies,this.World=a,this.X=b,this.Y=c,this.Facing=1,this.Type=Mario.Enemy.Spiky,this.Winged=!1,this.NoFireballDeath=!1,this.XPic=0,this.YPic=6,this.YPicO=24,this.Height=12,this.Width=2,this.YStart=c,this.Ya=-8,this.Y-=1,this.Layer=0,this.JumpTime=0,this.Tick=0;var d=0;for(d=0;4>d;d++)this.Move()},Mario.FlowerEnemy.prototype=new Mario.Enemy,Mario.FlowerEnemy.prototype.Move=function(){var a=0,b=0;if(this.DeadTime>0){if(this.DeadTime--,0===this.DeadTime){for(this.DeadTime=1,a=0;8>a;a++)this.World.AddSprite(new Mario.Sparkle((0|this.X+16*Math.random()-8)+4,(0|this.Y+8*Math.random())+4,2*Math.random()-1,-1*Math.random(),0,1,5));this.World.RemoveSprite(this)}return this.X+=this.Xa,this.Y+=this.Ya,this.Ya*=.95,this.Ya+=1,void 0}this.Tick++,this.Y>=this.YStart?(this.YStart=this.Y,b=0|Math.abs(Mario.MarioCharacter.X-this.X),this.JumpTime++,this.Ya=this.JumpTime>40&&b>24?-8:0):this.JumpTime=0,this.Y+=this.Ya,this.Ya*=.9,this.Ya+=.1,this.XPic=2*(1&(0|this.Tick/2))+(1&(0|this.Tick/6))},Mario.Shell=function(a,b,c,d){this.World=a,this.X=b,this.Y=c,this.YPic=d,this.Image=Enjine.Resources.Images.enemies,this.XPicO=8,this.YPicO=31,this.Width=4,this.Height=12,this.Facing=0,this.PicWidth=16,this.XPic=4,this.Ya=-5,this.Dead=!1,this.DeadTime=0,this.Carried=!1,this.GroundInertia=.89,this.AirInertia=.89,this.OnGround=!1,this.Anim=0},Mario.Shell.prototype=new Mario.NotchSprite,Mario.Shell.prototype.FireballCollideCheck=function(a){if(0!==this.DeadTime)return!1;var b=a.X-this.X,c=a.Y-this.Y;return b>-16&&16>b&&c>-this.Height&&c<a.Height?0!==this.Facing?!0:(Enjine.Resources.PlaySound("kick"),this.Xa=2*a.Facing,this.Ya=-5,null!==this.SpriteTemplate&&(this.SpriteTemplate.IsDead=!0),this.DeadTime=100,this.YFlip=!0,!0):!1},Mario.Shell.prototype.CollideCheck=function(){if(!(this.Carried||this.Dead||this.DeadTime>0)){var a=Mario.MarioCharacter.X-this.X,b=Mario.MarioCharacter.Y-this.Y;a>-16&&16>a&&b>-this.Height&&b<Mario.MarioCharacter.Height&&(!(Mario.MarioCharacter.Ya>0&&0>=b)||Mario.MarioCharacter.OnGround&&Mario.MarioCharacter.WasOnGround?0!==this.Facing?Mario.MarioCharacter.GetHurt():(Mario.MarioCharacter.Kick(this),this.Facing=Mario.MarioCharacter.Facing):(Mario.MarioCharacter.Stomp(this),0!==this.Facing?(this.Xa=0,this.Facing=0):this.Facing=Mario.MarioCharacter.Facing))}},Mario.Shell.prototype.Move=function(){var a=11,b=0;if(this.Carried)return this.World.CheckShellCollide(this),void 0;if(this.DeadTime>0){if(this.DeadTime--,0===this.DeadTime){for(this.DeadTime=1,b=0;8>b;b++)this.World.AddSprite(new Mario.Sparkle((0|this.X+16*Math.random()-8)+4,(0|this.Y+8*Math.random())+4,2*Math.random()-1,-1*Math.random(),0,1,5));this.World.RemoveSprite(this)}return this.X+=this.Xa,this.Y+=this.Ya,this.Ya*=.95,this.Ya+=1,void 0}0!==this.Facing&&this.Anim++,this.Xa>2&&(this.Facing=1),this.Xa<-2&&(this.Facing=-1),this.Xa=this.Facing*a,0!==this.Facing&&this.World.CheckShellCollide(this),this.XFlip=-1===this.Facing,this.XPic=(0|this.Anim/2)%4+3,this.SubMove(this.Xa,0)||(Enjine.Resources.PlaySound("bump"),this.Facing=-this.Facing),this.OnGround=!1,this.SubMove(0,this.Ya),this.Ya*=.85,this.Xa*=this.OnGround?this.GroundInertia:this.AirInertia,this.OnGround||(this.Ya+=2)},Mario.Shell.prototype.SubMove=function(a,b){for(var c=!1;a>8;){if(!this.SubMove(8,0))return!1;a-=8}for(;-8>a;){if(!this.SubMove(-8,0))return!1;a+=8}for(;b>8;){if(!this.SubMove(0,8))return!1;b-=8}for(;-8>b;){if(!this.SubMove(0,-8))return!1;b+=8}return b>0&&(this.IsBlocking(this.X+a-this.Width,this.Y+b,a,0)?c=!0:this.IsBlocking(this.X+a+this.Width,this.Y+b,a,0)?c=!0:this.IsBlocking(this.X+a-this.Width,this.Y+b+1,a,b)?c=!0:this.IsBlocking(this.X+a+this.Width,this.Y+b+1,a,b)&&(c=!0)),0>b&&(this.IsBlocking(this.X+a,this.Y+b-this.Height,a,b)?c=!0:c||this.IsBlocking(this.X+a-this.Width,this.Y+b-this.Height,a,b)?c=!0:(c||this.IsBlocking(this.X+a+this.Width,this.Y+b-this.Height,a,b))&&(c=!0)),a>0&&(this.IsBlocking(this.X+a+this.Width,this.Y+b-this.Height,a,b)&&(c=!0),this.IsBlocking(this.X+a+this.Width,this.Y+b-(0|this.Height/2),a,b)&&(c=!0),this.IsBlocking(this.X+a+this.Width,this.Y+b,a,b)&&(c=!0)),0>a&&(this.IsBlocking(this.X+a-this.Width,this.Y+b-this.Height,a,b)&&(c=!0),this.IsBlocking(this.X+a-this.Width,this.Y+b-(0|this.Height/2),a,b)&&(c=!0),this.IsBlocking(this.X+a-this.Width,this.Y+b,a,b)&&(c=!0)),c?(0>a&&(this.X=16*(0|(this.X-this.Width)/16)+this.Width,this.Xa=0),a>0&&(this.X=16*(0|(this.X+this.Width)/16+1)-this.Width-1,this.Xa=0),0>b&&(this.Y=16*(0|(this.Y-this.Height)/16)+this.Height,this.Ya=0),b>0&&(this.Y=16*(0|(this.Y-1)/16+1)-1,this.OnGround=!0),!1):(this.X+=a,this.Y+=b,!0)},Mario.Shell.prototype.IsBlocking=function(a,b,c,d){if(a=0|a/16,b=0|b/16,a===(0|this.X/16)&&b===(0|this.Y/16))return!1;var e=this.World.Level.IsBlocking(a,b,c,d);return e&&0===d&&0!==c&&this.World.Bump(a,b,!0),e},Mario.Shell.prototype.BumpCheck=function(a,b){this.X+this.Width>16*a&&this.X-this.Width<16*a+16&&b===(0|(this.Y-1)/16)&&(this.Facing=-Mario.MarioCharacter.Facing,this.Ya=-10)},Mario.Shell.prototype.Die=function(){this.Dead=!0,this.Carried=!1,this.Xa=2*-this.Facing,this.Ya=-5,this.DeadTime=100},Mario.Shell.prototype.ShellCollideCheck=function(a){if(0!==this.DeadTime)return!1;var b=a.X-this.X,c=a.Y-this.Y;return b>-16&&16>b&&c>-this.Height&&c<a.Height?(Enjine.Resources.PlaySound("kick"),(Mario.MarioCharacter.Carried===a||Mario.MarioCharacter.Carried===this)&&(Mario.MarioCharacter.Carried=null),this.Die(),a.Die(),!0):!1},Mario.Shell.prototype.Release=function(){this.Carried=!1,this.Facing=Mario.MarioCharacter.Facing,this.X+=8*this.Facing},Mario.TitleState=function(){this.drawManager=null,this.camera=null,this.logoY=null,this.bounce=null,this.font=null},Mario.TitleState.prototype=new Enjine.GameState,Mario.TitleState.prototype.Enter=function(){this.drawManager=new Enjine.DrawableManager,this.camera=new Enjine.Camera;var a=new Mario.BackgroundGenerator(2048,15,!0,Mario.LevelType.Overground),b=new Mario.BackgroundRenderer(a.CreateLevel(),320,240,2);a.SetValues(2048,15,!1,Mario.LevelType.Overground);var c=new Mario.BackgroundRenderer(a.CreateLevel(),320,240,1);this.title=new Enjine.Sprite,this.title.Image=Enjine.Resources.Images.title,this.title.X=0,this.title.Y=120,this.logo=new Enjine.Sprite,this.logo.Image=Enjine.Resources.Images.logo,this.logo.X=0,this.logo.Y=0,this.font=Mario.SpriteCuts.CreateRedFont(),this.font.Strings[0]={String:"Press S to Start",X:96,Y:120},this.logoY=20,this.drawManager.Add(b),this.drawManager.Add(c),this.bounce=0,Mario.GlobalMapState=new Mario.MapState,Mario.MarioCharacter=new Mario.Character,Mario.MarioCharacter.Image=Enjine.Resources.Images.smallMario},Mario.TitleState.prototype.Exit=function(){this.drawManager.Clear(),delete this.drawManager,delete this.camera,delete this.font},Mario.TitleState.prototype.Update=function(a){this.bounce+=2*a,this.logoY=20+10*Math.sin(this.bounce),this.camera.X+=25*a,this.drawManager.Update(a)},Mario.TitleState.prototype.Draw=function(a){this.drawManager.Draw(a,this.camera),a.drawImage(Enjine.Resources.Images.title,0,120),a.drawImage(Enjine.Resources.Images.logo,0,this.logoY),this.font.Draw(a,this.Camera)},Mario.TitleState.prototype.CheckForChange=function(a){Enjine.KeyboardInput.IsKeyDown(Enjine.Keys.S)&&a.ChangeState(Mario.GlobalMapState)},Mario.LoadingState=function(a){this.Base=a||"",this.Images=[],this.ImagesLoaded=!1,this.ScreenColor=0,this.ColorDirection=1,this.ImageIndex=0,this.SoundIndex=0},Mario.LoadingState.prototype=new Enjine.GameState,Mario.LoadingState.prototype.Enter=function(){var a=0;for(a=0;15>a;a++)this.Images[a]={};this.Images[0].name="background",this.Images[1].name="endScene",this.Images[2].name="enemies",this.Images[3].name="fireMario",this.Images[4].name="font",this.Images[5].name="gameOverGhost",this.Images[6].name="items",this.Images[7].name="logo",this.Images[8].name="map",this.Images[9].name="mario",this.Images[10].name="particles",this.Images[11].name="racoonMario",this.Images[12].name="smallMario",this.Images[13].name="title",this.Images[14].name="worldMap",this.Images[0].src="images/bgsheet.png",this.Images[1].src="images/endscene.gif",this.Images[2].src="images/enemysheet.png",this.Images[3].src="images/firemariosheet.png",this.Images[4].src="images/font.gif",this.Images[5].src="images/gameovergost.gif",this.Images[6].src="images/itemsheet.png",this.Images[7].src="images/logo.gif",this.Images[8].src="images/mapsheet.png",this.Images[9].src="images/mariosheet.png",this.Images[10].src="images/particlesheet.png",this.Images[11].src="images/racoonmariosheet.png",this.Images[12].src="images/smallmariosheet.png",this.Images[13].src="images/title.gif",this.Images[14].src="images/worldmap.png";for(var b=this.Base,a=0;a<this.Images.length;a++)this.Images[a].src=b+this.Images[a].src;Enjine.Resources.AddImages(this.Images),window.Audio||(window.Audio=function(){function a(){}return a.prototype.canPlayType=function(){return!1},a.prototype.paused=!1,a.prototype.play=function(){},a}());var c=new Audio;c.canPlayType("audio/mp3")?Enjine.Resources.AddSound("1up",b+"sounds/1-up.mp3",1).AddSound("breakblock",b+"sounds/breakblock.mp3").AddSound("bump",b+"sounds/bump.mp3",4).AddSound("cannon",b+"sounds/cannon.mp3").AddSound("coin",b+"sounds/coin.mp3",5).AddSound("death",b+"sounds/death.mp3",1).AddSound("exit",b+"sounds/exit.mp3",1).AddSound("fireball",b+"sounds/fireball.mp3",1).AddSound("jump",b+"sounds/jump.mp3").AddSound("kick",b+"sounds/kick.mp3").AddSound("pipe",b+"sounds/pipe.mp3",1).AddSound("powerdown",b+"sounds/powerdown.mp3",1).AddSound("powerup",b+"sounds/powerup.mp3",1).AddSound("sprout",b+"sounds/sprout.mp3",1).AddSound("stagestart",b+"sounds/stagestart.mp3",1).AddSound("stomp",b+"sounds/stomp.mp3",2):Enjine.Resources.AddSound("1up",b+"sounds/1-up.wav",1).AddSound("breakblock",b+"sounds/breakblock.wav").AddSound("bump",b+"sounds/bump.wav",2).AddSound("cannon",b+"sounds/cannon.wav").AddSound("coin",b+"sounds/coin.wav",5).AddSound("death",b+"sounds/death.wav",1).AddSound("exit",b+"sounds/exit.wav",1).AddSound("fireball",b+"sounds/fireball.wav",1).AddSound("jump",b+"sounds/jump.wav",1).AddSound("kick",b+"sounds/kick.wav",1).AddSound("message",b+"sounds/message.wav",1).AddSound("pipe",b+"sounds/pipe.wav",1).AddSound("powerdown",b+"sounds/powerdown.wav",1).AddSound("powerup",b+"sounds/powerup.wav",1).AddSound("sprout",b+"sounds/sprout.wav",1).AddSound("stagestart",b+"sounds/stagestart.wav",1).AddSound("stomp",b+"sounds/stomp.wav",1),Mario.Tile.LoadBehaviors()},Mario.LoadingState.prototype.Exit=function(){delete this.Images},Mario.LoadingState.prototype.Update=function(a){if(!this.ImagesLoaded){this.ImagesLoaded=!0;var b=0;for(b=0;b<this.Images.length;b++)if(Enjine.Resources.Images[this.Images[b].name].complete!==!0){this.ImagesLoaded=!1;break}}this.ScreenColor+=255*this.ColorDirection*a,this.ScreenColor>255?(this.ScreenColor=255,this.ColorDirection=-1):this.ScreenColor<0&&(this.ScreenColor=0,this.ColorDirection=1)},Mario.LoadingState.prototype.Draw=function(a){if(this.ImagesLoaded)a.fillStyle="rgb(0, 0, 0)",a.fillRect(0,0,640,480);else{var b=parseInt(this.ScreenColor,10);a.fillStyle="rgb("+b+","+b+","+b+")",a.fillRect(0,0,640,480)}},Mario.LoadingState.prototype.CheckForChange=function(a){this.ImagesLoaded&&(Mario.GlobalMapState=new Mario.MapState,a.ChangeState(new Mario.TitleState))},Mario.LoseState=function(){this.drawManager=null,this.camera=null,this.gameOver=null,this.font=null,this.wasKeyDown=!1},Mario.LoseState.prototype=new Enjine.GameState,Mario.LoseState.prototype.Enter=function(){this.drawManager=new Enjine.DrawableManager,this.camera=new Enjine.Camera,this.gameOver=new Enjine.AnimatedSprite,this.gameOver.Image=Enjine.Resources.Images.gameOverGhost,this.gameOver.SetColumnCount(9),this.gameOver.SetRowCount(1),this.gameOver.AddNewSequence("turnLoop",0,0,0,8),this.gameOver.PlaySequence("turnLoop",!0),this.gameOver.FramesPerSecond=1/15,this.gameOver.X=112,this.gameOver.Y=68,this.font=Mario.SpriteCuts.CreateBlackFont(),this.font.Strings[0]={String:"Game over!",X:116,Y:160},this.drawManager.Add(this.font),this.drawManager.Add(this.gameOver)},Mario.LoseState.prototype.Exit=function(){this.drawManager.Clear(),delete this.drawManager,delete this.camera,delete this.gameOver,delete this.font},Mario.LoseState.prototype.Update=function(a){this.drawManager.Update(a),Enjine.KeyboardInput.IsKeyDown(Enjine.Keys.S)&&(this.wasKeyDown=!0)},Mario.LoseState.prototype.Draw=function(a){this.drawManager.Draw(a,this.camera)},Mario.LoseState.prototype.CheckForChange=function(a){this.wasKeyDown&&!Enjine.KeyboardInput.IsKeyDown(Enjine.Keys.S)&&a.ChangeState(new Mario.TitleState)},Mario.WinState=function(){this.waitTime=2,this.drawManager=null,this.camera=null,this.font=null,this.kissing=null,this.wasKeyDown=!1},Mario.WinState.prototype=new Enjine.GameState,Mario.WinState.prototype.Enter=function(){this.drawManager=new Enjine.DrawableManager,this.camera=new Enjine.Camera,this.font=Mario.SpriteCuts.CreateBlackFont(),this.font.Strings[0]={String:"Thank you for saving me, Mario!",X:36,Y:160},this.kissing=new Enjine.AnimatedSprite,this.kissing.Image=Enjine.Resources.Images.endScene,this.kissing.X=112,this.kissing.Y=52,this.kissing.SetColumnCount(2),this.kissing.SetRowCount(1),this.kissing.AddNewSequence("loop",0,0,0,1),this.kissing.PlaySequence("loop",!0),this.kissing.FramesPerSecond=.5,this.waitTime=2,this.drawManager.Add(this.font),this.drawManager.Add(this.kissing)},Mario.WinState.prototype.Exit=function(){this.drawManager.Clear(),delete this.drawManager,delete this.camera},Mario.WinState.prototype.Update=function(a){this.drawManager.Update(a),this.waitTime>0?this.waitTime-=a:Enjine.KeyboardInput.IsKeyDown(Enjine.Keys.S)&&(this.wasKeyDown=!0)},Mario.WinState.prototype.Draw=function(a){this.drawManager.Draw(a,this.camera)},Mario.WinState.prototype.CheckForChange=function(a){this.waitTime<=0&&this.wasKeyDown&&!Enjine.KeyboardInput.IsKeyDown(Enjine.Keys.S)&&a.ChangeState(new Mario.TitleState)},Mario.MapTile={Grass:0,Water:1,Level:2,Road:3,Decoration:4},Mario.MapState=function(){this.camera=new Enjine.Camera,this.Level=[],this.Data=[],this.XMario=0,this.YMario=0,this.XMarioA=0,this.YMarioA=0,this.MoveTime=0,this.LevelId=0,this.Farthest=0,this.XFarthestCap=0,this.YFarthestCap=0,this.MapImage=document.createElement("canvas"),this.MapImage.width=320,this.MapImage.height=240,this.MapContext=this.MapImage.getContext("2d"),this.CanEnterLevel=!1,this.EnterLevel=!1,this.LevelDifficulty=0,this.LevelType=0,this.WorldNumber=-1,this.NextWorld()},Mario.MapState.prototype=new Enjine.GameState,Mario.MapState.prototype.Enter=function(){this.WaterSprite=new Enjine.AnimatedSprite,this.WaterSprite.Image=Enjine.Resources.Images.worldMap,this.WaterSprite.SetColumnCount(16),this.WaterSprite.SetRowCount(16),this.WaterSprite.AddNewSequence("loop",14,0,14,3),this.WaterSprite.FramesPerSecond=1/3,this.WaterSprite.PlaySequence("loop",!0),this.WaterSprite.X=0,this.WaterSprite.Y=0,this.DecoSprite=new Enjine.AnimatedSprite,this.DecoSprite.Image=Enjine.Resources.Images.worldMap,this.DecoSprite.SetColumnCount(16),this.DecoSprite.SetRowCount(16),this.DecoSprite.AddNewSequence("world0",10,0,10,3),this.DecoSprite.AddNewSequence("world1",11,0,11,3),this.DecoSprite.AddNewSequence("world2",12,0,12,3),this.DecoSprite.AddNewSequence("world3",13,0,13,3),this.DecoSprite.FramesPerSecond=1/3,this.DecoSprite.PlaySequence("world0",!0),this.DecoSprite.X=0,this.DecoSprite.Y=0,this.HelpSprite=new Enjine.AnimatedSprite,this.HelpSprite.Image=Enjine.Resources.Images.worldMap,this.HelpSprite.SetColumnCount(16),this.HelpSprite.SetRowCount(16),this.HelpSprite.AddNewSequence("help",7,3,7,5),this.HelpSprite.FramesPerSecond=.5,this.HelpSprite.PlaySequence("help",!0),this.HelpSprite.X=0,this.HelpSprite.Y=0,this.SmallMario=new Enjine.AnimatedSprite,this.SmallMario.Image=Enjine.Resources.Images.worldMap,this.SmallMario.SetColumnCount(16),this.SmallMario.SetRowCount(16),this.SmallMario.AddNewSequence("small",1,0,1,1),this.SmallMario.FramesPerSecond=1/3,this.SmallMario.PlaySequence("small",!0),this.SmallMario.X=0,this.SmallMario.Y=0,this.LargeMario=new Enjine.AnimatedSprite,this.LargeMario.Image=Enjine.Resources.Images.worldMap,this.LargeMario.SetColumnCount(16),this.LargeMario.SetRowCount(8),this.LargeMario.AddNewSequence("large",0,2,0,3),this.LargeMario.AddNewSequence("fire",0,4,0,5),this.LargeMario.FramesPerSecond=1/3,this.LargeMario.PlaySequence("large",!0),this.LargeMario.X=0,this.LargeMario.Y=0,this.FontShadow=Mario.SpriteCuts.CreateBlackFont(),this.Font=Mario.SpriteCuts.CreateWhiteFont(),this.DecoSprite.PlaySequence("world"+this.WorldNumber%4,!0),Mario.MarioCharacter.Fire?this.LargeMario.PlaySequence("fire",!0):this.LargeMario.PlaySequence("large",!0),this.EnterLevel=!1,this.LevelDifficulty=0,this.LevelType=0},Mario.MapState.prototype.Exit=function(){delete this.WaterSprite,delete this.DecoSprite,delete this.HelpSprite,delete this.SmallMario,delete this.LargeMario,delete this.FontShadow,delete this.Font},Mario.MapState.prototype.NextWorld=function(){var a=!1;if(this.WorldNumber++,8!==this.WorldNumber){for(this.MoveTime=0,this.LevelId=0,this.Farthest=0,this.XFarthestCap=0,this.YFarthestCap=0;!a;)a=this.GenerateLevel();this.RenderStatic()}},Mario.MapState.prototype.GenerateLevel=function(){var a=0,b=0,c=0,d=0,e=0,f=0,g=new Mario.ImprovedNoise(0|0x8000000000000000*Math.random()),h=new Mario.ImprovedNoise(0|0x8000000000000000*Math.random()),i=new Mario.ImprovedNoise(0|0x8000000000000000*Math.random()),j=21,k=16;this.Level=[],this.Data=[];var l=512*Math.random(),m=512*Math.random(),n=512*Math.random(),o=512*Math.random();for(a=0;j>a;a++)for(this.Level[a]=[],this.Data[a]=[],b=0;k>b;b++)c=g.PerlinNoise(10*a+l,10*b+m),d=h.PerlinNoise(10*a+n,10*b+o),e=c-d,f=2*e,this.Level[a][b]=f>0?Mario.MapTile.Water:Mario.MapTile.Grass;var p=9999,q=9999,r=0;for(f=0,r=0;100>r&&12>f;r++)a=3*(0|Math.random()*(0|(j-1)/3))+2,b=3*(0|Math.random()*(0|(k-1)/3))+1,this.Level[a][b]===Mario.MapTile.Grass&&(p>a&&(p=a,q=b),this.Level[a][b]=Mario.MapTile.Level,this.Data[a][b]=-1,f++);this.Data[p][q]=-2;for(var s=!0;s;)s=this.FindConnection(j,k);if(this.FindCaps(j,k),0===this.XFarthestCap)return!1;for(this.Data[this.XFarthestCap][this.YFarthestCap]=-2,this.Data[0|this.XMario/16][0|this.YMario/16]=-11,a=0;j>a;a++)for(b=0;k>b;b++)this.Level[a][b]!==Mario.MapTile.Grass||a===this.XFarthestCap&&b===this.YFarthestCap-1||(c=i.PerlinNoise(10*a+l,10*b+m),c>0&&(this.Level[a][b]=Mario.MapTile.Decoration));return!0},Mario.MapState.prototype.FindConnection=function(a,b){var c=0,d=0;for(c=0;a>c;c++)for(d=0;b>d;d++)if(this.Level[c][d]===Mario.MapTile.Level&&-1===this.Data[c][d])return this.Connect(c,d,a,b),!0;return!1},Mario.MapState.prototype.Connect=function(a,b,c,d){var e=1e4,f=0,g=0,h=0,i=0,j=0,k=0,l=0;for(h=0;c>h;h++)for(i=0;d>i;i++)this.Level[h][i]===Mario.MapTile.Level&&-2===this.Data[h][i]&&(j=0|Math.abs(a-h),k=0|Math.abs(b-i),l=j*j+k*k,e>l&&(f=h,g=i,e=l));this.DrawRoad(a,b,f,g),this.Level[a][b]=Mario.MapTile.Level,this.Data[a][b]=-2},Mario.MapState.prototype.DrawRoad=function(a,b,c,d){var e=!1;if(Math.random()>.5&&(e=!0),e){for(;a>c;)this.Data[a][b]=0,this.Level[a--][b]=Mario.MapTile.Road;for(;c>a;)this.Data[a][b]=0,this.Level[a++][b]=Mario.MapTile.Road}for(;b>d;)this.Data[a][b]=0,this.Level[a][b--]=Mario.MapTile.Road;for(;d>b;)this.Data[a][b]=0,this.Level[a][b++]=Mario.MapTile.Road;if(!e){for(;a>c;)this.Data[a][b]=0,this.Level[a--][b]=Mario.MapTile.Road;for(;c>a;)this.Data[a][b]=0,this.Level[a++][b]=Mario.MapTile.Road}},Mario.MapState.prototype.FindCaps=function(a,b){var c=0,d=0,e=-1,f=-1,g=0,h=0,i=0;for(c=0;a>c;c++)for(d=0;b>d;d++)if(this.Level[c][d]===Mario.MapTile.Level){for(g=0,h=c-1;c+1>=h;h++)for(i=d-1;d+1>=i;i++)this.Level[h][i]===Mario.MapTile.Road&&g++;1===g?(-1===e&&(e=c,f=d),this.Data[c][d]=0):this.Data[c][d]=1}this.XMario=16*e,this.YMario=16*f,this.Travel(e,f,-1,0)},Mario.MapState.prototype.Travel=function(a,b,c,d){if(this.Level[a][b]===Mario.MapTile.Road||this.Level[a][b]===Mario.MapTile.Level){if(this.Level[a][b]===Mario.MapTile.Road){if(1===this.Data[a][b])return;
this.Data[a][b]=1}this.Level[a][b]===Mario.MapTile.Level&&(this.Data[a][b]>0?this.Data[a][b]=0!==this.LevelId&&0===(0|4*Math.random())?-3:++this.LevelId:d>0&&(this.Data[a][b]=-1,d>this.Farthest&&(this.Farthest=d,this.XFarthestCap=a,this.YFarthestCap=b))),2!==c&&this.Travel(a-1,b,0,d++),3!==c&&this.Travel(a,b-1,1,d++),0!==c&&this.Travel(a+1,b,2,d++),1!==c&&this.Travel(a,b+1,3,d++)}},Mario.MapState.prototype.RenderStatic=function(){var a=0,b=0,c=0,d=0,e=0,f=0,g=0,h=0,i=0,j=Enjine.Resources.Images.worldMap,k=0;for(a=0;20>a;a++)for(b=0;15>b;b++)if(this.MapContext.drawImage(j,16*(0|this.WorldNumber/4),0,16,16,16*a,16*b,16,16),this.Level[a][b]===Mario.MapTile.Level)k=this.Data[a][b],0===k?this.MapContext.drawImage(j,0,112,16,16,16*a,16*b,16,16):-1===k?this.MapContext.drawImage(j,48,128,16,16,16*a,16*b,16,16):-3===k?this.MapContext.drawImage(j,0,128,16,16,16*a,16*b,16,16):-10===k?this.MapContext.drawImage(j,16,128,16,16,16*a,16*b,16,16):-11===k?this.MapContext.drawImage(j,16,112,16,16,16*a,16*b,16,16):-2===k?(this.MapContext.drawImage(j,32,112,16,16,16*a,16*(b-1),16,16),this.MapContext.drawImage(j,32,128,16,16,16*a,16*b,16,16)):this.MapContext.drawImage(j,16*(k-1),96,16,16,16*a,16*b,16,16);else if(this.Level[a][b]===Mario.MapTile.Road)c=this.IsRoad(a-1,b)?1:0,d=this.IsRoad(a,b-1)?1:0,e=this.IsRoad(a+1,b)?1:0,f=this.IsRoad(a,b+1)?1:0,g=c+2*d+4*e+8*f,this.MapContext.drawImage(j,16*g,32,16,16,16*a,16*b,16,16);else if(this.Level[a][b]===Mario.MapTile.Water)for(h=0;2>h;h++)for(i=0;2>i;i++)c=this.IsWater(2*a+(h-1),2*b+(i-1))?0:1,d=this.IsWater(2*a+h,2*b+(i-1))?0:1,e=this.IsWater(2*a+(h-1),2*b+i)?0:1,f=this.IsWater(2*a+h,2*b+i)?0:1,g=c+2*d+4*e+8*f-1,g>=0&&14>=g&&this.MapContext.drawImage(j,16*g,16*(4+(1&h+i)),16,16,16*a+8*h,16*b+8*i,16,16)},Mario.MapState.prototype.IsRoad=function(a,b){return 0>a&&(a=0),0>b&&(b=0),this.Level[a][b]===Mario.MapTile.Road?!0:this.Level[a][b]===Mario.MapTile.Level?!0:!1},Mario.MapState.prototype.IsWater=function(a,b){var c=0,d=0;for(0>a&&(a=0),0>b&&(b=0),c=0;2>c;c++)for(d=0;2>d;d++)if(this.Level[0|(a+c)/2][0|(b+d)/2]!==Mario.MapTile.Water)return!1;return!0},Mario.MapState.prototype.Update=function(a){var b=0,c=0,d=0,e=0;8!==this.WorldNumber&&(this.XMario+=this.XMarioA,this.YMario+=this.YMarioA,b=0|this.XMario/16,c=0|this.YMario/16,this.Level[b][c]===Mario.MapTile.Road&&(this.Data[b][c]=0),this.MoveTime>0?this.MoveTime--:(this.XMarioA=0,this.YMarioA=0,this.CanEnterLevel&&Enjine.KeyboardInput.IsKeyDown(Enjine.Keys.S)&&this.Level[b][c]===Mario.MapTile.Level&&-11!==this.Data[b][c]&&this.Level[b][c]===Mario.MapTile.Level&&0!==this.Data[b][c]&&this.Data[b][c]>-10&&(d=this.WorldNumber+1,Mario.MarioCharacter.LevelString=d+"-",e=Mario.LevelType.Overground,this.Data[b][c]>1&&0===(0|3*Math.random())&&(e=Mario.LevelType.Underground),this.Data[b][c]<0?(-2===this.Data[b][c]?(Mario.MarioCharacter.LevelString+="X",d+=2):-1===this.Data[b][c]?Mario.MarioCharacter.LevelString+="?":(Mario.MarioCharacter.LevelString+="#",d+=1),e=Mario.LevelType.Castle):Mario.MarioCharacter.LevelString+=this.Data[b][c],this.EnterLevel=!0,this.LevelDifficulty=d,this.LevelType=e),this.CanEnterLevel=!Enjine.KeyboardInput.IsKeyDown(Enjine.Keys.S),Enjine.KeyboardInput.IsKeyDown(Enjine.Keys.Left)&&this.TryWalking(-1,0),Enjine.KeyboardInput.IsKeyDown(Enjine.Keys.Right)&&this.TryWalking(1,0),Enjine.KeyboardInput.IsKeyDown(Enjine.Keys.Up)&&this.TryWalking(0,-1),Enjine.KeyboardInput.IsKeyDown(Enjine.Keys.Down)&&this.TryWalking(0,1)),this.WaterSprite.Update(a),this.DecoSprite.Update(a),this.HelpSprite.Update(a),Mario.MarioCharacter.Large?(this.LargeMario.X=0|this.XMario+this.XMarioA*a,this.LargeMario.Y=this.YMario+(0|this.YMarioA*a)-22,this.LargeMario.Update(a)):(this.SmallMario.X=0|this.XMario+this.XMarioA*a,this.SmallMario.Y=this.YMario+(0|this.YMarioA*a)-6,this.SmallMario.Update(a)))},Mario.MapState.prototype.TryWalking=function(a,b){var c=0|this.XMario/16,d=0|this.YMario/16,e=c+a,f=d+b;if(this.Level[e][f]===Mario.MapTile.Road||this.Level[e][f]===Mario.MapTile.Level){if(this.Level[e][f]===Mario.MapTile.Road&&0!==this.Data[e][f]&&0!==this.Data[c][d]&&this.Data[c][d]>-10)return;this.XMarioA=8*a,this.YMarioA=8*b,this.MoveTime=2*this.CalcDistance(c,d,a,b)+1}},Mario.MapState.prototype.CalcDistance=function(a,b,c,d){for(var e=0;;){if(a+=c,b+=d,this.Level[a][b]!==Mario.MapTile.Road)return e;if(this.Level[a-d][b+c]===Mario.MapTile.Road)return e;if(this.Level[a+d][b-c]===Mario.MapTile.Road)return e;e++}},Mario.MapState.prototype.Draw=function(a){var b=0,c=0;if(8!==this.WorldNumber){for(a.drawImage(this.MapImage,0,0),c=0;15>=c;c++)for(b=20;b>=0;b--)this.Level[b][c]===Mario.MapTile.Water?this.IsWater(2*b-1,2*c-1)&&(this.WaterSprite.X=16*b-8,this.WaterSprite.Y=16*c-8,this.WaterSprite.Draw(a,this.camera)):this.Level[b][c]===Mario.MapTile.Decoration?(this.DecoSprite.X=16*b,this.DecoSprite.Y=16*c,this.DecoSprite.Draw(a,this.camera)):this.Level[b][c]===Mario.MapTile.Level&&-2===this.Data[b][c]&&(this.HelpSprite.X=16*b+16,this.HelpSprite.Y=16*c-16,this.HelpSprite.Draw(a,this.camera));Mario.MarioCharacter.Large?this.LargeMario.Draw(a,this.camera):this.SmallMario.Draw(a,this.camera),this.Font.Strings[0]={String:"MARIO "+Mario.MarioCharacter.Lives,X:4,Y:4},this.FontShadow.Strings[0]={String:"MARIO "+Mario.MarioCharacter.Lives,X:5,Y:5},this.Font.Strings[1]={String:"WORLD "+(this.WorldNumber+1),X:256,Y:4},this.FontShadow.Strings[1]={String:"WORLD "+(this.WorldNumber+1),X:257,Y:5},this.FontShadow.Draw(a,this.camera),this.Font.Draw(a,this.camera)}},Mario.MapState.prototype.LevelWon=function(){var a=this.XMario/16,b=this.YMario/16;return-2===this.Data[a][b]?(this.NextWorld(),void 0):(this.Data[a][b]=-3!==this.Data[a][b]?0:-10,this.RenderStatic(),void 0)},Mario.MapState.prototype.GetX=function(){return 160},Mario.MapState.prototype.GetY=function(){return 120},Mario.MapState.prototype.CheckForChange=function(a){8===this.WorldNumber&&a.ChangeState(new Mario.WinState),this.EnterLevel&&a.ChangeState(new Mario.LevelState(this.LevelDifficulty,this.LevelType))},Mario.LevelState=function(a,b){this.LevelDifficulty=a,this.LevelType=b,this.Level=null,this.Layer=null,this.BgLayer=[],this.Paused=!1,this.Sprites=null,this.SpritesToAdd=null,this.SpritesToRemove=null,this.Camera=null,this.ShellsToCheck=null,this.FireballsToCheck=null,this.FontShadow=null,this.Font=null,this.TimeLeft=0,this.StartTime=0,this.FireballsOnScreen=0,this.Tick=0,this.Delta=0,this.GotoMapState=!1,this.GotoLoseState=!1},Mario.LevelState.prototype=new Enjine.GameState,Mario.LevelState.prototype.Enter=function(){var a=new Mario.LevelGenerator(320,15),b=0,c=0,d=0,e=0,f=null;for(this.Level=a.CreateLevel(this.LevelType,this.LevelDifficulty),this.Paused=!1,this.Layer=new Mario.LevelRenderer(this.Level,320,240),this.Sprites=new Enjine.DrawableManager,this.Camera=new Enjine.Camera,this.Tick=0,this.ShellsToCheck=[],this.FireballsToCheck=[],this.SpritesToAdd=[],this.SpritesToRemove=[],this.FontShadow=Mario.SpriteCuts.CreateBlackFont(),this.Font=Mario.SpriteCuts.CreateWhiteFont(),b=0;2>b;b++)c=4>>b,d=(0|(16*this.Level.Width-320)/c)+320,e=(0|(16*this.Level.Height-240)/c)+240,f=new Mario.BackgroundGenerator(d/32+1,e/32+1,0===b,this.LevelType),this.BgLayer[b]=new Mario.BackgroundRenderer(f.CreateLevel(),320,240,c);Mario.MarioCharacter.Initialize(this),this.Sprites.Add(Mario.MarioCharacter),this.StartTime=1,this.TimeLeft=200,this.GotoMapState=!1,this.GotoLoseState=!1},Mario.LevelState.prototype.Exit=function(){delete this.Level,delete this.Layer,delete this.BgLayer,delete this.Sprites,delete this.Camera,delete this.ShellsToCheck,delete this.FireballsToCheck,delete this.FontShadow,delete this.Font},Mario.LevelState.prototype.CheckShellCollide=function(a){this.ShellsToCheck.push(a)},Mario.LevelState.prototype.CheckFireballCollide=function(a){this.FireballsToCheck.push(a)},Mario.LevelState.prototype.Update=function(a){var b=0,c=0,d=0,e=0,f=null,g=!1,h=0,i=0,j=0,k=0,l=null,m=0;for(this.Delta=a,this.TimeLeft-=a,0===(0|this.TimeLeft)&&Mario.MarioCharacter.Die(),this.StartTime>0&&this.StartTime++,this.Camera.X=Mario.MarioCharacter.X-160,this.Camera.X<0&&(this.Camera.X=0),this.Camera.X>16*this.Level.Width-320&&(this.Camera.X=16*this.Level.Width-320),this.FireballsOnScreen=0,b=0;b<this.Sprites.Objects.length;b++)f=this.Sprites.Objects[b],f!==Mario.MarioCharacter&&(d=f.X-this.Camera.X,e=f.Y-this.Camera.Y,-64>d||d>384||-64>e||e>304?this.Sprites.RemoveAt(b):f instanceof Mario.Fireball&&this.FireballsOnScreen++);if(this.Paused)for(b=0;b<this.Sprites.Objects.length;b++)this.Sprites.Objects[b]===Mario.MarioCharacter?this.Sprites.Objects[b].Update(a):this.Sprites.Objects[b].UpdateNoMove(a);else{for(this.Layer.Update(a),this.Level.Update(),g=!1,h=0,this.Tick++,i=(0|this.Camera.X/16)-1;i<=(0|(this.Camera.X+this.Layer.Width)/16)+1;i++)for(j=(0|this.Camera.Y/16)-1;j<=(0|(this.Camera.Y+this.Layer.Height)/16)+1;j++)if(k=0,16*i+8>Mario.MarioCharacter.X+16&&(k=-1),16*i+8<Mario.MarioCharacter.X-16&&(k=1),l=this.Level.GetSpriteTemplate(i,j),null!==l&&(l.LastVisibleTick!==this.Tick-1&&(null!==l.Sprite&&this.Sprites.Contains(l.Sprite)||l.Spawn(this,i,j,k)),l.LastVisibleTick=this.Tick),0!==k&&(m=this.Level.GetBlock(i,j),(Mario.Tile.Behaviors[255&m]&Mario.Tile.Animated)>0&&3===(0|m%16/4)&&0===(0|m/16)&&0===(this.Tick-2*i)%100)){for(h=i,b=0;8>b;b++)this.AddSprite(new Mario.Sparkle(this,16*i+8,16*j+(0|16*Math.random()),Math.random()*k,0,0,1,5));this.AddSprite(new Mario.BulletBill(this,16*i+8+8*k,16*j+15,k)),g=!0}for(g&&Enjine.Resources.PlaySound("cannon"),b=0;b<this.Sprites.Objects.length;b++)this.Sprites.Objects[b].Update(a);for(b=0;b<this.Sprites.Objects.length;b++)this.Sprites.Objects[b].CollideCheck();for(b=0;b<this.ShellsToCheck.length;b++)for(c=0;c<this.Sprites.Objects.length;c++)this.Sprites.Objects[c]===this.ShellsToCheck[b]||this.ShellsToCheck[b].Dead||this.Sprites.Objects[c].ShellCollideCheck(this.ShellsToCheck[b])&&(Mario.MarioCharacter.Carried!==this.ShellsToCheck[b]||this.ShellsToCheck[b].Dead||(Mario.MarioCharacter.Carried=null,this.ShellsToCheck[b].Die()));for(this.ShellsToCheck.length=0,b=0;b<this.FireballsToCheck.length;b++)for(c=0;c<this.Sprites.Objects.length;c++)this.Sprites.Objects[c]===this.FireballsToCheck[b]||this.FireballsToCheck[b].Dead||this.Sprites.Objects[c].FireballCollideCheck(this.FireballsToCheck[b])&&this.FireballsToCheck[b].Die();this.FireballsToCheck.length=0}this.Sprites.AddRange(this.SpritesToAdd),this.Sprites.RemoveList(this.SpritesToRemove),this.SpritesToAdd.length=0,this.SpritesToRemove.length=0,this.Camera.X=Mario.MarioCharacter.XOld+(Mario.MarioCharacter.X-Mario.MarioCharacter.XOld)*a-160,this.Camera.Y=Mario.MarioCharacter.YOld+(Mario.MarioCharacter.Y-Mario.MarioCharacter.YOld)*a-120},Mario.LevelState.prototype.Draw=function(a){var b=0,c=0,d=0;for(this.Camera.X<0&&(this.Camera.X=0),this.Camera.Y<0&&(this.Camera.Y=0),this.Camera.X>16*this.Level.Width-320&&(this.Camera.X=16*this.Level.Width-320),this.Camera.Y>16*this.Level.Height-240&&(this.Camera.Y=16*this.Level.Height-240),b=0;2>b;b++)this.BgLayer[b].Draw(a,this.Camera);for(a.save(),a.translate(-this.Camera.X,-this.Camera.Y),b=0;b<this.Sprites.Objects.length;b++)0===this.Sprites.Objects[b].Layer&&this.Sprites.Objects[b].Draw(a,this.Camera);for(a.restore(),this.Layer.Draw(a,this.Camera),this.Layer.DrawExit0(a,this.Camera,0===Mario.MarioCharacter.WinTime),a.save(),a.translate(-this.Camera.X,-this.Camera.Y),b=0;b<this.Sprites.Objects.length;b++)1===this.Sprites.Objects[b].Layer&&this.Sprites.Objects[b].Draw(a,this.Camera);a.restore(),this.Layer.DrawExit1(a,this.Camera),this.DrawStringShadow(a,"MARIO "+Mario.MarioCharacter.Lives,0,0),this.DrawStringShadow(a,"00000000",0,1),this.DrawStringShadow(a,"COIN",14,0),this.DrawStringShadow(a," "+Mario.MarioCharacter.Coins,14,1),this.DrawStringShadow(a,"WORLD",24,0),this.DrawStringShadow(a," "+Mario.MarioCharacter.LevelString,24,1),this.DrawStringShadow(a,"TIME",34,0),c=0|this.TimeLeft,0>c&&(c=0),this.DrawStringShadow(a," "+c,34,1),this.StartTime>0&&(d=this.StartTime+this.Delta-2,d=.6*d*d,this.RenderBlackout(a,160,120,0|d)),Mario.MarioCharacter.WinTime>0&&(d=Mario.MarioCharacter.WinTime+this.Delta,d=.2*d*d,d>900&&(Mario.GlobalMapState.LevelWon(),this.GotoMapState=!0),this.RenderBlackout(a,0|Mario.MarioCharacter.XDeathPos-this.Camera.X,0|Mario.MarioCharacter.YDeathPos-this.Camera.Y,0|320-d)),Mario.MarioCharacter.DeathTime>0&&(d=Mario.MarioCharacter.DeathTime+this.Delta,d=.1*d*d,d>900&&(Mario.MarioCharacter.Lives--,this.GotoMapState=!0,Mario.MarioCharacter.Lives<=0&&(this.GotoLoseState=!0)),this.RenderBlackout(a,0|Mario.MarioCharacter.XDeathPos-this.Camera.X,0|Mario.MarioCharacter.YDeathPos-this.Camera.Y,0|320-d))},Mario.LevelState.prototype.DrawStringShadow=function(a,b,c,d){this.Font.Strings[0]={String:b,X:8*c+4,Y:8*d+4},this.FontShadow.Strings[0]={String:b,X:8*c+5,Y:8*d+5},this.FontShadow.Draw(a,this.Camera),this.Font.Draw(a,this.Camera)},Mario.LevelState.prototype.RenderBlackout=function(a,b,c,d){if(!(d>320)){var e=[],f=[],g=0;for(g=0;16>g;g++)e[g]=0|b+Math.cos(g*Math.PI/15)*d,f[g]=0|c+Math.sin(g*Math.PI/15)*d;for(e[16]=0,f[16]=c,e[17]=0,f[17]=240,e[18]=320,f[18]=240,e[19]=320,f[19]=c,a.fillStyle="#000",a.beginPath(),a.moveTo(e[19],f[19]),g=18;g>=0;g--)a.lineTo(e[g],f[g]);for(a.closePath(),a.fill(),g=0;16>g;g++)e[g]=0|b-Math.cos(g*Math.PI/15)*d,f[g]=0|c-Math.sin(g*Math.PI/15)*d;for(f[15]+=5,e[16]=320,f[16]=c,e[17]=320,f[17]=0,e[18]=0,f[18]=0,e[19]=0,f[19]=c,a.fillStyle="#000",a.beginPath(),a.moveTo(e[0],f[0]),g=0;g<=e.length-1;g++)a.lineTo(e[g],f[g]);a.closePath(),a.fill()}},Mario.LevelState.prototype.AddSprite=function(a){this.Sprites.Add(a)},Mario.LevelState.prototype.RemoveSprite=function(a){this.Sprites.Remove(a)},Mario.LevelState.prototype.Bump=function(a,b,c){var d=this.Level.GetBlock(a,b),e=0,f=0;if((Mario.Tile.Behaviors[255&d]&Mario.Tile.Bumpable)>0&&(this.BumpInto(a,b-1),this.Level.SetBlock(a,b,4),this.Level.SetBlockData(a,b,4),(Mario.Tile.Behaviors[255&d]&Mario.Tile.Special)>0?(Enjine.Resources.PlaySound("sprout"),Mario.MarioCharacter.Large?this.AddSprite(new Mario.FireFlower(this,16*a+8,16*b+8)):this.AddSprite(new Mario.Mushroom(this,16*a+8,16*b+8))):(Mario.MarioCharacter.GetCoin(),Enjine.Resources.PlaySound("coin"),this.AddSprite(new Mario.CoinAnim(this,a,b)))),(Mario.Tile.Behaviors[255&d]&Mario.Tile.Breakable)>0&&(this.BumpInto(a,b-1),c))for(Enjine.Resources.PlaySound("breakblock"),this.Level.SetBlock(a,b,0),e=0;2>e;e++)for(f=0;2>f;f++)this.AddSprite(new Mario.Particle(this,16*a+8*e+4,16*b+8*f+4,4*(2*e-1),4*(2*f-1)-8))},Mario.LevelState.prototype.BumpInto=function(a,b){var c=this.Level.GetBlock(a,b),d=0;for((Mario.Tile.Behaviors[255&c]&Mario.Tile.PickUpable)>0&&(Mario.MarioCharacter.GetCoin(),Enjine.Resources.PlaySound("coin"),this.Level.SetBlock(a,b,0),this.AddSprite(new Mario.CoinAnim(a,b+1))),d=0;d<this.Sprites.Objects.length;d++)this.Sprites.Objects[d].BumpCheck(a,b)},Mario.LevelState.prototype.CheckForChange=function(a){this.GotoLoseState?a.ChangeState(new Mario.LoseState):this.GotoMapState&&a.ChangeState(Mario.GlobalMapState)};
var Mario={};Mario.SpriteCuts={CreateBlackFont:function(){return new Enjine.SpriteFont([],Enjine.Resources.Images.font,8,8,this.GetCharArray(0))},CreateRedFont:function(){return new Enjine.SpriteFont([],Enjine.Resources.Images.font,8,8,this.GetCharArray(8))},CreateGreenFont:function(){return new Enjine.SpriteFont([],Enjine.Resources.Images.font,8,8,this.GetCharArray(16))},CreateBlueFont:function(){return new Enjine.SpriteFont([],Enjine.Resources.Images.font,8,8,this.GetCharArray(24))},CreateYellowFont:function(){return new Enjine.SpriteFont([],Enjine.Resources.Images.font,8,8,this.GetCharArray(32))},CreatePinkFont:function(){return new Enjine.SpriteFont([],Enjine.Resources.Images.font,8,8,this.GetCharArray(40))},CreateCyanFont:function(){return new Enjine.SpriteFont([],Enjine.Resources.Images.font,8,8,this.GetCharArray(48))},CreateWhiteFont:function(){return new Enjine.SpriteFont([],Enjine.Resources.Images.font,8,8,this.GetCharArray(56))},GetCharArray:function(i){var t=[],e=0;for(e=32;127>e;e++)t[e]={X:8*(e-32),Y:i};return t},GetBackgroundSheet:function(){var i=[],t=0,e=0,s=Enjine.Resources.Images.background.width/32,h=Enjine.Resources.Images.background.height/32;for(t=0;s>t;t++)for(i[t]=[],e=0;h>e;e++)i[t][e]={X:32*t,Y:32*e,Width:32,Height:32};return i},GetLevelSheet:function(){var i=[],t=0,e=0,s=Enjine.Resources.Images.map.width/16,h=Enjine.Resources.Images.map.height/16;for(t=0;s>t;t++)for(i[t]=[],e=0;h>e;e++)i[t][e]={X:16*t,Y:16*e,Width:16,Height:16};return i}},Mario.Tile={BlockUpper:1,BlockAll:2,BlockLower:4,Special:8,Bumpable:16,Breakable:32,PickUpable:64,Animated:128,Behaviors:[],LoadBehaviors:function(){var i=[];i[0]=0,i[1]=20,i[2]=28,i[3]=0,i[4]=130,i[5]=130,i[6]=130,i[7]=130,i[8]=2,i[9]=2,i[10]=2,i[11]=2,i[12]=2,i[13]=0,i[14]=138,i[15]=0,i[16]=162,i[17]=146,i[18]=154,i[19]=162,i[20]=146,i[21]=146,i[22]=154,i[23]=146,i[24]=2,i[25]=0,i[26]=2,i[27]=2,i[28]=2,i[29]=0,i[30]=2,i[31]=0,i[32]=192,i[33]=192,i[34]=192,i[35]=192,i[36]=0,i[37]=0,i[38]=0,i[39]=0,i[40]=2,i[41]=2,i[42]=0,i[43]=0,i[44]=0,i[45]=0,i[46]=2,i[47]=0,i[48]=0,i[49]=0,i[50]=0,i[51]=0,i[52]=0,i[53]=0,i[54]=0,i[55]=0,i[56]=2,i[57]=2;var t=0;for(t=58;128>t;t++)i[t]=0;for(i[128]=2,i[129]=2,i[130]=2,i[131]=0,i[132]=1,i[133]=1,i[134]=1,i[135]=0,i[136]=2,i[137]=2,i[138]=2,i[139]=0,i[140]=2,i[141]=2,i[142]=2,i[143]=0,i[144]=2,i[145]=0,i[146]=2,i[147]=0,i[148]=0,i[149]=0,i[150]=0,i[151]=0,i[152]=2,i[153]=2,i[154]=2,i[155]=0,i[156]=2,i[157]=2,i[158]=2,i[159]=0,i[160]=2,i[161]=2,i[162]=2,i[163]=0,i[164]=0,i[165]=0,i[166]=0,i[167]=0,i[168]=2,i[169]=2,i[170]=2,i[171]=0,i[172]=2,i[173]=2,i[174]=2,i[175]=0,i[176]=2,i[177]=2,i[178]=2,i[179]=0,i[180]=1,i[181]=1,i[182]=1,t=183;224>t;t++)i[t]=0;for(i[224]=1,i[225]=1,i[226]=1,t=227;256>t;t++)i[t]=0;this.Behaviors=i}},Mario.LevelType={Overground:0,Underground:1,Castle:2},Mario.Odds={Straight:0,HillStraight:1,Tubes:2,Jump:3,Cannons:4},Mario.Level=function(i,t){this.Width=i,this.Height=t,this.ExitX=10,this.ExitY=10,this.Map=[],this.Data=[],this.SpriteTemplates=[];var e=0,s=0;for(e=0;this.Width>e;e++)for(this.Map[e]=[],this.Data[e]=[],this.SpriteTemplates[e]=[],s=0;this.Height>s;s++)this.Map[e][s]=0,this.Data[e][s]=0,this.SpriteTemplates[e][s]=null},Mario.Level.prototype={Update:function(){var i=0,t=0;for(i=0;this.Width>i;i++)for(t=0;this.Height>t;t++)this.Data[i][t]>0&&this.Data[i][t]--},GetBlockCapped:function(i,t){return 0>i&&(i=0),0>t&&(t=0),i>=this.Width&&(i=this.Width-1),t>=this.Height&&(t=this.Height-1),this.Map[i][t]},GetBlock:function(i,t){return 0>i&&(i=0),0>t?0:(i>=this.Width&&(i=this.Width-1),t>=this.Height&&(t=this.Height-1),this.Map[i][t])},SetBlock:function(i,t,e){0>i||0>t||i>=this.Width||t>=this.Height||(this.Map[i][t]=e)},SetBlockData:function(i,t,e){0>i||0>t||i>=this.Width||t>=this.Height||(this.Data[i][t]=e)},IsBlocking:function(i,t,e,s){var h=this.GetBlock(i,t),a=(Mario.Tile.Behaviors[255&h]&Mario.Tile.BlockAll)>0;return a|=s>0&&(Mario.Tile.Behaviors[255&h]&Mario.Tile.BlockUpper)>0,a|=0>s&&(Mario.Tile.Behaviors[255&h]&Mario.Tile.BlockLower)>0},GetSpriteTemplate:function(i,t){return 0>i?null:0>t?null:i>=this.Width?null:t>=this.Height?null:this.SpriteTemplates[i][t]},SetSpriteTemplate:function(i,t,e){0>i||0>t||i>=this.Width||t>=this.Height||(this.SpriteTemplates[i][t]=e)}},Mario.BackgroundGenerator=function(i,t,e,s){this.Width=i,this.Height=t,this.Distant=e,this.Type=s},Mario.BackgroundGenerator.prototype={SetValues:function(i,t,e,s){this.Width=i,this.Height=t,this.Distant=e,this.Type=s},CreateLevel:function(){var i=new Mario.Level(this.Width,this.Height);switch(this.Type){case Mario.LevelType.Overground:this.GenerateOverground(i);break;case Mario.LevelType.Underground:this.GenerateUnderground(i);break;case Mario.LevelType.Castle:this.GenerateCastle(i)}return i},GenerateOverground:function(i){var t=this.Distant?4:6,e=this.Distant?2:1,s=Math.floor(Math.random()*t)+e,h=Math.floor(Math.random()*t)+e,a=0,r=0,o=0,n=0,l=2;for(a=0;this.Width>a;a++){for(s=h;s===h;)h=Math.floor(Math.random()*t)+e;for(r=0;this.Height>r;r++)o=h>s?s:h,n=h>s?h:s,l=2,o>r?this.Distant?(l=2,2>r&&(l=r),i.SetBlock(a,r,4+8*l)):i.SetBlock(a,r,5):r===o?(l=o===h?0:1,l+=this.Distant?2:0,i.SetBlock(a,r,l)):r===n?(l=o===h?0:1,l+=this.Distant?2:0,i.SetBlock(a,r,l+16)):(l=r>n?1:0,o===s&&(l=1-l),l+=this.Distant?2:0,i.SetBlock(a,r,l+8))}},GenerateUnderground:function(i){var t=0,e=0,s=0,h=0;if(this.Distant){var a=0;for(t=0;this.Width>t;t++)for(.75>Math.random()&&(a=1-a),e=0;this.Height>e;e++)s=a,h=e-2,(0>h||h>4)&&(h=2,s=0),i.SetBlock(t,e,4+s+8*(3+h))}else for(t=0;this.Width>t;t++)for(e=0;this.Height>e;e++)s=t%2,h=e-1,(0>h||h>7)&&(h=7,s=0),0===s&&h>1&&5>h&&(s=-1,h=0),i.SetBlock(t,e,6+s+8*h)},GenerateCastle:function(i){var t=0,e=0,s=0,h=0;if(this.Distant)for(t=0;this.Width>t;t++)for(e=0;this.Height>e;e++)s=t%2,h=e-1,h>2&&5>h?h=2:h>=5&&(h-=2),0>h?(s=0,h=5):h>4?(s=1,h=5):1>s&&3===h?(s=0,h=3):1>s&&h>0&&3>h&&(s=0,h=2),i.SetBlock(t,e,1+s+8*(h+4));else for(t=0;this.Width>t;t++)for(e=0;this.Height>e;e++)s=t%3,h=e-1,h>2&&5>h?h=2:h>=5&&(h-=2),0>h?(s=1,h=5):h>4?(s=2,h=5):2>s&&4===h?(s=2,h=4):2>s&&h>0&&4>h&&(s=4,h=-3),i.SetBlock(t,e,1+s+8*(h+3))}},Mario.BackgroundRenderer=function(i,t,e,s){this.Level=i,this.Width=t,this.Distance=s,this.TilesY=(0|e/32)+1,this.Background=Mario.SpriteCuts.GetBackgroundSheet()},Mario.BackgroundRenderer.prototype=new Enjine.Drawable,Mario.BackgroundRenderer.prototype.Draw=function(i,t){var e=t.X/this.Distance,s=0,h=0,a=null,r=null,o=0|e/32,n=0|(e+this.Width)/32;for(s=o;n>=s;s++)for(h=0;this.TilesY>h;h++)a=255&this.Level.GetBlock(s,h),r=this.Background[a%8][0|a/8],i.drawImage(Enjine.Resources.Images.background,r.X,r.Y,r.Width,r.Height,0|(s<<5)-e,0|h<<5,r.Width,r.Height)},Mario.ImprovedNoise=function(i){this.P=[],this.Shuffle(i)},Mario.ImprovedNoise.prototype={Shuffle:function(){var i=[],t=0,e=0,s=0;for(t=0;256>t;t++)i[t]=t;for(t=0;256>t;t++)e=(0|255*Math.random())+t,s=i[t],i[t]=i[e],i[e]=s,this.P[t+256]=this.P[t]=i[t]},PerlinNoise:function(i,t){var e=0,s=0,h=0;for(e=0;8>e;e++)h=64/(1<<e),s+=this.Noise(i/h,t/h,128)/(1<<e);return s},Noise:function(i,t,e){var s=255&(0|i),h=255&(0|t),a=255&(0|e);i-=0|i,t-=0|t,e-=0|e;var r=this.Fade(i),o=this.Fade(t),n=this.Fade(e),l=this.P[s]+h,d=this.P[l]+a,c=this.P[l+1]+a,u=this.P[s+1]+h,p=this.P[u]+a,m=this.P[u+1]+a;return this.Lerp(n,this.Lerp(o,this.Lerp(r,this.Grad(this.P[d],i,t,e),this.Grad(this.P[p],i-1,t,e)),this.Lerp(r,this.Grad(this.P[c],i,t-1,e),this.Grad(this.P[m],i-1,t-1,e))),this.Lerp(o,this.Lerp(r,this.Grad(this.P[d+1],i,t,e-1),this.Grad(this.P[p+1],i-1,t,e-1)),this.Lerp(r,this.Grad(this.P[c+1],i,t-1,e-1),this.Grad(this.P[m+1],i-1,t-1,e-1))))},Fade:function(i){return i*i*i*(i*(6*i-15)+10)},Lerp:function(i,t,e){return t+i*(e-t)},Grad:function(i,t,e,s){var h=15&i,a=8>h?t:e,r=4>h?e:12===h||14===h?t:s;return(0===(1&h)?a:-a)+(0===(2&h)?r:-r)}},Mario.NotchSprite=function(i){this.XOld=0,this.YOld=0,this.X=0,this.Y=0,this.Xa=0,this.Ya=0,this.XPic=0,this.YPic=0,this.XPicO=0,this.YPicO=0,this.PicWidth=32,this.PicHeight=32,this.XFlip=!1,this.YFlip=!1,this.Visible=!0,this.Image=i,this.Delta=0,this.SpriteTemplate=null,this.Layer=1},Mario.NotchSprite.prototype=new Enjine.Drawable,Mario.NotchSprite.prototype.Draw=function(i){var t=0,e=0;this.Visible&&(t=(0|this.XOld+(this.X-this.XOld)*this.Delta)-this.XPicO,e=(0|this.YOld+(this.Y-this.YOld)*this.Delta)-this.YPicO,i.save(),i.scale(this.XFlip?-1:1,this.YFlip?-1:1),i.translate(this.XFlip?-320:0,this.YFlip?-240:0),i.drawImage(this.Image,this.XPic*this.PicWidth,this.YPic*this.PicHeight,this.PicWidth,this.PicHeight,this.XFlip?320-t-this.PicWidth:t,this.YFlip?240-e-this.PicHeight:e,this.PicWidth,this.PicHeight),i.restore())},Mario.NotchSprite.prototype.Update=function(i){this.XOld=this.X,this.YOld=this.Y,this.Move(),this.Delta=i},Mario.NotchSprite.prototype.UpdateNoMove=function(){this.XOld=this.X,this.YOld=this.Y,this.Delta=0},Mario.NotchSprite.prototype.Move=function(){this.X+=this.Xa,this.Y+=this.Ya},Mario.NotchSprite.prototype.GetX=function(i){return(0|this.XOld+(this.X-this.XOld)*i)-this.XPicO},Mario.NotchSprite.prototype.GetY=function(i){return(0|this.YOld+(this.Y-this.YOld)*i)-this.YPicO},Mario.NotchSprite.prototype.CollideCheck=function(){},Mario.NotchSprite.prototype.BumpCheck=function(){},Mario.NotchSprite.prototype.Release=function(){},Mario.NotchSprite.prototype.ShellCollideCheck=function(){return!1},Mario.NotchSprite.prototype.FireballCollideCheck=function(){return!1},Mario.Character=function(){this.Large=!1,this.Fire=!1,this.Coins=0,this.Lives=3,this.LevelString="none",this.GroundInertia=.89,this.AirInertia=.89,this.RunTime=0,this.WasOnGround=!1,this.OnGround=!1,this.MayJump=!1,this.Ducking=!1,this.Sliding=!1,this.JumpTime=0,this.XJumpSpeed=0,this.YJumpSpeed=0,this.CanShoot=!1,this.Width=4,this.Height=24,this.World=null,this.Facing=0,this.PowerUpTime=0,this.XDeathPos=0,this.YDeathPos=0,this.DeathTime=0,this.WinTime=0,this.InvulnerableTime=0,this.Carried=null,this.LastLarge=!1,this.LastFire=!1,this.NewLarge=!1,this.NewFire=!1},Mario.Character.prototype=new Mario.NotchSprite(null),Mario.Character.prototype.Initialize=function(i){this.World=i,this.X=32,this.Y=0,this.PowerUpTime=0,this.RunTime=0,this.WasOnGround=!1,this.OnGround=!1,this.MayJump=!1,this.Ducking=!1,this.Sliding=!1,this.JumpTime=0,this.XJumpSpeed=0,this.YJumpSpeed=0,this.CanShoot=!1,this.Width=4,this.Height=24,this.World=i,this.Facing=0,this.PowerUpTime=0,this.XDeathPos=0,this.YDeathPos=0,this.DeathTime=0,this.WinTime=0,this.InvulnerableTime=0,this.Carried=null,this.SetLarge(this.Large,this.Fire)},Mario.Character.prototype.SetLarge=function(i,t){t&&(i=!0),i||(t=!1),this.LastLarge=this.Large,this.LastFire=this.Fire,this.Large=i,this.Fire=t,this.NewLarge=this.Large,this.NewFire=this.Fire,this.Blink(!0)},Mario.Character.prototype.Blink=function(i){this.Large=i?this.NewLarge:this.LastLarge,this.Fire=i?this.NewFire:this.LastFire,this.Large?(this.Image=this.Fire?Enjine.Resources.Images.fireMario:Enjine.Resources.Images.mario,this.XPicO=16,this.YPicO=31,this.PicWidth=this.PicHeight=32):(this.Image=Enjine.Resources.Images.smallMario,this.XPicO=8,this.YPicO=15,this.PicWidth=this.PicHeight=16)},Mario.Character.prototype.Move=function(){if(this.WinTime>0)return this.WinTime++,this.Xa=0,this.Ya=0,void 0;if(this.DeathTime>0)return this.DeathTime++,11>this.DeathTime?(this.Xa=0,this.Ya=0):11===this.DeathTime?this.Ya=-15:this.Ya+=2,this.X+=this.Xa,this.Y+=this.Ya,void 0;if(0!==this.PowerUpTime)return this.PowerUpTime>0?(this.PowerUpTime--,this.Blink(0===(1&(0|this.PowerUpTime/3)))):(this.PowerUpTime++,this.Blink(0===(1&(0|-this.PowerUpTime/3)))),0===this.PowerUpTime&&(this.World.Paused=!1),this.CalcPic(),void 0;this.InvulnerableTime>0&&this.InvulnerableTime--,this.Visible=0===(1&(0|this.InvulerableTime/2)),this.WasOnGround=this.OnGround;var i=Enjine.KeyboardInput.IsKeyDown(Enjine.Keys.A)?1.2:.6;this.OnGround&&(this.Ducking=Enjine.KeyboardInput.IsKeyDown(Enjine.Keys.Down)&&this.Large?!0:!1),this.Xa>2&&(this.Facing=1),-2>this.Xa&&(this.Facing=-1),Enjine.KeyboardInput.IsKeyDown(Enjine.Keys.S)||0>this.JumpTime&&!this.OnGround&&!this.Sliding?0>this.JumpTime?(this.Xa=this.XJumpSpeed,this.Ya=-this.JumpTime*this.YJumpSpeed,this.JumpTime++):this.OnGround&&this.MayJump?(Enjine.Resources.PlaySound("jump"),this.XJumpSpeed=0,this.YJumpSpeed=-1.9,this.JumpTime=7,this.Ya=this.JumpTime*this.YJumpSpeed,this.OnGround=!1,this.Sliding=!1):this.Sliding&&this.MayJump?(Enjine.Resources.PlaySound("jump"),this.XJumpSpeed=6*-this.Facing,this.YJumpSpeed=-2,this.JumpTime=-6,this.Xa=this.XJumpSpeed,this.Ya=-this.JumpTime*this.YJumpSpeed,this.OnGround=!1,this.Sliding=!1,this.Facing=-this.Facing):this.JumpTime>0&&(this.Xa+=this.XJumpSpeed,this.Ya=this.JumpTime*this.YJumpSpeed,this.JumpTime--):this.JumpTime=0,Enjine.KeyboardInput.IsKeyDown(Enjine.Keys.Left)&&!this.Ducking&&(1===this.Facing&&(this.Sliding=!1),this.Xa-=i,this.JumpTime>=0&&(this.Facing=-1)),Enjine.KeyboardInput.IsKeyDown(Enjine.Keys.Right)&&!this.Ducking&&(-1===this.Facing&&(this.Sliding=!1),this.Xa+=i,this.JumpTime>=0&&(this.Facing=1)),(!Enjine.KeyboardInput.IsKeyDown(Enjine.Keys.Left)&&!Enjine.KeyboardInput.IsKeyDown(Enjine.Keys.Right)||this.Ducking||0>this.Ya||this.OnGround)&&(this.Sliding=!1),Enjine.KeyboardInput.IsKeyDown(Enjine.Keys.A)&&this.CanShoot&&this.Fire&&2>this.World.FireballsOnScreen&&(Enjine.Resources.PlaySound("fireball"),this.World.AddSprite(new Mario.Fireball(this.World,this.X+6*this.Facing,this.Y-20,this.Facing))),this.CanShoot=!Enjine.KeyboardInput.IsKeyDown(Enjine.Keys.A),this.MayJump=(this.OnGround||this.Sliding)&&!Enjine.KeyboardInput.IsKeyDown(Enjine.Keys.S),this.XFlip=-1===this.Facing,this.RunTime+=Math.abs(this.Xa)+5,.5>Math.abs(this.Xa)&&(this.RunTime=0,this.Xa=0),this.CalcPic(),this.Sliding&&(this.World.AddSprite(new Mario.Sparkle(this.World,(0|this.X+4*Math.random()-2)+8*this.Facing,(0|this.Y+4*Math.random())-24,2*Math.random()-1,Math.random(),0,1,5)),this.Ya*=.5),this.OnGround=!1,this.SubMove(this.Xa,0),this.SubMove(0,this.Ya),this.Y>16*this.World.Level.Height+16&&this.Die(),0>this.X&&(this.X=0,this.Xa=0),this.X>16*this.World.Level.ExitX&&this.Win(),this.X>16*this.World.Level.Width&&(this.X=16*this.World.Level.Width,this.Xa=0),this.Ya*=.85,this.Xa*=this.OnGround?this.GroundInertia:this.AirInertia,this.OnGround||(this.Ya+=3),null!==this.Carried&&(this.Carried.X*=this.X+8*this.Facing,this.Carried.Y*=this.Y-2,Enjine.KeyboardInput.IsKeyDown(Enjine.Keys.A)||(this.Carried.Release(this),this.Carried=null))},Mario.Character.prototype.CalcPic=function(){var i=0,t=0;if(this.Large?(i=(0|this.RunTime/20)%4,3===i&&(i=1),null===this.Carried&&Math.abs(this.Xa)>10&&(i+=3),null!==this.Carried&&(i+=10),this.OnGround||(i=null!==this.Carried?12:Math.abs(this.Xa)>10?7:6)):(i=(0|this.RunTime/20)%2,null===this.Carried&&Math.abs(this.Xa)>10&&(i+=2),null!==this.Carried&&(i+=8),this.OnGround||(i=null!==this.Carried?9:Math.abs(this.Xa)>10?5:4)),this.OnGround&&(-1===this.Facing&&this.Xa>0||1===this.Facing&&0>this.Xa)&&((this.Xa>1||-1>this.Xa)&&(i=this.Large?9:7),this.Xa>3||-3>this.Xa))for(t=0;3>t;t++)this.World.AddSprite(new Mario.Sparkle(this.World,0|this.X+8*Math.random()-4,0|this.Y+4*Math.random(),2*Math.random()-1,-1*Math.random(),0,1,5));this.Large?(this.Ducking&&(i=14),this.Height=this.Ducking?12:24):this.Height=12,this.XPic=i},Mario.Character.prototype.SubMove=function(i,t){for(var e=!1;i>8;){if(!this.SubMove(8,0))return!1;i-=8}for(;-8>i;){if(!this.SubMove(-8,0))return!1;i+=8}for(;t>8;){if(!this.SubMove(0,8))return!1;t-=8}for(;-8>t;){if(!this.SubMove(0,-8))return!1;t+=8}return t>0&&(this.IsBlocking(this.X+i-this.Width,this.Y+t,i,0)?e=!0:this.IsBlocking(this.X+i+this.Width,this.Y+t,i,0)?e=!0:this.IsBlocking(this.X+i-this.Width,this.Y+t+1,i,t)?e=!0:this.IsBlocking(this.X+i+this.Width,this.Y+t+1,i,t)&&(e=!0)),0>t&&(this.IsBlocking(this.X+i,this.Y+t-this.Height,i,t)?e=!0:e||this.IsBlocking(this.X+i-this.Width,this.Y+t-this.Height,i,t)?e=!0:(e||this.IsBlocking(this.X+i+this.Width,this.Y+t-this.Height,i,t))&&(e=!0)),i>0&&(this.Sliding=!0,this.IsBlocking(this.X+i+this.Width,this.Y+t-this.Height,i,t)?e=!0:this.Sliding=!1,this.IsBlocking(this.X+i+this.Width,this.Y+t-(0|this.Height/2),i,t)?e=!0:this.Sliding=!1,this.IsBlocking(this.X+i+this.Width,this.Y+t,i,t)?e=!0:this.Sliding=!1),0>i&&(this.Sliding=!0,this.IsBlocking(this.X+i-this.Width,this.Y+t-this.Height,i,t)?e=!0:this.Sliding=!1,this.IsBlocking(this.X+i-this.Width,this.Y+t-(0|this.Height/2),i,t)?e=!0:this.Sliding=!1,this.IsBlocking(this.X+i-this.Width,this.Y+t,i,t)?e=!0:this.Sliding=!1),e?(0>i&&(this.X=16*(0|(this.X-this.Width)/16)+this.Width,this.Xa=0),i>0&&(this.X=16*(0|(this.X+this.Width)/16+1)-this.Width-1,this.Xa=0),0>t&&(this.Y=16*(0|(this.Y-this.Height)/16)+this.Height,this.JumpTime=0,this.Ya=0),t>0&&(this.Y=16*(0|(this.Y-1)/16+1)-1,this.OnGround=!0),!1):(this.X+=i,this.Y+=t,!0)},Mario.Character.prototype.IsBlocking=function(i,t,e,s){var h=!1,a=0,r=0,o=0;if(i=0|i/16,t=0|t/16,i===(0|this.X/16)&&t===(0|this.Y/16))return!1;if(a=this.World.Level.GetBlock(i,t),(Mario.Tile.Behaviors[255&a]&Mario.Tile.PickUpable)>0)for(this.GetCoin(),Enjine.Resources.PlaySound("coin"),this.World.Level.SetBlock(i,t,0),r=0;2>r;r++)for(o=0;2>o;o++)this.World.AddSprite(new Mario.Sparkle(this.World,16*i+8*r+(0|8*Math.random()),16*t+8*o+(0|8*Math.random()),0,0,0,2,5));return h=this.World.Level.IsBlocking(i,t,e,s),h&&0>s&&this.World.Bump(i,t,this.Large),h},Mario.Character.prototype.Stomp=function(i){var t=0;this.DeathTime>0||this.World.Paused||(t=i.Y-i.Height/2,this.SubMove(0,t-this.Y),i instanceof Mario.Enemy||i instanceof Mario.BulletBill?(Enjine.Resources.PlaySound("kick"),this.XJumpSpeed=0,this.YJumpSpeed=-1.9,this.JumpTime=8,this.Ya=this.JumpTime*this.YJumpSpeed,this.OnGround=!1,this.Sliding=!1,this.InvulnerableTime=1):i instanceof Mario.Shell&&(Enjine.KeyboardInput.IsKeyDown(Enjine.Keys.A)&&0===i.Facing?(this.Carried=i,i.Carried=!0):(Enjine.Resources.PlaySound("kick"),this.XJumpSpeed=0,this.YJumpSpeed=-1.9,this.JumpTime=8,this.Ya=this.JumpTime*this.YJumpSpeed,this.OnGround=!1,this.Sliding=!1,this.InvulnerableTime=1)))},Mario.Character.prototype.GetHurt=function(){this.DeathTime>0||this.World.Paused||this.InvulnerableTime>0||(this.Large?(this.World.Paused=!0,this.PowerUpTime=-18,Enjine.Resources.PlaySound("powerdown"),this.Fire?this.SetLarge(!0,!1):this.SetLarge(!1,!1),this.InvulnerableTime=32):this.Die())},Mario.Character.prototype.Win=function(){this.XDeathPos=0|this.X,this.YDeathPos=0|this.Y,this.World.Paused=!0,this.WinTime=1,Enjine.Resources.PlaySound("exit")},Mario.Character.prototype.Die=function(){this.XDeathPos=0|this.X,this.YDeathPos=0|this.Y,this.World.Paused=!0,this.DeathTime=1,Enjine.Resources.PlaySound("death"),this.SetLarge(!1,!1)},Mario.Character.prototype.GetFlower=function(){this.DeathTime>0&&this.World.Paused||(this.Fire?(this.GetCoin(),Enjine.Resources.PlaySound("coin")):(this.World.Paused=!0,this.PowerUpTime=18,Enjine.Resources.PlaySound("powerup"),this.SetLarge(!0,!0)))},Mario.Character.prototype.GetMushroom=function(){this.DeathTime>0&&this.World.Paused||(this.Large?(this.GetCoin(),Enjine.Resources.PlaySound("coin")):(this.World.Paused=!0,this.PowerUpTime=18,Enjine.Resources.PlaySound("powerup"),this.SetLarge(!0,!1)))},Mario.Character.prototype.Kick=function(i){this.DeathTime>0&&this.World.Paused||(Enjine.KeyboardInput.IsKeyDown(Enjine.Keys.A)?(this.Carried=i,i.Carried=!0):(Enjine.Resources.PlaySound("kick"),this.InvulnerableTime=1))},Mario.Character.prototype.Get1Up=function(){Enjine.Resources.PlaySound("1up"),this.Lives++,99===this.Lives&&(this.Lives=99)},Mario.Character.prototype.GetCoin=function(){this.Coins++,100===this.Coins&&(this.Coins=0,this.Get1Up())},Mario.LevelRenderer=function(i,t,e){this.Width=t,this.Height=e,this.Level=i,this.TilesY=(0|e/16)+1,this.Delta=0,this.Tick=0,this.Bounce=0,this.AnimTime=0,this.Background=Mario.SpriteCuts.GetLevelSheet()},Mario.LevelRenderer.prototype=new Enjine.Drawable,Mario.LevelRenderer.prototype.Update=function(i){this.AnimTime+=i,this.Tick=0|this.AnimTime,this.Bounce+=30*i,this.Delta=i},Mario.LevelRenderer.prototype.Draw=function(i,t){this.DrawStatic(i,t),this.DrawDynamic(i,t)},Mario.LevelRenderer.prototype.DrawStatic=function(i,t){var e=0,s=0,h=0,a=null,r=0|t.X/16,o=0|(t.X+this.Width)/16;for(e=r;o+1>e;e++)for(s=0;this.TilesY>s;s++)h=255&this.Level.GetBlock(e,s),0===(Mario.Tile.Behaviors[h]&Mario.Tile.Animated)&&(a=this.Background[h%16][0|h/16],i.drawImage(Enjine.Resources.Images.map,a.X,a.Y,a.Width,a.Height,0|(e<<4)-t.X,0|s<<4,a.Width,a.Height))},Mario.LevelRenderer.prototype.DrawDynamic=function(i,t){var e=0,s=0,h=0,a=0,r=0,o=null;for(e=0|t.X/16;0|(t.X+this.Width)/16>=e;e++)for(s=0|t.Y/16;0|(t.Y+this.Height)/16>=s;s++)h=this.Level.GetBlock(e,s),(Mario.Tile.Behaviors[255&h]&Mario.Tile.Animated)>0&&(a=(0|this.Bounce/3)%4,0===(0|h%16/4)&&1===(0|h/16)&&(a=(0|this.Bounce/2+(e+s)/8)%20,a>3&&(a=0)),3===(0|h%16/4)&&0===(0|h/16)&&(a=2),r=0,e>=0&&s>=0&&this.Level.Width>e&&this.Level.Height>s&&(r=this.Level.Data[e][s]),r>0&&(r=0|8*Math.sin((r-this.Delta)/4*Math.PI)),o=this.Background[4*(0|h%16/4)+a][0|h/16],i.drawImage(Enjine.Resources.Images.map,o.X,o.Y,o.Width,o.Height,(e<<4)-t.X,(s<<4)-t.Y-r,o.Width,o.Height))},Mario.LevelRenderer.prototype.DrawExit0=function(i,t,e){var s=0,h=0,a=null;for(s=this.Level.ExitY-8;this.Level.ExitY>s;s++)a=this.Background[12][s===this.Level.ExitY-8?4:5],i.drawImage(Enjine.Resources.Images.map,a.X,a.Y,a.Width,a.Height,(this.Level.ExitX<<4)-t.X-16,(s<<4)-t.Y,a.Width,a.Height);e&&(h=16*this.Level.ExitY-48-16*3*Math.sin(this.AnimTime)-8,a=this.Background[12][3],i.drawImage(Enjine.Resources.Images.map,a.X,a.Y,a.Width,a.Height,(this.Level.ExitX<<4)-t.X-16,h-t.Y,a.Width,a.Height),a=this.Background[13][3],i.drawImage(Enjine.Resources.Images.map,a.X,a.Y,a.Width,a.Height,(this.Level.ExitX<<4)-t.X,h-t.Y,a.Width,a.Height))},Mario.LevelRenderer.prototype.DrawExit1=function(i,t){var e=0,s=null;for(e=this.Level.ExitY-8;this.Level.ExitY>e;e++)s=this.Background[13][e===this.Level.ExitY-8?4:5],i.drawImage(Enjine.Resources.Images.map,s.X,s.Y,s.Width,s.Height,(this.Level.ExitX<<4)-t.X+16,(e<<4)-t.Y,s.Width,s.Height)},Mario.LevelGenerator=function(i,t){this.Width=i,this.Height=t,this.Odds=[],this.TotalOdds=0,this.Difficulty=0,this.Type=0},Mario.LevelGenerator.prototype={CreateLevel:function(i,t){var e=0,s=0,h=0,a=0,r=0,o=0,n=0,l=null;for(this.Type=i,this.Difficulty=t,this.Odds[Mario.Odds.Straight]=20,this.Odds[Mario.Odds.HillStraight]=10,this.Odds[Mario.Odds.Tubes]=2+t,this.Odds[Mario.Odds.Jump]=2*t,this.Odds[Mario.Odds.Cannon]=-10+5*t,this.Type!==Mario.LevelType.Overground&&(this.Odds[Mario.Odds.HillStraight]=0),e=0;this.Odds.length>e;e++)0>this.Odds[e]&&(this.Odds[e]=0),this.TotalOdds+=this.Odds[e],this.Odds[e]=this.TotalOdds-this.Odds[e];for(l=new Mario.Level(this.Width,this.Height),s+=this.BuildStraight(l,0,l.Width,!0);l.Width-64>s;)s+=this.BuildZone(l,s,l.Width-s);for(h=0|this.Height-1-4*Math.random(),l.ExitX=s+8,l.ExitY=h,a=s;l.Width>a;a++)for(r=0;this.Height>r;r++)r>=h&&l.SetBlock(a,r,145);if(i===Mario.LevelType.Castle||i===Mario.LevelType.Underground)for(a=0;l.Width>a;a++)for(0>=n--&&a>4&&(o=0|4*Math.random(),n=(0|4*Math.random())+4),r=0;l.Height>r;r++)(a>4&&o>=r||1>a)&&l.SetBlock(a,r,145);return this.FixWalls(l),l},BuildZone:function(i,t,e){var s=0|Math.random()*this.TotalOdds,h=0,a=0;for(a=0;this.Odds.length>a;a++)s>=this.Odds[a]&&(h=a);switch(h){case Mario.Odds.Straight:return this.BuildStraight(i,t,e,!1);case Mario.Odds.HillStraight:return this.BuildHillStraight(i,t,e);case Mario.Odds.Tubes:return this.BuildTubes(i,t,e);case Mario.Odds.Jump:return this.BuildJump(i,t,e);case Mario.Odds.Cannons:return this.BuildCannons(i,t,e)}return 0},BuildJump:function(i,t){var e=(0|4*Math.random())+2,s=(0|2*Math.random())+2,h=2*e+s,a=0,r=0,o=0===(0|3*Math.random()),n=this.Height-1-(0|4*Math.random());for(a=t;t+h>a;a++)if(t+e>a||a>t+h-e-1)for(r=0;this.Height>r;r++)r>=n?i.SetBlock(a,r,145):o&&(t+e>a?r>=n-(a-t)+1&&i.SetBlock(a,r,9):r>=n-(t+h-a)+2&&i.SetBlock(a,r,9));return h},BuildCannons:function(i,t,e){alert("cannons");var s=(0|10*Math.random())+2,h=0|this.Height-1-4*Math.random(),a=0|t+1+4*Math.random(),r=0,o=0,n=0;for(s>e&&(s=e),r=t;t+s>r;r++)for(r>a&&(a+=0|2*4*Math.random()),a===t+s-1&&(a+=10),n=h-(0|4*Math.random())-1,o=0;this.Height>o;o++)o>=h?i.SetBlock(r,o,145):r===a&&o>=n&&(o===n?i.SetBlock(r,o,14):o===n+1?i.SetBlock(r,o,30):i.SetBlock(r,o,46));return s},BuildHillStraight:function(i,t,e){var s=(0|10*Math.random())+10,h=0|this.Height-1-4*Math.random(),a=0,r=0,o=h,n=!0,l=0,d=0,c=[],u=0,p=0;for(s>e&&(s=e),a=t;t+s>a;a++)for(r=0;this.Height>r;r++)r>=h&&i.SetBlock(a,r,145);for(this.AddEnemyLine(i,t+1,t+s-1,h-1);n;)if(o=0|o-2-3*Math.random(),0>=o)n=!1;else if(l=(0|5*Math.random())+3,d=(0|Math.random()*(s-l-2))+t+1,c[d-t]||c[d-t+l]||c[d-t-1]||c[d-t+l+1])n=!1;else for(c[d-t]=!0,c[d-t+l]=!0,this.AddEnemyLine(i,d,d+l,o-1),0===(0|4*Math.random())&&(this.Decorate(i,d-1,d+l+1,o),n=!1),a=d;d+l>a;a++)for(r=o;h>r;r++)u=5,p=9,a===d&&(u=4),a===d+l-1&&(u=6),r===o&&(p=8),0===i.GetBlock(a,r)?i.SetBlock(a,r,u+16*p):(132===i.GetBlock(a,r)&&i.SetBlock(a,r,180),134===i.GetBlock(a,r)&&i.SetBlock(a,r,182));return s},AddEnemyLine:function(i,t,e,s){var h=0,a=0;for(h=t;e>h;h++)(0|35*Math.random())<this.Difficulty+1&&(a=0|4*Math.random(),1>this.Difficulty?a=Mario.Enemy.Goomba:3>this.Difficulty&&(a=0|3*Math.random()),i.SetSpriteTemplate(h,s,new Mario.SpriteTemplate(a,(0|35*Math.random())<this.Difficulty)))},BuildTubes:function(i,t,e){var s=(0|10*Math.random())+5,h=0|this.Height-1-4*Math.random(),a=0|t+1+4*Math.random(),r=h-(0|2*Math.random())-2,o=0,n=0,l=0;for(s>e&&(s=e),o=t;t+s>o;o++)for(o>a+1&&(a+=3+(0|4*Math.random()),r=h-(0|2*Math.random())-2),a>=t+s-2&&(a+=10),o===a&&(0|11*Math.random())<this.Difficulty+1&&i.SetSpriteTemplate(o,r,new Mario.SpriteTemplate(Mario.Enemy.Flower,!1)),n=0;this.Height>n;n++)n>=h?i.SetBlock(o,n,145):(o===a||o===a+1)&&n>=r&&(l=10+o-a,n===r?i.SetBlock(o,n,l):i.SetBlock(o,n,l+16));return s},BuildStraight:function(i,t,e,s){var h=(0|10*Math.random())+2,a=this.Height-1-(0|4*Math.random()),r=0,o=0;for(s&&(h=10+(0|5*Math.random())),h>e&&(h=e),r=t;t+h>r;r++)for(o=0;this.Height>o;o++)o>=a&&i.SetBlock(r,o,145);return s||h>5&&this.Decorate(i,t,t+h,a),h},Decorate:function(i,t,e,s){if(!(1>s)){var h=!0,a=0|4*Math.random(),r=0|4*Math.random(),o=0;if(this.AddEnemyLine(i,t+1,e-1,s-1),s-2>0&&e-1-r-(t+1+a)>1)for(o=t+1+a;e-1-r>o;o++)i.SetBlock(o,s-2,34);if(a=0|4*Math.random(),r=0|4*Math.random(),s-4>0&&e-1-r-(t+1+a)>2)for(o=t+1+a;e-1-r>o;o++)h&&(o!==t+1&&o!==e-2&&0===(0|3*Math.random())?0===(0|4*Math.random())?i.SetBlock(o,s-4,22):i.SetBlock(o,s-4,21):0===(0|4*Math.random())?0===(0|4*Math.random())?i.SetBlock(o,s-4,18):i.SetBlock(o,s-4,17):i.SetBlock(o,s-4,16))}},FixWalls:function(i){var t=[],e=0,s=0,h=0,a=0,r=0;for(e=0;this.Width+1>e;e++)for(t[e]=[],s=0;this.Height+1>s;s++){for(r=0,h=e-1;e+1>h;h++)for(a=s-1;s+1>a;a++)145===i.GetBlockCapped(h,a)&&r++;t[e][s]=4===r}this.Blockify(i,t,this.Width+1,this.Height+1)},Blockify:function(i,t,e,s){var h=0,a=[],r=0,o=0,n=0,l=0,d=0,c=0,u=0;for(d=0;2>d;d++)a[d]=[];for(this.Type===Mario.LevelType.Castle?h=8:this.Type===Mario.LevelType.Underground&&(h=12),r=0;e>r;r++)for(o=0;s>o;o++){for(n=r;r+1>=n;n++)for(l=o;o+1>=l;l++)c=n,u=l,0>c&&(c=0),0>u&&(u=0),c>e-1&&(c=e-1),u>s-1&&(u=s-1),a[n-r][l-o]=t[c][u];a[0][0]===a[1][0]&&a[0][1]===a[1][1]?a[0][0]===a[0][1]?a[0][0]&&i.SetBlock(r,o,145+h):a[0][0]?i.SetBlock(r,o,161+h):i.SetBlock(r,o,129+h):a[0][0]===a[0][1]&&a[1][0]===a[1][1]?a[0][0]?i.SetBlock(r,o,146+h):i.SetBlock(r,o,144+h):a[0][0]===a[1][1]&&a[0][1]===a[1][0]?i.SetBlock(r,o,145+h):a[0][0]===a[1][0]?a[0][0]?a[0][1]?i.SetBlock(r,o,163+h):i.SetBlock(r,o,179+h):a[0][1]?i.SetBlock(r,o,130+h):i.SetBlock(r,o,128+h):a[0][1]===a[1][1]?a[0][1]?a[0][0]?i.SetBlock(r,o,147+h):i.SetBlock(r,o,131+h):a[0][0]?i.SetBlock(r,o,162+h):i.SetBlock(r,o,160+h):i.SetBlock(r,o,1+16*h)}}},Mario.SpriteTemplate=function(i,t){this.Type=i,this.Winged=t,this.LastVisibleTick=-1,this.IsDead=!1,this.Sprite=null},Mario.SpriteTemplate.prototype={Spawn:function(i,t,e,s){this.IsDead||(this.Sprite=this.Type===Mario.Enemy.Flower?new Mario.FlowerEnemy(i,16*t+15,16*e+24):new Mario.Enemy(i,16*t+8,16*e+15,s,this.Type,this.Winged),this.Sprite.SpriteTemplate=this,i.AddSprite(this.Sprite))}},Mario.Enemy=function(i,t,e,s,h,a){this.GroundInertia=.89,this.AirInertia=.89,this.RunTime=0,this.OnGround=!1,this.MayJump=!1,this.JumpTime=0,this.XJumpSpeed=0,this.YJumpSpeed=0,this.Width=4,this.Height=24,this.DeadTime=0,this.FlyDeath=!1,this.WingTime=0,this.NoFireballDeath=!1,this.X=t,this.Y=e,this.World=i,this.Type=h,this.Winged=a,this.Image=Enjine.Resources.Images.enemies,this.XPicO=8,this.YPicO=31,this.AvoidCliffs=this.Type===Mario.Enemy.RedKoopa,this.NoFireballDeath=this.Type===Mario.Enemy.Spiky,this.YPic=this.Type,this.YPic>1&&(this.Height=12),this.Facing=s,0===this.Facing&&(this.Facing=1),this.PicWidth=16},Mario.Enemy.prototype=new Mario.NotchSprite,Mario.Enemy.prototype.CollideCheck=function(){if(0===this.DeadTime){var i=Mario.MarioCharacter.X-this.X,t=Mario.MarioCharacter.Y-this.Y;i>2*-this.Width-4&&2*this.Width+4>i&&t>-this.Height&&Mario.MarioCharacter.Height>t&&(!(this.Type!==Mario.Enemy.Spiky&&Mario.MarioCharacter.Ya>0&&0>=t)||Mario.MarioCharacter.OnGround&&Mario.MarioCharacter.WasOnGround?Mario.MarioCharacter.GetHurt():(Mario.MarioCharacter.Stomp(this),this.Winged?(this.Winged=!1,this.Ya=0):(this.YPicO=7,this.PicHeight=8,null!==this.SpriteTemplate&&(this.SpriteTemplate.IsDead=!0),this.DeadTime=10,this.Winged=!1,this.Type===Mario.Enemy.RedKoopa?this.World.AddSprite(new Mario.Shell(this.World,this.X,this.Y,0)):this.Type===Mario.Enemy.GreenKoopa&&this.World.AddSprite(new Mario.Shell(this.World,this.X,this.Y,1)))))}},Mario.Enemy.prototype.Move=function(){var i=0,t=1.75,e=0;if(this.WingTime++,this.DeadTime>0){if(this.DeadTime--,0===this.DeadTime){for(this.DeadTime=1,i=0;8>i;i++)this.World.AddSprite(new Mario.Sparkle(this.World,(0|this.X+16*Math.random()-8)+4,(0|this.Y-8*Math.random())+4,2*Math.random()-1,-1*Math.random(),0,1,5));this.World.RemoveSprite(this)}return this.FlyDeath&&(this.X+=this.Xa,this.Y+=this.Ya,this.Ya*=.95,this.Ya+=1),void 0}this.Xa>2&&(this.Facing=1),-2>this.Xa&&(this.Facing=-1),this.Xa=this.Facing*t,this.MayJump=this.OnGround,this.XFlip=-1===this.Facing,this.RunTime+=Math.abs(this.Xa)+5,e=(0|this.RunTime/20)%2,this.OnGround||(e=1),this.SubMove(this.Xa,0)||(this.Facing=-this.Facing),this.OnGround=!1,this.SubMove(0,this.Ya),this.Ya*=this.Winged?.95:.85,this.Xa*=this.OnGround?this.GroundInertia:this.AirInertia,this.OnGround?this.Winged&&(this.Ya=-10):this.Ya+=this.Winged?.6:2,this.Winged&&(e=(0|this.WingTime/4)%2),this.XPic=e},Mario.Enemy.prototype.SubMove=function(i,t){for(var e=!1;i>8;){if(!this.SubMove(8,0))return!1;i-=8}for(;-8>i;){if(!this.SubMove(-8,0))return!1;i+=8}for(;t>8;){if(!this.SubMove(0,8))return!1;t-=8}for(;-8>t;){if(!this.SubMove(0,-8))return!1;t+=8}return t>0&&(this.IsBlocking(this.X+i-this.Width,this.Y+t,i,0)?e=!0:this.IsBlocking(this.X+i+this.Width,this.Y+t,i,0)?e=!0:this.IsBlocking(this.X+i-this.Width,this.Y+t+1,i,t)?e=!0:this.IsBlocking(this.X+i+this.Width,this.Y+t+1,i,t)&&(e=!0)),0>t&&(this.IsBlocking(this.X+i,this.Y+t-this.Height,i,t)?e=!0:e||this.IsBlocking(this.X+i-this.Width,this.Y+t-this.Height,i,t)?e=!0:(e||this.IsBlocking(this.X+i+this.Width,this.Y+t-this.Height,i,t))&&(e=!0)),i>0&&(this.IsBlocking(this.X+i+this.Width,this.Y+t-this.Height,i,t)&&(e=!0),this.IsBlocking(this.X+i+this.Width,this.Y+t-(0|this.Height/2),i,t)&&(e=!0),this.IsBlocking(this.X+i+this.Width,this.Y+t,i,t)&&(e=!0),this.AvoidCliffs&&this.OnGround&&!this.World.Level.IsBlocking(0|(this.X+this.Xa+this.Width)/16,0|this.Y/16+1,this.Xa,1)&&(e=!0)),0>i&&(this.IsBlocking(this.X+i-this.Width,this.Y+t-this.Height,i,t)&&(e=!0),this.IsBlocking(this.X+i-this.Width,this.Y+t-(0|this.Height/2),i,t)&&(e=!0),this.IsBlocking(this.X+i-this.Width,this.Y+t,i,t)&&(e=!0),this.AvoidCliffs&&this.OnGround&&!this.World.Level.IsBlocking(0|(this.X+this.Xa-this.Width)/16,0|this.Y/16+1,this.Xa,1)&&(e=!0)),e?(0>i&&(this.X=16*(0|(this.X-this.Width)/16)+this.Width,this.Xa=0),i>0&&(this.X=16*(0|(this.X+this.Width)/16+1)-this.Width-1,this.Xa=0),0>t&&(this.Y=16*(0|(this.Y-this.Height)/16)+this.Height,this.JumpTime=0,this.Ya=0),t>0&&(this.Y=16*(0|(this.Y-1)/16+1)-1,this.OnGround=!0),!1):(this.X+=i,this.Y+=t,!0)
},Mario.Enemy.prototype.IsBlocking=function(i,t,e,s){return i=0|i/16,t=0|t/16,0|i===this.X/16&&0|t===this.Y/16?!1:this.World.Level.IsBlocking(i,t,e,s)},Mario.Enemy.prototype.ShellCollideCheck=function(i){if(0!==this.DeadTime)return!1;var t=i.X-this.X,e=i.Y-this.Y;return t>-16&&16>t&&e>-this.Height&&i.Height>e?(Enjine.Resources.PlaySound("kick"),this.Xa=2*i.Facing,this.Ya=-5,this.FlyDeath=!0,null!==this.SpriteTemplate&&(this.SpriteTemplate.IsDead=!0),this.DeadTime=100,this.Winged=!1,this.YFlip=!0,!0):!1},Mario.Enemy.prototype.FireballCollideCheck=function(i){if(0!==this.DeadTime)return!1;var t=i.X-this.X,e=i.Y-this.Y;return t>-16&&16>t&&e>-this.Height&&i.Height>e?this.NoFireballDeath?!0:(Enjine.Resources.PlaySound("kick"),this.Xa=2*i.Facing,this.Ya=-5,this.FlyDeath=!0,null!==this.SpriteTemplate&&(this.SpriteTemplate.IsDead=!0),this.DeadTime=100,this.Winged=!1,this.YFlip=!0,!0):void 0},Mario.Enemy.prototype.BumpCheck=function(i,t){0===this.DeadTime&&this.X+this.Width>16*i&&16*i+16>this.X-this.Width&&0|t===(this.Y-1)/16&&(Enjine.Resources.PlaySound("kick"),this.Xa=2*-Mario.MarioCharacter.Facing,this.Ya=-5,this.FlyDeath=!0,null!==this.SpriteTemplate&&(this.SpriteTemplate.IsDead=!0),this.DeadTime=100,this.Winged=!1,this.YFlip=!0)},Mario.Enemy.prototype.SubDraw=Mario.NotchSprite.prototype.Draw,Mario.Enemy.prototype.Draw=function(i,t){var e=0,s=0;this.Winged&&(e=(0|this.XOld+(this.X-this.XOld)*this.Delta)-this.XPicO,s=(0|this.YOld+(this.Y-this.YOld)*this.Delta)-this.YPicO,this.Type!==Mario.Enemy.RedKoopa&&this.Type!==Mario.Enemy.GreenKoopa&&(this.XFlip=!this.XFlip,i.save(),i.scale(this.XFlip?-1:1,this.YFlip?-1:1),i.translate(this.XFlip?-320:0,this.YFlip?-240:0),i.drawImage(this.Image,16*((0|this.WingTime/4)%2),128,16,32,this.XFlip?320-e-24:e-8,this.YFlip?240-s-32:s-8,16,32),i.restore(),this.XFlip=!this.XFlip)),this.SubDraw(i,t),this.Winged&&(e=(0|this.XOld+(this.X-this.XOld)*this.Delta)-this.XPicO,s=(0|this.YOld+(this.Y-this.YOld)*this.Delta)-this.YPicO,this.Type===Mario.Enemy.RedKoopa&&this.Type===Mario.Enemy.GreenKoopa?(i.save(),i.scale(this.XFlip?-1:1,this.YFlip?-1:1),i.translate(this.XFlip?-320:0,this.YFlip?-240:0),i.drawImage(this.Image,16*((0|this.WingTime/4)%2),128,16,32,this.XFlip?320-e-24:e-8,this.YFlip?240-s:s-8,16,32),i.restore()):(i.save(),i.scale(this.XFlip?-1:1,this.YFlip?-1:1),i.translate(this.XFlip?-320:0,this.YFlip?-240:0),i.drawImage(this.Image,16*((0|this.WingTime/4)%2),128,16,32,this.XFlip?320-e-24:e-8,this.YFlip?240-s-32:s-8,16,32),i.restore()))},Mario.Enemy.RedKoopa=0,Mario.Enemy.GreenKoopa=1,Mario.Enemy.Goomba=2,Mario.Enemy.Spiky=3,Mario.Enemy.Flower=4,Mario.Fireball=function(i,t,e,s){this.GroundInertia=.89,this.AirInertia=.89,this.Image=Enjine.Resources.Images.particles,this.World=i,this.X=t,this.Y=e,this.Facing=s,this.XPicO=4,this.YPicO=4,this.YPic=3,this.XPic=4,this.Height=8,this.Width=4,this.PicWidth=this.PicHeight=8,this.Ya=4,this.Dead=!1,this.DeadTime=0,this.Anim=0,this.OnGround=!1},Mario.Fireball.prototype=new Mario.NotchSprite,Mario.Fireball.prototype.Move=function(){var i=0,t=8;if(this.DeadTime>0){for(i=0;8>i;i++)this.World.AddSprite(new Mario.Sparkle(this.World,(0|this.X+8*Math.random()-4)+4,(0|this.Y+8*Math.random()-4)+2,2*Math.random()-1*this.Facing,2*Math.random()-1,0,1,5));return this.World.RemoveSprite(this),void 0}0!=this.Facing&&this.Anim++,this.Xa>2&&(this.Facing=1),-2>this.Xa&&(this.Facing=-1),this.Xa=this.Facing*t,this.World.CheckFireballCollide(this),this.FlipX=-1===this.Facing,this.XPic=this.Anim%4,this.SubMove(this.Xa,0)||this.Die(),this.OnGround=!1,this.SubMove(0,this.Ya),this.OnGround&&(this.Ya=-10),this.Ya*=.95,this.Xa*=this.OnGround?this.GroundInertia:this.AirInertia,this.OnGround||(this.Ya+=1.5)},Mario.Fireball.prototype.SubMove=function(i,t){for(var e=!1;i>8;){if(!this.SubMove(8,0))return!1;i-=8}for(;-8>i;){if(!this.SubMove(-8,0))return!1;i+=8}for(;t>8;){if(!this.SubMove(0,8))return!1;t-=8}for(;-8>t;){if(!this.SubMove(0,-8))return!1;t+=8}return t>0&&(this.IsBlocking(this.X+i-this.Width,this.Y+t,i,0)?e=!0:this.IsBlocking(this.X+i+this.Width,this.Y+t,i,0)?e=!0:this.IsBlocking(this.X+i-this.Width,this.Y+t+1,i,t)?e=!0:this.IsBlocking(this.X+i+this.Width,this.Y+t+1,i,t)&&(e=!0)),0>t&&(this.IsBlocking(this.X+i,this.Y+t-this.Height,i,t)?e=!0:e||this.IsBlocking(this.X+i-this.Width,this.Y+t-this.Height,i,t)?e=!0:(e||this.IsBlocking(this.X+i+this.Width,this.Y+t-this.Height,i,t))&&(e=!0)),i>0&&(this.IsBlocking(this.X+i+this.Width,this.Y+t-this.Height,i,t)&&(e=!0),this.IsBlocking(this.X+i+this.Width,this.Y+t-(0|this.Height/2),i,t)&&(e=!0),this.IsBlocking(this.X+i+this.Width,this.Y+t,i,t)&&(e=!0)),0>i&&(this.IsBlocking(this.X+i-this.Width,this.Y+t-this.Height,i,t)&&(e=!0),this.IsBlocking(this.X+i-this.Width,this.Y+t-(0|this.Height/2),i,t)&&(e=!0),this.IsBlocking(this.X+i-this.Width,this.Y+t,i,t)&&(e=!0)),e?(0>i&&(this.X=16*(0|(this.X-this.Width)/16)+this.Width,this.Xa=0),i>0&&(this.X=16*(0|(this.X+this.Width)/16+1)-this.Width-1,this.Xa=0),0>t&&(this.Y=16*(0|(this.Y-this.Height)/16)+this.Height,this.Ya=0),t>0&&(this.Y=16*(0|(this.Y-1)/16+1)-1,this.OnGround=!0),!1):(this.X+=i,this.Y+=t,!0)},Mario.Fireball.prototype.IsBlocking=function(i,t,e,s){return i=0|i/16,t=0|t/16,0|i===this.X/16&&0|t===this.Y/16?!1:this.World.Level.IsBlocking(i,t,e,s)},Mario.Fireball.prototype.Die=function(){this.Dead=!0,this.Xa=2*-this.Facing,this.Ya=-5,this.DeadTime=100},Mario.Sparkle=function(i,t,e,s,h){this.World=i,this.X=t,this.Y=e,this.Xa=s,this.Ya=h,this.XPic=0|2*Math.random(),this.YPic=0,this.Life=10+(0|5*Math.random()),this.XPicStart=this.XPic,this.XPicO=4,this.YPicO=4,this.PicWidth=8,this.PicHeight=8,this.Image=Enjine.Resources.Images.particles},Mario.Sparkle.prototype=new Mario.NotchSprite,Mario.Sparkle.prototype.Move=function(){this.XPic=this.Life>10?7:0|this.XPicStart+.4*(10-this.Life),0>this.Life--&&this.World.RemoveSprite(this),this.X+=this.Xa,this.Y+=this.Ya},Mario.CoinAnim=function(i,t,e){this.World=i,this.Life=10,this.Image=Enjine.Resources.Images.map,this.PicWidth=this.PicHeight=16,this.X=16*t,this.Y=16*e-16,this.Xa=0,this.Ya=-6,this.XPic=0,this.YPic=2},Mario.CoinAnim.prototype=new Mario.NotchSprite,Mario.CoinAnim.prototype.Move=function(){var i=0,t=0;if(0>this.Life--)for(this.World.RemoveSprite(this),i=0;2>i;i++)for(t=0;2>t;t++)this.World.AddSprite(new Mario.Sparkle(this.World,0|this.X+8*i+8*Math.random(),0|this.Y+8*t+8*Math.random(),0,0,0,2,5));this.XPic=3&this.Life,this.X+=this.Xa,this.Y+=this.Ya,this.Ya+=1},Mario.Mushroom=function(i,t,e){this.RunTime=0,this.GroundInertia=.89,this.AirInertia=.89,this.OnGround=!1,this.Width=4,this.Height=24,this.World=i,this.X=t,this.Y=e,this.Image=Enjine.Resources.Images.items,this.XPicO=8,this.YPicO=15,this.YPic=0,this.Height=12,this.Facing=1,this.PicWidth=this.PicHeight=16,this.Life=0},Mario.Mushroom.prototype=new Mario.NotchSprite,Mario.Mushroom.prototype.CollideCheck=function(){var i=Mario.MarioCharacter.X-this.X,t=Mario.MarioCharacter.Y-this.Y;i>-16&&16>i&&t>-this.Height&&Mario.MarioCharacter.Height>t&&(Mario.MarioCharacter.GetMushroom(),this.World.RemoveSprite(this))},Mario.Mushroom.prototype.Move=function(){if(9>this.Life)return this.Layer=0,this.Y--,this.Life++,void 0;var i=1.75;this.Layer=1,this.Xa>2&&(this.Facing=1),-2>this.Xa&&(this.Facing=-1),this.Xa=this.Facing*i,this.XFlip=-1===this.Facing,this.RunTime+=Math.abs(this.Xa)+5,this.SubMove(this.Xa,0)||(this.Facing=-this.Facing),this.OnGround=!1,this.SubMove(0,this.Ya),this.Ya*=.85,this.Xa*=this.OnGround?this.GroundInertia:this.AirInertia,this.OnGround||(this.Ya+=2)},Mario.Mushroom.prototype.SubMove=function(i,t){for(var e=!1;i>8;){if(!this.SubMove(8,0))return!1;i-=8}for(;-8>i;){if(!this.SubMove(-8,0))return!1;i+=8}for(;t>8;){if(!this.SubMove(0,8))return!1;t-=8}for(;-8>t;){if(!this.SubMove(0,-8))return!1;t+=8}return t>0&&(this.IsBlocking(this.X+i-this.Width,this.Y+t,i,0)?e=!0:this.IsBlocking(this.X+i+this.Width,this.Y+t,i,0)?e=!0:this.IsBlocking(this.X+i-this.Width,this.Y+t+1,i,t)?e=!0:this.IsBlocking(this.X+i+this.Width,this.Y+t+1,i,t)&&(e=!0)),0>t&&(this.IsBlocking(this.X+i,this.Y+t-this.Height,i,t)?e=!0:e||this.IsBlocking(this.X+i-this.Width,this.Y+t-this.Height,i,t)?e=!0:(e||this.IsBlocking(this.X+i+this.Width,this.Y+t-this.Height,i,t))&&(e=!0)),i>0&&(this.IsBlocking(this.X+i+this.Width,this.Y+t-this.Height,i,t)&&(e=!0),this.IsBlocking(this.X+i+this.Width,this.Y+t-(0|this.Height/2),i,t)&&(e=!0),this.IsBlocking(this.X+i+this.Width,this.Y+t,i,t)&&(e=!0)),0>i&&(this.IsBlocking(this.X+i-this.Width,this.Y+t-this.Height,i,t)&&(e=!0),this.IsBlocking(this.X+i-this.Width,this.Y+t-(0|this.Height/2),i,t)&&(e=!0),this.IsBlocking(this.X+i-this.Width,this.Y+t,i,t)&&(e=!0)),e?(0>i&&(this.X=16*(0|(this.X-this.Width)/16)+this.Width,this.Xa=0),i>0&&(this.X=16*(0|(this.X+this.Width)/16+1)-this.Width-1,this.Xa=0),0>t&&(this.Y=16*(0|(this.Y-this.Height)/16)+this.Height,this.JumpTime=0,this.Ya=0),t>0&&(this.Y=16*(0|(this.Y-1)/16+1)-1,this.OnGround=!0),!1):(this.X+=i,this.Y+=t,!0)},Mario.Mushroom.prototype.IsBlocking=function(i,t,e,s){return i=0|i/16,t=0|t/16,0|i===this.X/16&&0|t===this.Y/16?!1:this.World.Level.IsBlocking(i,t,e,s)},Mario.Mushroom.prototype.BumpCheck=function(i,t){this.X+this.Width>16*i&&16*i-16>this.X-this.Width&&0|t===(t-1)/16&&(this.Facing=-Mario.MarioCharacter.Facing,this.Ya=-10)},Mario.Particle=function(i,t,e,s,h){this.World=i,this.X=t,this.Y=e,this.Xa=s,this.Ya=h,this.XPic=0|2*Math.random(),this.YPic=0,this.XPicO=4,this.YPicO=4,this.PicWidth=8,this.PicHeight=8,this.Life=10,this.Image=Enjine.Resources.Images.particles},Mario.Particle.prototype=new Mario.NotchSprite,Mario.Particle.prototype.Move=function(){0>this.Life-this.Delta&&this.World.RemoveSprite(this),this.Life-=this.Delta,this.X+=this.Xa,this.Y+=this.Ya,this.Ya*=.95,this.Ya+=3},Mario.FireFlower=function(i,t,e){this.Width=4,this.Height=24,this.World=i,this.X=t,this.Y=e,this.Image=Enjine.Resources.Images.items,this.XPicO=8,this.YPicO=15,this.XPic=1,this.YPic=0,this.Height=12,this.Facing=1,this.PicWidth=this.PicHeight=16,this.Life=0},Mario.FireFlower.prototype=new Mario.NotchSprite,Mario.FireFlower.prototype.CollideCheck=function(){var i=Mario.MarioCharacter.X-this.X,t=Mario.MarioCharacter.Y-this.Y;i>-16&&16>i&&t>-this.Height&&Mario.MarioCharacter.Height>t&&(Mario.MarioCharacter.GetFlower(),this.World.RemoveSprite(this))},Mario.FireFlower.prototype.Move=function(){return 9>this.Life?(this.Layer=0,this.Y--,this.Life++,void 0):void 0},Mario.BulletBill=function(i,t,e,s){this.Image=Enjine.Resources.Images.enemies,this.World=i,this.X=t,this.Y=e,this.Facing=s,this.XPicO=8,this.YPicO=31,this.Height=12,this.Width=4,this.PicWidth=16,this.YPic=5,this.XPic=0,this.Ya=-5,this.DeadTime=0,this.Dead=!1,this.Anim=0},Mario.BulletBill.prototype=new Mario.NotchSprite,Mario.BulletBill.prototype.CollideCheck=function(){if(!this.Dead){var i=Mario.MarioCharacter.X-this.X,t=Mario.MarioCharacter.Y-this.Y;i>-16&&16>i&&t>-this.Height&&this.World.Mario.Height>t&&(!(Mario.MarioCharacter.Y>0&&0>=t)||Mario.MarioCharacter.OnGround&&Mario.MarioCharacter.WasOnGround?Mario.MarioCharacter.GetHurt():(Mario.MarioCharacter.Stomp(this),this.Dead=!0,this.Xa=0,this.Ya=1,this.DeadTime=100))}},Mario.BulletBill.prototype.Move=function(){var i=0,t=4;if(this.DeadTime>0){if(this.DeadTime--,0===this.DeadTime){for(this.DeadTime=1,i=0;8>i;i++)this.World.AddSprite(new Mario.Sparkle((0|this.X+16*Math.random()-8)+4,(0|this.Y+8*Math.random())+4,2*Math.random()-1,-1*Math.random(),0,1,5));this.World.RemoveSprite(this)}return this.X+=this.Xa,this.Y+=this.Ya,this.Ya*=.95,this.Ya+=1,void 0}this.Xa=this.Facing*t,this.XFlip=-1===this.Facing,this.Move(this.Xa,0)},Mario.BulletBill.prototype.SubMove=function(i){return this.X+=i,!0},Mario.BulletBill.prototype.FireballCollideCheck=function(i){if(0!==this.DeadTime)return!1;var t=i.X-this.X,e=i.Y-this.Y;return t>-16&&16>t&&e>-this.Height&&i.Height>e?!0:!1},Mario.BulletBill.prototype.ShellCollideCheck=function(i){if(0!==this.DeadTime)return!1;var t=i.X-this.X,e=i.Y-this.Y;return t>-16&&16>t&&e>-this.Height&&i.Height>e?(Enjine.Resources.PlaySound("kick"),this.Dead=!0,this.Xa=0,this.Ya=1,this.DeadTime=100,!0):!1},Mario.FlowerEnemy=function(i,t,e){this.Image=Enjine.Resources.Images.enemies,this.World=i,this.X=t,this.Y=e,this.Facing=1,this.Type=Mario.Enemy.Spiky,this.Winged=!1,this.NoFireballDeath=!1,this.XPic=0,this.YPic=6,this.YPicO=24,this.Height=12,this.Width=2,this.YStart=e,this.Ya=-8,this.Y-=1,this.Layer=0,this.JumpTime=0,this.Tick=0;var s=0;for(s=0;4>s;s++)this.Move()},Mario.FlowerEnemy.prototype=new Mario.Enemy,Mario.FlowerEnemy.prototype.Move=function(){var i=0,t=0;if(this.DeadTime>0){if(this.DeadTime--,0===this.DeadTime){for(this.DeadTime=1,i=0;8>i;i++)this.World.AddSprite(new Mario.Sparkle((0|this.X+16*Math.random()-8)+4,(0|this.Y+8*Math.random())+4,2*Math.random()-1,-1*Math.random(),0,1,5));this.World.RemoveSprite(this)}return this.X+=this.Xa,this.Y+=this.Ya,this.Ya*=.95,this.Ya+=1,void 0}this.Tick++,this.Y>=this.YStart?(this.YStart=this.Y,t=0|Math.abs(Mario.MarioCharacter.X-this.X),this.JumpTime++,this.Ya=this.JumpTime>40&&t>24?-8:0):this.JumpTime=0,this.Y+=this.Ya,this.Ya*=.9,this.Ya+=.1,this.XPic=2*(1&(0|this.Tick/2))+(1&(0|this.Tick/6))},Mario.Shell=function(i,t,e,s){this.World=i,this.X=t,this.Y=e,this.YPic=s,this.Image=Enjine.Resources.Images.enemies,this.XPicO=8,this.YPicO=31,this.Width=4,this.Height=12,this.Facing=0,this.PicWidth=16,this.XPic=4,this.Ya=-5,this.Dead=!1,this.DeadTime=0,this.Carried=!1,this.GroundInertia=.89,this.AirInertia=.89,this.OnGround=!1,this.Anim=0},Mario.Shell.prototype=new Mario.NotchSprite,Mario.Shell.prototype.FireballCollideCheck=function(i){if(0!==this.DeadTime)return!1;var t=i.X-this.X,e=i.Y-this.Y;return t>-16&&16>t&&e>-this.Height&&i.Height>e?0!==this.Facing?!0:(Enjine.Resources.PlaySound("kick"),this.Xa=2*i.Facing,this.Ya=-5,null!==this.SpriteTemplate&&(this.SpriteTemplate.IsDead=!0),this.DeadTime=100,this.YFlip=!0,!0):!1},Mario.Shell.prototype.CollideCheck=function(){if(!(this.Carried||this.Dead||this.DeadTime>0)){var i=Mario.MarioCharacter.X-this.X,t=Mario.MarioCharacter.Y-this.Y;i>-16&&16>i&&t>-this.Height&&Mario.MarioCharacter.Height>t&&(!(Mario.MarioCharacter.Ya>0&&0>=t)||Mario.MarioCharacter.OnGround&&Mario.MarioCharacter.WasOnGround?0!==this.Facing?Mario.MarioCharacter.GetHurt():(Mario.MarioCharacter.Kick(this),this.Facing=Mario.MarioCharacter.Facing):(Mario.MarioCharacter.Stomp(this),0!==this.Facing?(this.Xa=0,this.Facing=0):this.Facing=Mario.MarioCharacter.Facing))}},Mario.Shell.prototype.Move=function(){var i=11,t=0;if(this.Carried)return this.World.CheckShellCollide(this),void 0;if(this.DeadTime>0){if(this.DeadTime--,0===this.DeadTime){for(this.DeadTime=1,t=0;8>t;t++)this.World.AddSprite(new Mario.Sparkle((0|this.X+16*Math.random()-8)+4,(0|this.Y+8*Math.random())+4,2*Math.random()-1,-1*Math.random(),0,1,5));this.World.RemoveSprite(this)}return this.X+=this.Xa,this.Y+=this.Ya,this.Ya*=.95,this.Ya+=1,void 0}0!==this.Facing&&this.Anim++,this.Xa>2&&(this.Facing=1),-2>this.Xa&&(this.Facing=-1),this.Xa=this.Facing*i,0!==this.Facing&&this.World.CheckShellCollide(this),this.XFlip=-1===this.Facing,this.XPic=(0|this.Anim/2)%4+3,this.SubMove(this.Xa,0)||(Enjine.Resources.PlaySound("bump"),this.Facing=-this.Facing),this.OnGround=!1,this.SubMove(0,this.Ya),this.Ya*=.85,this.Xa*=this.OnGround?this.GroundInertia:this.AirInertia,this.OnGround||(this.Ya+=2)},Mario.Shell.prototype.SubMove=function(i,t){for(var e=!1;i>8;){if(!this.SubMove(8,0))return!1;i-=8}for(;-8>i;){if(!this.SubMove(-8,0))return!1;i+=8}for(;t>8;){if(!this.SubMove(0,8))return!1;t-=8}for(;-8>t;){if(!this.SubMove(0,-8))return!1;t+=8}return t>0&&(this.IsBlocking(this.X+i-this.Width,this.Y+t,i,0)?e=!0:this.IsBlocking(this.X+i+this.Width,this.Y+t,i,0)?e=!0:this.IsBlocking(this.X+i-this.Width,this.Y+t+1,i,t)?e=!0:this.IsBlocking(this.X+i+this.Width,this.Y+t+1,i,t)&&(e=!0)),0>t&&(this.IsBlocking(this.X+i,this.Y+t-this.Height,i,t)?e=!0:e||this.IsBlocking(this.X+i-this.Width,this.Y+t-this.Height,i,t)?e=!0:(e||this.IsBlocking(this.X+i+this.Width,this.Y+t-this.Height,i,t))&&(e=!0)),i>0&&(this.IsBlocking(this.X+i+this.Width,this.Y+t-this.Height,i,t)&&(e=!0),this.IsBlocking(this.X+i+this.Width,this.Y+t-(0|this.Height/2),i,t)&&(e=!0),this.IsBlocking(this.X+i+this.Width,this.Y+t,i,t)&&(e=!0)),0>i&&(this.IsBlocking(this.X+i-this.Width,this.Y+t-this.Height,i,t)&&(e=!0),this.IsBlocking(this.X+i-this.Width,this.Y+t-(0|this.Height/2),i,t)&&(e=!0),this.IsBlocking(this.X+i-this.Width,this.Y+t,i,t)&&(e=!0)),e?(0>i&&(this.X=16*(0|(this.X-this.Width)/16)+this.Width,this.Xa=0),i>0&&(this.X=16*(0|(this.X+this.Width)/16+1)-this.Width-1,this.Xa=0),0>t&&(this.Y=16*(0|(this.Y-this.Height)/16)+this.Height,this.Ya=0),t>0&&(this.Y=16*(0|(this.Y-1)/16+1)-1,this.OnGround=!0),!1):(this.X+=i,this.Y+=t,!0)},Mario.Shell.prototype.IsBlocking=function(i,t,e,s){if(i=0|i/16,t=0|t/16,i===(0|this.X/16)&&t===(0|this.Y/16))return!1;var h=this.World.Level.IsBlocking(i,t,e,s);return h&&0===s&&0!==e&&this.World.Bump(i,t,!0),h},Mario.Shell.prototype.BumpCheck=function(i,t){this.X+this.Width>16*i&&16*i+16>this.X-this.Width&&t===(0|(this.Y-1)/16)&&(this.Facing=-Mario.MarioCharacter.Facing,this.Ya=-10)},Mario.Shell.prototype.Die=function(){this.Dead=!0,this.Carried=!1,this.Xa=2*-this.Facing,this.Ya=-5,this.DeadTime=100},Mario.Shell.prototype.ShellCollideCheck=function(i){if(0!==this.DeadTime)return!1;var t=i.X-this.X,e=i.Y-this.Y;return t>-16&&16>t&&e>-this.Height&&i.Height>e?(Enjine.Resources.PlaySound("kick"),(Mario.MarioCharacter.Carried===i||Mario.MarioCharacter.Carried===this)&&(Mario.MarioCharacter.Carried=null),this.Die(),i.Die(),!0):!1},Mario.Shell.prototype.Release=function(){this.Carried=!1,this.Facing=Mario.MarioCharacter.Facing,this.X+=8*this.Facing},Mario.TitleState=function(){this.drawManager=null,this.camera=null,this.logoY=null,this.bounce=null,this.font=null},Mario.TitleState.prototype=new Enjine.GameState,Mario.TitleState.prototype.Enter=function(){this.drawManager=new Enjine.DrawableManager,this.camera=new Enjine.Camera;var i=new Mario.BackgroundGenerator(2048,15,!0,Mario.LevelType.Overground),t=new Mario.BackgroundRenderer(i.CreateLevel(),320,240,2);i.SetValues(2048,15,!1,Mario.LevelType.Overground);var e=new Mario.BackgroundRenderer(i.CreateLevel(),320,240,1);this.title=new Enjine.Sprite,this.title.Image=Enjine.Resources.Images.title,this.title.X=0,this.title.Y=120,this.logo=new Enjine.Sprite,this.logo.Image=Enjine.Resources.Images.logo,this.logo.X=0,this.logo.Y=0,this.font=Mario.SpriteCuts.CreateRedFont(),this.font.Strings[0]={String:"Press S to Start",X:96,Y:120},this.logoY=20,this.drawManager.Add(t),this.drawManager.Add(e),this.bounce=0,Mario.GlobalMapState=new Mario.MapState,Mario.MarioCharacter=new Mario.Character,Mario.MarioCharacter.Image=Enjine.Resources.Images.smallMario},Mario.TitleState.prototype.Exit=function(){this.drawManager.Clear(),delete this.drawManager,delete this.camera,delete this.font},Mario.TitleState.prototype.Update=function(i){this.bounce+=2*i,this.logoY=20+10*Math.sin(this.bounce),this.camera.X+=25*i,this.drawManager.Update(i)},Mario.TitleState.prototype.Draw=function(i){this.drawManager.Draw(i,this.camera),i.drawImage(Enjine.Resources.Images.title,0,120),i.drawImage(Enjine.Resources.Images.logo,0,this.logoY),this.font.Draw(i,this.Camera)},Mario.TitleState.prototype.CheckForChange=function(i){Enjine.KeyboardInput.IsKeyDown(Enjine.Keys.S)&&i.ChangeState(Mario.GlobalMapState)},Mario.LoadingState=function(){this.Images=[],this.ImagesLoaded=!1,this.ScreenColor=0,this.ColorDirection=1,this.ImageIndex=0,this.SoundIndex=0},Mario.LoadingState.prototype=new Enjine.GameState,Mario.LoadingState.prototype.Enter=function(){var i=0;for(i=0;15>i;i++)this.Images[i]={};this.Images[0].name="background",this.Images[1].name="endScene",this.Images[2].name="enemies",this.Images[3].name="fireMario",this.Images[4].name="font",this.Images[5].name="gameOverGhost",this.Images[6].name="items",this.Images[7].name="logo",this.Images[8].name="map",this.Images[9].name="mario",this.Images[10].name="particles",this.Images[11].name="racoonMario",this.Images[12].name="smallMario",this.Images[13].name="title",this.Images[14].name="worldMap",this.Images[0].src="images/bgsheet.png",this.Images[1].src="images/endscene.gif",this.Images[2].src="images/enemysheet.png",this.Images[3].src="images/firemariosheet.png",this.Images[4].src="images/font.gif",this.Images[5].src="images/gameovergost.gif",this.Images[6].src="images/itemsheet.png",this.Images[7].src="images/logo.gif",this.Images[8].src="images/mapsheet.png",this.Images[9].src="images/mariosheet.png",this.Images[10].src="images/particlesheet.png",this.Images[11].src="images/racoonmariosheet.png",this.Images[12].src="images/smallmariosheet.png",this.Images[13].src="images/title.gif",this.Images[14].src="images/worldmap.png",Enjine.Resources.AddImages(this.Images);var t=new Audio;t.canPlayType("audio/mp3")?Enjine.Resources.AddSound("1up","sounds/1-up.mp3",1).AddSound("breakblock","sounds/breakblock.mp3").AddSound("bump","sounds/bump.mp3",4).AddSound("cannon","sounds/cannon.mp3").AddSound("coin","sounds/coin.mp3",5).AddSound("death","sounds/death.mp3",1).AddSound("exit","sounds/exit.mp3",1).AddSound("fireball","sounds/fireball.mp3",1).AddSound("jump","sounds/jump.mp3").AddSound("kick","sounds/kick.mp3").AddSound("pipe","sounds/pipe.mp3",1).AddSound("powerdown","sounds/powerdown.mp3",1).AddSound("powerup","sounds/powerup.mp3",1).AddSound("sprout","sounds/sprout.mp3",1).AddSound("stagestart","sounds/stagestart.mp3",1).AddSound("stomp","sounds/stomp.mp3",2):Enjine.Resources.AddSound("1up","sounds/1-up.wav",1).AddSound("breakblock","sounds/breakblock.wav").AddSound("bump","sounds/bump.wav",2).AddSound("cannon","sounds/cannon.wav").AddSound("coin","sounds/coin.wav",5).AddSound("death","sounds/death.wav",1).AddSound("exit","sounds/exit.wav",1).AddSound("fireball","sounds/fireball.wav",1).AddSound("jump","sounds/jump.wav",1).AddSound("kick","sounds/kick.wav",1).AddSound("message","sounds/message.wav",1).AddSound("pipe","sounds/pipe.wav",1).AddSound("powerdown","sounds/powerdown.wav",1).AddSound("powerup","sounds/powerup.wav",1).AddSound("sprout","sounds/sprout.wav",1).AddSound("stagestart","sounds/stagestart.wav",1).AddSound("stomp","sounds/stomp.wav",1),Mario.Tile.LoadBehaviors()},Mario.LoadingState.prototype.Exit=function(){delete this.Images},Mario.LoadingState.prototype.Update=function(i){if(!this.ImagesLoaded){this.ImagesLoaded=!0;var t=0;for(t=0;this.Images.length>t;t++)if(Enjine.Resources.Images[this.Images[t].name].complete!==!0){this.ImagesLoaded=!1;break}}this.ScreenColor+=255*this.ColorDirection*i,this.ScreenColor>255?(this.ScreenColor=255,this.ColorDirection=-1):0>this.ScreenColor&&(this.ScreenColor=0,this.ColorDirection=1)},Mario.LoadingState.prototype.Draw=function(i){if(this.ImagesLoaded)i.fillStyle="rgb(0, 0, 0)",i.fillRect(0,0,640,480);else{var t=parseInt(this.ScreenColor,10);i.fillStyle="rgb("+t+","+t+","+t+")",i.fillRect(0,0,640,480)}},Mario.LoadingState.prototype.CheckForChange=function(i){this.ImagesLoaded&&(Mario.GlobalMapState=new Mario.MapState,i.ChangeState(new Mario.TitleState))},Mario.LoseState=function(){this.drawManager=null,this.camera=null,this.gameOver=null,this.font=null,this.wasKeyDown=!1},Mario.LoseState.prototype=new Enjine.GameState,Mario.LoseState.prototype.Enter=function(){this.drawManager=new Enjine.DrawableManager,this.camera=new Enjine.Camera,this.gameOver=new Enjine.AnimatedSprite,this.gameOver.Image=Enjine.Resources.Images.gameOverGhost,this.gameOver.SetColumnCount(9),this.gameOver.SetRowCount(1),this.gameOver.AddNewSequence("turnLoop",0,0,0,8),this.gameOver.PlaySequence("turnLoop",!0),this.gameOver.FramesPerSecond=1/15,this.gameOver.X=112,this.gameOver.Y=68,this.font=Mario.SpriteCuts.CreateBlackFont(),this.font.Strings[0]={String:"Game over!",X:116,Y:160},this.drawManager.Add(this.font),this.drawManager.Add(this.gameOver)},Mario.LoseState.prototype.Exit=function(){this.drawManager.Clear(),delete this.drawManager,delete this.camera,delete this.gameOver,delete this.font},Mario.LoseState.prototype.Update=function(i){this.drawManager.Update(i),Enjine.KeyboardInput.IsKeyDown(Enjine.Keys.S)&&(this.wasKeyDown=!0)},Mario.LoseState.prototype.Draw=function(i){this.drawManager.Draw(i,this.camera)},Mario.LoseState.prototype.CheckForChange=function(i){this.wasKeyDown&&!Enjine.KeyboardInput.IsKeyDown(Enjine.Keys.S)&&i.ChangeState(new Mario.TitleState)},Mario.WinState=function(){this.waitTime=2,this.drawManager=null,this.camera=null,this.font=null,this.kissing=null,this.wasKeyDown=!1},Mario.WinState.prototype=new Enjine.GameState,Mario.WinState.prototype.Enter=function(){this.drawManager=new Enjine.DrawableManager,this.camera=new Enjine.Camera,this.font=Mario.SpriteCuts.CreateBlackFont(),this.font.Strings[0]={String:"Thank you for saving me, Mario!",X:36,Y:160},this.kissing=new Enjine.AnimatedSprite,this.kissing.Image=Enjine.Resources.Images.endScene,this.kissing.X=112,this.kissing.Y=52,this.kissing.SetColumnCount(2),this.kissing.SetRowCount(1),this.kissing.AddNewSequence("loop",0,0,0,1),this.kissing.PlaySequence("loop",!0),this.kissing.FramesPerSecond=.5,this.waitTime=2,this.drawManager.Add(this.font),this.drawManager.Add(this.kissing)},Mario.WinState.prototype.Exit=function(){this.drawManager.Clear(),delete this.drawManager,delete this.camera},Mario.WinState.prototype.Update=function(i){this.drawManager.Update(i),this.waitTime>0?this.waitTime-=i:Enjine.KeyboardInput.IsKeyDown(Enjine.Keys.S)&&(this.wasKeyDown=!0)},Mario.WinState.prototype.Draw=function(i){this.drawManager.Draw(i,this.camera)},Mario.WinState.prototype.CheckForChange=function(i){0>=this.waitTime&&this.wasKeyDown&&!Enjine.KeyboardInput.IsKeyDown(Enjine.Keys.S)&&i.ChangeState(new Mario.TitleState)},Mario.MapTile={Grass:0,Water:1,Level:2,Road:3,Decoration:4},Mario.MapState=function(){this.camera=new Enjine.Camera,this.Level=[],this.Data=[],this.XMario=0,this.YMario=0,this.XMarioA=0,this.YMarioA=0,this.MoveTime=0,this.LevelId=0,this.Farthest=0,this.XFarthestCap=0,this.YFarthestCap=0,this.MapImage=document.createElement("canvas"),this.MapImage.width=320,this.MapImage.height=240,this.MapContext=this.MapImage.getContext("2d"),this.CanEnterLevel=!1,this.EnterLevel=!1,this.LevelDifficulty=0,this.LevelType=0,this.WorldNumber=-1,this.NextWorld()},Mario.MapState.prototype=new Enjine.GameState,Mario.MapState.prototype.Enter=function(){this.WaterSprite=new Enjine.AnimatedSprite,this.WaterSprite.Image=Enjine.Resources.Images.worldMap,this.WaterSprite.SetColumnCount(16),this.WaterSprite.SetRowCount(16),this.WaterSprite.AddNewSequence("loop",14,0,14,3),this.WaterSprite.FramesPerSecond=1/3,this.WaterSprite.PlaySequence("loop",!0),this.WaterSprite.X=0,this.WaterSprite.Y=0,this.DecoSprite=new Enjine.AnimatedSprite,this.DecoSprite.Image=Enjine.Resources.Images.worldMap,this.DecoSprite.SetColumnCount(16),this.DecoSprite.SetRowCount(16),this.DecoSprite.AddNewSequence("world0",10,0,10,3),this.DecoSprite.AddNewSequence("world1",11,0,11,3),this.DecoSprite.AddNewSequence("world2",12,0,12,3),this.DecoSprite.AddNewSequence("world3",13,0,13,3),this.DecoSprite.FramesPerSecond=1/3,this.DecoSprite.PlaySequence("world0",!0),this.DecoSprite.X=0,this.DecoSprite.Y=0,this.HelpSprite=new Enjine.AnimatedSprite,this.HelpSprite.Image=Enjine.Resources.Images.worldMap,this.HelpSprite.SetColumnCount(16),this.HelpSprite.SetRowCount(16),this.HelpSprite.AddNewSequence("help",7,3,7,5),this.HelpSprite.FramesPerSecond=.5,this.HelpSprite.PlaySequence("help",!0),this.HelpSprite.X=0,this.HelpSprite.Y=0,this.SmallMario=new Enjine.AnimatedSprite,this.SmallMario.Image=Enjine.Resources.Images.worldMap,this.SmallMario.SetColumnCount(16),this.SmallMario.SetRowCount(16),this.SmallMario.AddNewSequence("small",1,0,1,1),this.SmallMario.FramesPerSecond=1/3,this.SmallMario.PlaySequence("small",!0),this.SmallMario.X=0,this.SmallMario.Y=0,this.LargeMario=new Enjine.AnimatedSprite,this.LargeMario.Image=Enjine.Resources.Images.worldMap,this.LargeMario.SetColumnCount(16),this.LargeMario.SetRowCount(8),this.LargeMario.AddNewSequence("large",0,2,0,3),this.LargeMario.AddNewSequence("fire",0,4,0,5),this.LargeMario.FramesPerSecond=1/3,this.LargeMario.PlaySequence("large",!0),this.LargeMario.X=0,this.LargeMario.Y=0,this.FontShadow=Mario.SpriteCuts.CreateBlackFont(),this.Font=Mario.SpriteCuts.CreateWhiteFont(),this.DecoSprite.PlaySequence("world"+this.WorldNumber%4,!0),Mario.MarioCharacter.Fire?this.LargeMario.PlaySequence("fire",!0):this.LargeMario.PlaySequence("large",!0),this.EnterLevel=!1,this.LevelDifficulty=0,this.LevelType=0},Mario.MapState.prototype.Exit=function(){delete this.WaterSprite,delete this.DecoSprite,delete this.HelpSprite,delete this.SmallMario,delete this.LargeMario,delete this.FontShadow,delete this.Font},Mario.MapState.prototype.NextWorld=function(){var i=!1;if(this.WorldNumber++,8!==this.WorldNumber){for(this.MoveTime=0,this.LevelId=0,this.Farthest=0,this.XFarthestCap=0,this.YFarthestCap=0;!i;)i=this.GenerateLevel();this.RenderStatic()}},Mario.MapState.prototype.GenerateLevel=function(){var i=0,t=0,e=0,s=0,h=0,a=0,r=new Mario.ImprovedNoise(0|0x8000000000000000*Math.random()),o=new Mario.ImprovedNoise(0|0x8000000000000000*Math.random()),n=new Mario.ImprovedNoise(0|0x8000000000000000*Math.random()),l=21,d=16;this.Level=[],this.Data=[];var c=512*Math.random(),u=512*Math.random(),p=512*Math.random(),m=512*Math.random();for(i=0;l>i;i++)for(this.Level[i]=[],this.Data[i]=[],t=0;d>t;t++)e=r.PerlinNoise(10*i+c,10*t+u),s=o.PerlinNoise(10*i+p,10*t+m),h=e-s,a=2*h,this.Level[i][t]=a>0?Mario.MapTile.Water:Mario.MapTile.Grass;var M=9999,g=9999,S=0;for(a=0,S=0;100>S&&12>a;S++)i=3*(0|Math.random()*(0|(l-1)/3))+2,t=3*(0|Math.random()*(0|(d-1)/3))+1,this.Level[i][t]===Mario.MapTile.Grass&&(M>i&&(M=i,g=t),this.Level[i][t]=Mario.MapTile.Level,this.Data[i][t]=-1,a++);this.Data[M][g]=-2;for(var f=!0;f;)f=this.FindConnection(l,d);if(this.FindCaps(l,d),0===this.XFarthestCap)return!1;for(this.Data[this.XFarthestCap][this.YFarthestCap]=-2,this.Data[0|this.XMario/16][0|this.YMario/16]=-11,i=0;l>i;i++)for(t=0;d>t;t++)this.Level[i][t]!==Mario.MapTile.Grass||i===this.XFarthestCap&&t===this.YFarthestCap-1||(e=n.PerlinNoise(10*i+c,10*t+u),e>0&&(this.Level[i][t]=Mario.MapTile.Decoration));return!0},Mario.MapState.prototype.FindConnection=function(i,t){var e=0,s=0;for(e=0;i>e;e++)for(s=0;t>s;s++)if(this.Level[e][s]===Mario.MapTile.Level&&-1===this.Data[e][s])return this.Connect(e,s,i,t),!0;return!1},Mario.MapState.prototype.Connect=function(i,t,e,s){var h=1e4,a=0,r=0,o=0,n=0,l=0,d=0,c=0;for(o=0;e>o;o++)for(n=0;s>n;n++)this.Level[o][n]===Mario.MapTile.Level&&-2===this.Data[o][n]&&(l=0|Math.abs(i-o),d=0|Math.abs(t-n),c=l*l+d*d,h>c&&(a=o,r=n,h=c));this.DrawRoad(i,t,a,r),this.Level[i][t]=Mario.MapTile.Level,this.Data[i][t]=-2},Mario.MapState.prototype.DrawRoad=function(i,t,e,s){var h=!1;if(Math.random()>.5&&(h=!0),h){for(;i>e;)this.Data[i][t]=0,this.Level[i--][t]=Mario.MapTile.Road;for(;e>i;)this.Data[i][t]=0,this.Level[i++][t]=Mario.MapTile.Road}for(;t>s;)this.Data[i][t]=0,this.Level[i][t--]=Mario.MapTile.Road;for(;s>t;)this.Data[i][t]=0,this.Level[i][t++]=Mario.MapTile.Road;if(!h){for(;i>e;)this.Data[i][t]=0,this.Level[i--][t]=Mario.MapTile.Road;for(;e>i;)this.Data[i][t]=0,this.Level[i++][t]=Mario.MapTile.Road}},Mario.MapState.prototype.FindCaps=function(i,t){var e=0,s=0,h=-1,a=-1,r=0,o=0,n=0;for(e=0;i>e;e++)for(s=0;t>s;s++)if(this.Level[e][s]===Mario.MapTile.Level){for(r=0,o=e-1;e+1>=o;o++)for(n=s-1;s+1>=n;n++)this.Level[o][n]===Mario.MapTile.Road&&r++;1===r?(-1===h&&(h=e,a=s),this.Data[e][s]=0):this.Data[e][s]=1}this.XMario=16*h,this.YMario=16*a,this.Travel(h,a,-1,0)},Mario.MapState.prototype.Travel=function(i,t,e,s){if(this.Level[i][t]===Mario.MapTile.Road||this.Level[i][t]===Mario.MapTile.Level){if(this.Level[i][t]===Mario.MapTile.Road){if(1===this.Data[i][t])return;this.Data[i][t]=1}this.Level[i][t]===Mario.MapTile.Level&&(this.Data[i][t]>0?this.Data[i][t]=0!==this.LevelId&&0===(0|4*Math.random())?-3:++this.LevelId:s>0&&(this.Data[i][t]=-1,s>this.Farthest&&(this.Farthest=s,this.XFarthestCap=i,this.YFarthestCap=t))),2!==e&&this.Travel(i-1,t,0,s++),3!==e&&this.Travel(i,t-1,1,s++),0!==e&&this.Travel(i+1,t,2,s++),1!==e&&this.Travel(i,t+1,3,s++)
}},Mario.MapState.prototype.RenderStatic=function(){var i=0,t=0,e=0,s=0,h=0,a=0,r=0,o=0,n=0,l=Enjine.Resources.Images.worldMap,d=0;for(i=0;20>i;i++)for(t=0;15>t;t++)if(this.MapContext.drawImage(l,16*(0|this.WorldNumber/4),0,16,16,16*i,16*t,16,16),this.Level[i][t]===Mario.MapTile.Level)d=this.Data[i][t],0===d?this.MapContext.drawImage(l,0,112,16,16,16*i,16*t,16,16):-1===d?this.MapContext.drawImage(l,48,128,16,16,16*i,16*t,16,16):-3===d?this.MapContext.drawImage(l,0,128,16,16,16*i,16*t,16,16):-10===d?this.MapContext.drawImage(l,16,128,16,16,16*i,16*t,16,16):-11===d?this.MapContext.drawImage(l,16,112,16,16,16*i,16*t,16,16):-2===d?(this.MapContext.drawImage(l,32,112,16,16,16*i,16*(t-1),16,16),this.MapContext.drawImage(l,32,128,16,16,16*i,16*t,16,16)):this.MapContext.drawImage(l,16*(d-1),96,16,16,16*i,16*t,16,16);else if(this.Level[i][t]===Mario.MapTile.Road)e=this.IsRoad(i-1,t)?1:0,s=this.IsRoad(i,t-1)?1:0,h=this.IsRoad(i+1,t)?1:0,a=this.IsRoad(i,t+1)?1:0,r=e+2*s+4*h+8*a,this.MapContext.drawImage(l,16*r,32,16,16,16*i,16*t,16,16);else if(this.Level[i][t]===Mario.MapTile.Water)for(o=0;2>o;o++)for(n=0;2>n;n++)e=this.IsWater(2*i+(o-1),2*t+(n-1))?0:1,s=this.IsWater(2*i+o,2*t+(n-1))?0:1,h=this.IsWater(2*i+(o-1),2*t+n)?0:1,a=this.IsWater(2*i+o,2*t+n)?0:1,r=e+2*s+4*h+8*a-1,r>=0&&14>=r&&this.MapContext.drawImage(l,16*r,16*(4+(1&o+n)),16,16,16*i+8*o,16*t+8*n,16,16)},Mario.MapState.prototype.IsRoad=function(i,t){return 0>i&&(i=0),0>t&&(t=0),this.Level[i][t]===Mario.MapTile.Road?!0:this.Level[i][t]===Mario.MapTile.Level?!0:!1},Mario.MapState.prototype.IsWater=function(i,t){var e=0,s=0;for(0>i&&(i=0),0>t&&(t=0),e=0;2>e;e++)for(s=0;2>s;s++)if(this.Level[0|(i+e)/2][0|(t+s)/2]!==Mario.MapTile.Water)return!1;return!0},Mario.MapState.prototype.Update=function(i){var t=0,e=0,s=0,h=0;8!==this.WorldNumber&&(this.XMario+=this.XMarioA,this.YMario+=this.YMarioA,t=0|this.XMario/16,e=0|this.YMario/16,this.Level[t][e]===Mario.MapTile.Road&&(this.Data[t][e]=0),this.MoveTime>0?this.MoveTime--:(this.XMarioA=0,this.YMarioA=0,this.CanEnterLevel&&Enjine.KeyboardInput.IsKeyDown(Enjine.Keys.S)&&this.Level[t][e]===Mario.MapTile.Level&&-11!==this.Data[t][e]&&this.Level[t][e]===Mario.MapTile.Level&&0!==this.Data[t][e]&&this.Data[t][e]>-10&&(s=this.WorldNumber+1,Mario.MarioCharacter.LevelString=s+"-",h=Mario.LevelType.Overground,this.Data[t][e]>1&&0===(0|3*Math.random())&&(h=Mario.LevelType.Underground),0>this.Data[t][e]?(-2===this.Data[t][e]?(Mario.MarioCharacter.LevelString+="X",s+=2):-1===this.Data[t][e]?Mario.MarioCharacter.LevelString+="?":(Mario.MarioCharacter.LevelString+="#",s+=1),h=Mario.LevelType.Castle):Mario.MarioCharacter.LevelString+=this.Data[t][e],this.EnterLevel=!0,this.LevelDifficulty=s,this.LevelType=h),this.CanEnterLevel=!Enjine.KeyboardInput.IsKeyDown(Enjine.Keys.S),Enjine.KeyboardInput.IsKeyDown(Enjine.Keys.Left)&&this.TryWalking(-1,0),Enjine.KeyboardInput.IsKeyDown(Enjine.Keys.Right)&&this.TryWalking(1,0),Enjine.KeyboardInput.IsKeyDown(Enjine.Keys.Up)&&this.TryWalking(0,-1),Enjine.KeyboardInput.IsKeyDown(Enjine.Keys.Down)&&this.TryWalking(0,1)),this.WaterSprite.Update(i),this.DecoSprite.Update(i),this.HelpSprite.Update(i),Mario.MarioCharacter.Large?(this.LargeMario.X=0|this.XMario+this.XMarioA*i,this.LargeMario.Y=this.YMario+(0|this.YMarioA*i)-22,this.LargeMario.Update(i)):(this.SmallMario.X=0|this.XMario+this.XMarioA*i,this.SmallMario.Y=this.YMario+(0|this.YMarioA*i)-6,this.SmallMario.Update(i)))},Mario.MapState.prototype.TryWalking=function(i,t){var e=0|this.XMario/16,s=0|this.YMario/16,h=e+i,a=s+t;if(this.Level[h][a]===Mario.MapTile.Road||this.Level[h][a]===Mario.MapTile.Level){if(this.Level[h][a]===Mario.MapTile.Road&&0!==this.Data[h][a]&&0!==this.Data[e][s]&&this.Data[e][s]>-10)return;this.XMarioA=8*i,this.YMarioA=8*t,this.MoveTime=2*this.CalcDistance(e,s,i,t)+1}},Mario.MapState.prototype.CalcDistance=function(i,t,e,s){for(var h=0;;){if(i+=e,t+=s,this.Level[i][t]!==Mario.MapTile.Road)return h;if(this.Level[i-s][t+e]===Mario.MapTile.Road)return h;if(this.Level[i+s][t-e]===Mario.MapTile.Road)return h;h++}},Mario.MapState.prototype.Draw=function(i){var t=0,e=0;if(8!==this.WorldNumber){for(i.drawImage(this.MapImage,0,0),e=0;15>=e;e++)for(t=20;t>=0;t--)this.Level[t][e]===Mario.MapTile.Water?this.IsWater(2*t-1,2*e-1)&&(this.WaterSprite.X=16*t-8,this.WaterSprite.Y=16*e-8,this.WaterSprite.Draw(i,this.camera)):this.Level[t][e]===Mario.MapTile.Decoration?(this.DecoSprite.X=16*t,this.DecoSprite.Y=16*e,this.DecoSprite.Draw(i,this.camera)):this.Level[t][e]===Mario.MapTile.Level&&-2===this.Data[t][e]&&(this.HelpSprite.X=16*t+16,this.HelpSprite.Y=16*e-16,this.HelpSprite.Draw(i,this.camera));Mario.MarioCharacter.Large?this.LargeMario.Draw(i,this.camera):this.SmallMario.Draw(i,this.camera),this.Font.Strings[0]={String:"MARIO "+Mario.MarioCharacter.Lives,X:4,Y:4},this.FontShadow.Strings[0]={String:"MARIO "+Mario.MarioCharacter.Lives,X:5,Y:5},this.Font.Strings[1]={String:"WORLD "+(this.WorldNumber+1),X:256,Y:4},this.FontShadow.Strings[1]={String:"WORLD "+(this.WorldNumber+1),X:257,Y:5},this.FontShadow.Draw(i,this.camera),this.Font.Draw(i,this.camera)}},Mario.MapState.prototype.LevelWon=function(){var i=this.XMario/16,t=this.YMario/16;return-2===this.Data[i][t]?(this.NextWorld(),void 0):(this.Data[i][t]=-3!==this.Data[i][t]?0:-10,this.RenderStatic(),void 0)},Mario.MapState.prototype.GetX=function(){return 160},Mario.MapState.prototype.GetY=function(){return 120},Mario.MapState.prototype.CheckForChange=function(i){8===this.WorldNumber&&i.ChangeState(new Mario.WinState),this.EnterLevel&&i.ChangeState(new Mario.LevelState(this.LevelDifficulty,this.LevelType))},Mario.LevelState=function(i,t){this.LevelDifficulty=i,this.LevelType=t,this.Level=null,this.Layer=null,this.BgLayer=[],this.Paused=!1,this.Sprites=null,this.SpritesToAdd=null,this.SpritesToRemove=null,this.Camera=null,this.ShellsToCheck=null,this.FireballsToCheck=null,this.FontShadow=null,this.Font=null,this.TimeLeft=0,this.StartTime=0,this.FireballsOnScreen=0,this.Tick=0,this.Delta=0,this.GotoMapState=!1,this.GotoLoseState=!1},Mario.LevelState.prototype=new Enjine.GameState,Mario.LevelState.prototype.Enter=function(){var i=new Mario.LevelGenerator(320,15),t=0,e=0,s=0,h=0,a=null;for(this.Level=i.CreateLevel(this.LevelType,this.LevelDifficulty),this.Paused=!1,this.Layer=new Mario.LevelRenderer(this.Level,320,240),this.Sprites=new Enjine.DrawableManager,this.Camera=new Enjine.Camera,this.Tick=0,this.ShellsToCheck=[],this.FireballsToCheck=[],this.SpritesToAdd=[],this.SpritesToRemove=[],this.FontShadow=Mario.SpriteCuts.CreateBlackFont(),this.Font=Mario.SpriteCuts.CreateWhiteFont(),t=0;2>t;t++)e=4>>t,s=(0|(16*this.Level.Width-320)/e)+320,h=(0|(16*this.Level.Height-240)/e)+240,a=new Mario.BackgroundGenerator(s/32+1,h/32+1,0===t,this.LevelType),this.BgLayer[t]=new Mario.BackgroundRenderer(a.CreateLevel(),320,240,e);Mario.MarioCharacter.Initialize(this),this.Sprites.Add(Mario.MarioCharacter),this.StartTime=1,this.TimeLeft=200,this.GotoMapState=!1,this.GotoLoseState=!1},Mario.LevelState.prototype.Exit=function(){delete this.Level,delete this.Layer,delete this.BgLayer,delete this.Sprites,delete this.Camera,delete this.ShellsToCheck,delete this.FireballsToCheck,delete this.FontShadow,delete this.Font},Mario.LevelState.prototype.CheckShellCollide=function(i){this.ShellsToCheck.push(i)},Mario.LevelState.prototype.CheckFireballCollide=function(i){this.FireballsToCheck.push(i)},Mario.LevelState.prototype.Update=function(i){var t=0,e=0,s=0,h=0,a=null,r=!1,o=0,n=0,l=0,d=0,c=null,u=0;for(this.Delta=i,this.TimeLeft-=i,0===(0|this.TimeLeft)&&Mario.MarioCharacter.Die(),this.StartTime>0&&this.StartTime++,this.Camera.X=Mario.MarioCharacter.X-160,0>this.Camera.X&&(this.Camera.X=0),this.Camera.X>16*this.Level.Width-320&&(this.Camera.X=16*this.Level.Width-320),this.FireballsOnScreen=0,t=0;this.Sprites.Objects.length>t;t++)a=this.Sprites.Objects[t],a!==Mario.MarioCharacter&&(s=a.X-this.Camera.X,h=a.Y-this.Camera.Y,-64>s||s>384||-64>h||h>304?this.Sprites.RemoveAt(t):a instanceof Mario.Fireball&&this.FireballsOnScreen++);if(this.Paused)for(t=0;this.Sprites.Objects.length>t;t++)this.Sprites.Objects[t]===Mario.MarioCharacter?this.Sprites.Objects[t].Update(i):this.Sprites.Objects[t].UpdateNoMove(i);else{for(this.Layer.Update(i),this.Level.Update(),r=!1,o=0,this.Tick++,n=(0|this.Camera.X/16)-1;(0|(this.Camera.X+this.Layer.Width)/16)+1>=n;n++)for(l=(0|this.Camera.Y/16)-1;(0|(this.Camera.Y+this.Layer.Height)/16)+1>=l;l++)if(d=0,16*n+8>Mario.MarioCharacter.X+16&&(d=-1),Mario.MarioCharacter.X-16>16*n+8&&(d=1),c=this.Level.GetSpriteTemplate(n,l),null!==c&&(c.LastVisibleTick!==this.Tick-1&&(null!==c.Sprite&&this.Sprites.Contains(c.Sprite)||c.Spawn(this,n,l,d)),c.LastVisibleTick=this.Tick),0!==d&&(u=this.Level.GetBlock(n,l),(Mario.Tile.Behaviors[255&u]&Mario.Tile.Animated)>0&&3===(0|u%16/4)&&0===(0|u/16)&&0===(this.Tick-2*n)%100)){for(o=n,t=0;8>t;t++)this.AddSprite(new Mario.Sparkle(this,16*n+8,16*l+(0|16*Math.random()),Math.random()*d,0,0,1,5));this.AddSprite(new Mario.BulletBill(this,16*n+8+8*d,16*l+15,d)),r=!0}for(r&&Enjine.Resources.PlaySound("cannon"),t=0;this.Sprites.Objects.length>t;t++)this.Sprites.Objects[t].Update(i);for(t=0;this.Sprites.Objects.length>t;t++)this.Sprites.Objects[t].CollideCheck();for(t=0;this.ShellsToCheck.length>t;t++)for(e=0;this.Sprites.Objects.length>e;e++)this.Sprites.Objects[e]===this.ShellsToCheck[t]||this.ShellsToCheck[t].Dead||this.Sprites.Objects[e].ShellCollideCheck(this.ShellsToCheck[t])&&(Mario.MarioCharacter.Carried!==this.ShellsToCheck[t]||this.ShellsToCheck[t].Dead||(Mario.MarioCharacter.Carried=null,this.ShellsToCheck[t].Die()));for(this.ShellsToCheck.length=0,t=0;this.FireballsToCheck.length>t;t++)for(e=0;this.Sprites.Objects.length>e;e++)this.Sprites.Objects[e]===this.FireballsToCheck[t]||this.FireballsToCheck[t].Dead||this.Sprites.Objects[e].FireballCollideCheck(this.FireballsToCheck[t])&&this.FireballsToCheck[t].Die();this.FireballsToCheck.length=0}this.Sprites.AddRange(this.SpritesToAdd),this.Sprites.RemoveList(this.SpritesToRemove),this.SpritesToAdd.length=0,this.SpritesToRemove.length=0,this.Camera.X=Mario.MarioCharacter.XOld+(Mario.MarioCharacter.X-Mario.MarioCharacter.XOld)*i-160,this.Camera.Y=Mario.MarioCharacter.YOld+(Mario.MarioCharacter.Y-Mario.MarioCharacter.YOld)*i-120},Mario.LevelState.prototype.Draw=function(i){var t=0,e=0,s=0;for(0>this.Camera.X&&(this.Camera.X=0),0>this.Camera.Y&&(this.Camera.Y=0),this.Camera.X>16*this.Level.Width-320&&(this.Camera.X=16*this.Level.Width-320),this.Camera.Y>16*this.Level.Height-240&&(this.Camera.Y=16*this.Level.Height-240),t=0;2>t;t++)this.BgLayer[t].Draw(i,this.Camera);for(i.save(),i.translate(-this.Camera.X,-this.Camera.Y),t=0;this.Sprites.Objects.length>t;t++)0===this.Sprites.Objects[t].Layer&&this.Sprites.Objects[t].Draw(i,this.Camera);for(i.restore(),this.Layer.Draw(i,this.Camera),this.Layer.DrawExit0(i,this.Camera,0===Mario.MarioCharacter.WinTime),i.save(),i.translate(-this.Camera.X,-this.Camera.Y),t=0;this.Sprites.Objects.length>t;t++)1===this.Sprites.Objects[t].Layer&&this.Sprites.Objects[t].Draw(i,this.Camera);i.restore(),this.Layer.DrawExit1(i,this.Camera),this.DrawStringShadow(i,"MARIO "+Mario.MarioCharacter.Lives,0,0),this.DrawStringShadow(i,"00000000",0,1),this.DrawStringShadow(i,"COIN",14,0),this.DrawStringShadow(i," "+Mario.MarioCharacter.Coins,14,1),this.DrawStringShadow(i,"WORLD",24,0),this.DrawStringShadow(i," "+Mario.MarioCharacter.LevelString,24,1),this.DrawStringShadow(i,"TIME",34,0),e=0|this.TimeLeft,0>e&&(e=0),this.DrawStringShadow(i," "+e,34,1),this.StartTime>0&&(s=this.StartTime+this.Delta-2,s=.6*s*s,this.RenderBlackout(i,160,120,0|s)),Mario.MarioCharacter.WinTime>0&&(s=Mario.MarioCharacter.WinTime+this.Delta,s=.2*s*s,s>900&&(Mario.GlobalMapState.LevelWon(),this.GotoMapState=!0),this.RenderBlackout(i,0|Mario.MarioCharacter.XDeathPos-this.Camera.X,0|Mario.MarioCharacter.YDeathPos-this.Camera.Y,0|320-s)),Mario.MarioCharacter.DeathTime>0&&(s=Mario.MarioCharacter.DeathTime+this.Delta,s=.1*s*s,s>900&&(Mario.MarioCharacter.Lives--,this.GotoMapState=!0,0>=Mario.MarioCharacter.Lives&&(this.GotoLoseState=!0)),this.RenderBlackout(i,0|Mario.MarioCharacter.XDeathPos-this.Camera.X,0|Mario.MarioCharacter.YDeathPos-this.Camera.Y,0|320-s))},Mario.LevelState.prototype.DrawStringShadow=function(i,t,e,s){this.Font.Strings[0]={String:t,X:8*e+4,Y:8*s+4},this.FontShadow.Strings[0]={String:t,X:8*e+5,Y:8*s+5},this.FontShadow.Draw(i,this.Camera),this.Font.Draw(i,this.Camera)},Mario.LevelState.prototype.RenderBlackout=function(i,t,e,s){if(!(s>320)){var h=[],a=[],r=0;for(r=0;16>r;r++)h[r]=0|t+Math.cos(r*Math.PI/15)*s,a[r]=0|e+Math.sin(r*Math.PI/15)*s;for(h[16]=0,a[16]=e,h[17]=0,a[17]=240,h[18]=320,a[18]=240,h[19]=320,a[19]=e,i.fillStyle="#000",i.beginPath(),i.moveTo(h[19],a[19]),r=18;r>=0;r--)i.lineTo(h[r],a[r]);for(i.closePath(),i.fill(),r=0;16>r;r++)h[r]=0|t-Math.cos(r*Math.PI/15)*s,a[r]=0|e-Math.sin(r*Math.PI/15)*s;for(a[15]+=5,h[16]=320,a[16]=e,h[17]=320,a[17]=0,h[18]=0,a[18]=0,h[19]=0,a[19]=e,i.fillStyle="#000",i.beginPath(),i.moveTo(h[0],a[0]),r=0;h.length-1>=r;r++)i.lineTo(h[r],a[r]);i.closePath(),i.fill()}},Mario.LevelState.prototype.AddSprite=function(i){this.Sprites.Add(i)},Mario.LevelState.prototype.RemoveSprite=function(i){this.Sprites.Remove(i)},Mario.LevelState.prototype.Bump=function(i,t,e){var s=this.Level.GetBlock(i,t),h=0,a=0;if((Mario.Tile.Behaviors[255&s]&Mario.Tile.Bumpable)>0&&(this.BumpInto(i,t-1),this.Level.SetBlock(i,t,4),this.Level.SetBlockData(i,t,4),(Mario.Tile.Behaviors[255&s]&Mario.Tile.Special)>0?(Enjine.Resources.PlaySound("sprout"),Mario.MarioCharacter.Large?this.AddSprite(new Mario.FireFlower(this,16*i+8,16*t+8)):this.AddSprite(new Mario.Mushroom(this,16*i+8,16*t+8))):(Mario.MarioCharacter.GetCoin(),Enjine.Resources.PlaySound("coin"),this.AddSprite(new Mario.CoinAnim(this,i,t)))),(Mario.Tile.Behaviors[255&s]&Mario.Tile.Breakable)>0&&(this.BumpInto(i,t-1),e))for(Enjine.Resources.PlaySound("breakblock"),this.Level.SetBlock(i,t,0),h=0;2>h;h++)for(a=0;2>a;a++)this.AddSprite(new Mario.Particle(this,16*i+8*h+4,16*t+8*a+4,4*(2*h-1),4*(2*a-1)-8))},Mario.LevelState.prototype.BumpInto=function(i,t){var e=this.Level.GetBlock(i,t),s=0;for((Mario.Tile.Behaviors[255&e]&Mario.Tile.PickUpable)>0&&(Mario.MarioCharacter.GetCoin(),Enjine.Resources.PlaySound("coin"),this.Level.SetBlock(i,t,0),this.AddSprite(new Mario.CoinAnim(i,t+1))),s=0;this.Sprites.Objects.length>s;s++)this.Sprites.Objects[s].BumpCheck(i,t)},Mario.LevelState.prototype.CheckForChange=function(i){this.GotoLoseState?i.ChangeState(new Mario.LoseState):this.GotoMapState&&i.ChangeState(Mario.GlobalMapState)};